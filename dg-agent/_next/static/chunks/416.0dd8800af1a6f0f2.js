(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[416],{5465:function(e,a){var n=/~/,s=/~[01]/g;function escapeReplacer(e){switch(e){case"~1":return"/";case"~0":return"~"}throw Error("Invalid tilde escape: "+e)}function untilde(e){return n.test(e)?e.replace(s,escapeReplacer):e}function setter(e,a,n){for(var s,i,o=1,l=a.length;o<l;){if("constructor"===a[o]||"prototype"===a[o]||"__proto__"===a[o])return e;if(s=untilde(a[o++]),i=l>o,void 0===e[s]&&(Array.isArray(e)&&"-"===s&&(s=e.length),i&&(""!==a[o]&&a[o]<1/0||"-"===a[o]?e[s]=[]:e[s]={})),!i)break;e=e[s]}var u=e[s];return void 0===n?delete e[s]:e[s]=n,u}function compilePointer(e){if("string"==typeof e){if(""===(e=e.split("/"))[0])return e}else if(Array.isArray(e)){for(let a of e)if("string"!=typeof a&&"number"!=typeof a)throw Error("Invalid JSON pointer. Must be of type string or number.");return e}throw Error("Invalid JSON pointer.")}},8756:function(e,a){"use strict";function getHostname(e,a){let n;if((null==a?void 0:a.host)&&!Array.isArray(a.host))n=a.host.toString().split(":",1)[0];else{if(!e.hostname)return;n=e.hostname}return n.toLowerCase()}Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"getHostname",{enumerable:!0,get:function(){return getHostname}})},1553:function(e,a){"use strict";function detectDomainLocale(e,a,n){if(e)for(let o of(n&&(n=n.toLowerCase()),e)){var s,i;let e=null==(s=o.domain)?void 0:s.split(":",1)[0].toLowerCase();if(a===e||n===o.defaultLocale.toLowerCase()||(null==(i=o.locales)?void 0:i.some(e=>e.toLowerCase()===n)))return o}}Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"detectDomainLocale",{enumerable:!0,get:function(){return detectDomainLocale}})},5976:function(e,a){"use strict";function normalizeLocalePath(e,a){let n;let s=e.split("/");return(a||[]).some(a=>!!s[1]&&s[1].toLowerCase()===a.toLowerCase()&&(n=a,s.splice(1,1),e=s.join("/")||"/",!0)),{pathname:e,detectedLocale:n}}Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"normalizeLocalePath",{enumerable:!0,get:function(){return normalizeLocalePath}})},2584:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"addLocale",{enumerable:!0,get:function(){return addLocale}});let s=n(7195),i=n(1014);function addLocale(e,a,n,o){if(!a||a===n)return e;let l=e.toLowerCase();return!o&&((0,i.pathHasPrefix)(l,"/api")||(0,i.pathHasPrefix)(l,"/"+a.toLowerCase()))?e:(0,s.addPathPrefix)(e,"/"+a)}},1083:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"addPathSuffix",{enumerable:!0,get:function(){return addPathSuffix}});let s=n(7174);function addPathSuffix(e,a){if(!e.startsWith("/")||!a)return e;let{pathname:n,query:i,hash:o}=(0,s.parsePath)(e);return""+n+a+i+o}},8307:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"formatNextPathnameInfo",{enumerable:!0,get:function(){return formatNextPathnameInfo}});let s=n(8952),i=n(7195),o=n(1083),l=n(2584);function formatNextPathnameInfo(e){let a=(0,l.addLocale)(e.pathname,e.locale,e.buildId?void 0:e.defaultLocale,e.ignorePrefix);return(e.buildId||!e.trailingSlash)&&(a=(0,s.removeTrailingSlash)(a)),e.buildId&&(a=(0,o.addPathSuffix)((0,i.addPathPrefix)(a,"/_next/data/"+e.buildId),"/"===e.pathname?"index.json":".json")),a=(0,i.addPathPrefix)(a,e.basePath),!e.buildId&&e.trailingSlash?a.endsWith("/")?a:(0,o.addPathSuffix)(a,"/"):(0,s.removeTrailingSlash)(a)}},7831:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"getNextPathnameInfo",{enumerable:!0,get:function(){return getNextPathnameInfo}});let s=n(5976),i=n(293),o=n(1014);function getNextPathnameInfo(e,a){var n,l;let{basePath:u,i18n:c,trailingSlash:p}=null!=(n=a.nextConfig)?n:{},d={pathname:e,trailingSlash:"/"!==e?e.endsWith("/"):p};u&&(0,o.pathHasPrefix)(d.pathname,u)&&(d.pathname=(0,i.removePathPrefix)(d.pathname,u),d.basePath=u);let m=d.pathname;if(d.pathname.startsWith("/_next/data/")&&d.pathname.endsWith(".json")){let e=d.pathname.replace(/^\/_next\/data\//,"").replace(/\.json$/,"").split("/"),n=e[0];d.buildId=n,m="index"!==e[1]?"/"+e.slice(1).join("/"):"/",!0===a.parseData&&(d.pathname=m)}if(c){let e=a.i18nProvider?a.i18nProvider.analyze(d.pathname):(0,s.normalizeLocalePath)(d.pathname,c.locales);d.locale=e.detectedLocale,d.pathname=null!=(l=e.pathname)?l:d.pathname,!e.detectedLocale&&d.buildId&&(e=a.i18nProvider?a.i18nProvider.analyze(m):(0,s.normalizeLocalePath)(m,c.locales)).detectedLocale&&(d.locale=e.detectedLocale)}return d}},293:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"removePathPrefix",{enumerable:!0,get:function(){return removePathPrefix}});let s=n(1014);function removePathPrefix(e,a){if(!(0,s.pathHasPrefix)(e,a))return e;let n=e.slice(a.length);return n.startsWith("/")?n:"/"+n}},8476:function(e){"use strict";var a=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={};function stringifyCookie(e){var a;let n=["path"in e&&e.path&&`Path=${e.path}`,"expires"in e&&(e.expires||0===e.expires)&&`Expires=${("number"==typeof e.expires?new Date(e.expires):e.expires).toUTCString()}`,"maxAge"in e&&"number"==typeof e.maxAge&&`Max-Age=${e.maxAge}`,"domain"in e&&e.domain&&`Domain=${e.domain}`,"secure"in e&&e.secure&&"Secure","httpOnly"in e&&e.httpOnly&&"HttpOnly","sameSite"in e&&e.sameSite&&`SameSite=${e.sameSite}`,"priority"in e&&e.priority&&`Priority=${e.priority}`].filter(Boolean);return`${e.name}=${encodeURIComponent(null!=(a=e.value)?a:"")}; ${n.join("; ")}`}function parseCookie(e){let a=new Map;for(let n of e.split(/; */)){if(!n)continue;let e=n.indexOf("=");if(-1===e){a.set(n,"true");continue}let[s,i]=[n.slice(0,e),n.slice(e+1)];try{a.set(s,decodeURIComponent(null!=i?i:"true"))}catch{}}return a}function parseSetCookie(e){if(!e)return;let[[a,n],...s]=parseCookie(e),{domain:i,expires:o,httponly:l,maxage:u,path:c,samesite:p,secure:d,priority:m}=Object.fromEntries(s.map(([e,a])=>[e.toLowerCase(),a])),f={name:a,value:decodeURIComponent(n),domain:i,...o&&{expires:new Date(o)},...l&&{httpOnly:!0},..."string"==typeof u&&{maxAge:Number(u)},path:c,...p&&{sameSite:parseSameSite(p)},...d&&{secure:!0},...m&&{priority:parsePriority(m)}};return compact(f)}function compact(e){let a={};for(let n in e)e[n]&&(a[n]=e[n]);return a}((e,n)=>{for(var s in n)a(e,s,{get:n[s],enumerable:!0})})(o,{RequestCookies:()=>c,ResponseCookies:()=>p,parseCookie:()=>parseCookie,parseSetCookie:()=>parseSetCookie,stringifyCookie:()=>stringifyCookie}),e.exports=((e,o,l,u)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let l of s(o))i.call(e,l)||void 0===l||a(e,l,{get:()=>o[l],enumerable:!(u=n(o,l))||u.enumerable});return e})(a({},"__esModule",{value:!0}),o);var l=["strict","lax","none"];function parseSameSite(e){return e=e.toLowerCase(),l.includes(e)?e:void 0}var u=["low","medium","high"];function parsePriority(e){return e=e.toLowerCase(),u.includes(e)?e:void 0}function splitCookiesString(e){if(!e)return[];var a,n,s,i,o,l=[],u=0;function skipWhitespace(){for(;u<e.length&&/\s/.test(e.charAt(u));)u+=1;return u<e.length}function notSpecialChar(){return"="!==(n=e.charAt(u))&&";"!==n&&","!==n}for(;u<e.length;){for(a=u,o=!1;skipWhitespace();)if(","===(n=e.charAt(u))){for(s=u,u+=1,skipWhitespace(),i=u;u<e.length&&notSpecialChar();)u+=1;u<e.length&&"="===e.charAt(u)?(o=!0,u=i,l.push(e.substring(a,s)),a=u):u=s+1}else u+=1;(!o||u>=e.length)&&l.push(e.substring(a,e.length))}return l}var c=class{constructor(e){this._parsed=new Map,this._headers=e;let a=e.get("cookie");if(a){let e=parseCookie(a);for(let[a,n]of e)this._parsed.set(a,{name:a,value:n})}}[Symbol.iterator](){return this._parsed[Symbol.iterator]()}get size(){return this._parsed.size}get(...e){let a="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(a)}getAll(...e){var a;let n=Array.from(this._parsed);if(!e.length)return n.map(([e,a])=>a);let s="string"==typeof e[0]?e[0]:null==(a=e[0])?void 0:a.name;return n.filter(([e])=>e===s).map(([e,a])=>a)}has(e){return this._parsed.has(e)}set(...e){let[a,n]=1===e.length?[e[0].name,e[0].value]:e,s=this._parsed;return s.set(a,{name:a,value:n}),this._headers.set("cookie",Array.from(s).map(([e,a])=>stringifyCookie(a)).join("; ")),this}delete(e){let a=this._parsed,n=Array.isArray(e)?e.map(e=>a.delete(e)):a.delete(e);return this._headers.set("cookie",Array.from(a).map(([e,a])=>stringifyCookie(a)).join("; ")),n}clear(){return this.delete(Array.from(this._parsed.keys())),this}[Symbol.for("edge-runtime.inspect.custom")](){return`RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(e=>`${e.name}=${encodeURIComponent(e.value)}`).join("; ")}},p=class{constructor(e){var a,n,s;this._parsed=new Map,this._headers=e;let i=null!=(s=null!=(n=null==(a=e.getSetCookie)?void 0:a.call(e))?n:e.get("set-cookie"))?s:[],o=Array.isArray(i)?i:splitCookiesString(i);for(let e of o){let a=parseSetCookie(e);a&&this._parsed.set(a.name,a)}}get(...e){let a="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(a)}getAll(...e){var a;let n=Array.from(this._parsed.values());if(!e.length)return n;let s="string"==typeof e[0]?e[0]:null==(a=e[0])?void 0:a.name;return n.filter(e=>e.name===s)}has(e){return this._parsed.has(e)}set(...e){let[a,n,s]=1===e.length?[e[0].name,e[0].value,e[0]]:e,i=this._parsed;return i.set(a,normalizeCookie({name:a,value:n,...s})),replace(i,this._headers),this}delete(...e){let[a,n,s]="string"==typeof e[0]?[e[0]]:[e[0].name,e[0].path,e[0].domain];return this.set({name:a,path:n,domain:s,value:"",expires:new Date(0)})}[Symbol.for("edge-runtime.inspect.custom")](){return`ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(stringifyCookie).join("; ")}};function replace(e,a){for(let[,n]of(a.delete("set-cookie"),e)){let e=stringifyCookie(n);a.append("set-cookie",e)}}function normalizeCookie(e={name:"",value:""}){return"number"==typeof e.expires&&(e.expires=new Date(e.expires)),e.maxAge&&(e.expires=new Date(Date.now()+1e3*e.maxAge)),(null===e.path||void 0===e.path)&&(e.path="/"),e}},6938:function(e,a,n){"use strict";Object.defineProperty(a,"Z",{enumerable:!0,get:function(){return s.NextResponse}});let s=n(6783)},2700:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"NextURL",{enumerable:!0,get:function(){return NextURL}});let s=n(1553),i=n(8307),o=n(8756),l=n(7831),u=/(?!^https?:\/\/)(127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}|\[::1\]|localhost)/;function parseURL(e,a){return new URL(String(e).replace(u,"localhost"),a&&String(a).replace(u,"localhost"))}let c=Symbol("NextURLInternal");let NextURL=class NextURL{constructor(e,a,n){let s,i;"object"==typeof a&&"pathname"in a||"string"==typeof a?(s=a,i=n||{}):i=n||a||{},this[c]={url:parseURL(e,s??i.base),options:i,basePath:""},this.analyze()}analyze(){var e,a,n,i,u;let p=(0,l.getNextPathnameInfo)(this[c].url.pathname,{nextConfig:this[c].options.nextConfig,parseData:!0,i18nProvider:this[c].options.i18nProvider}),d=(0,o.getHostname)(this[c].url,this[c].options.headers);this[c].domainLocale=this[c].options.i18nProvider?this[c].options.i18nProvider.detectDomainLocale(d):(0,s.detectDomainLocale)(null==(a=this[c].options.nextConfig)?void 0:null==(e=a.i18n)?void 0:e.domains,d);let m=(null==(n=this[c].domainLocale)?void 0:n.defaultLocale)||(null==(u=this[c].options.nextConfig)?void 0:null==(i=u.i18n)?void 0:i.defaultLocale);this[c].url.pathname=p.pathname,this[c].defaultLocale=m,this[c].basePath=p.basePath??"",this[c].buildId=p.buildId,this[c].locale=p.locale??m,this[c].trailingSlash=p.trailingSlash}formatPathname(){return(0,i.formatNextPathnameInfo)({basePath:this[c].basePath,buildId:this[c].buildId,defaultLocale:this[c].options.forceLocale?void 0:this[c].defaultLocale,locale:this[c].locale,pathname:this[c].url.pathname,trailingSlash:this[c].trailingSlash})}formatSearch(){return this[c].url.search}get buildId(){return this[c].buildId}set buildId(e){this[c].buildId=e}get locale(){return this[c].locale??""}set locale(e){var a,n;if(!this[c].locale||!(null==(n=this[c].options.nextConfig)?void 0:null==(a=n.i18n)?void 0:a.locales.includes(e)))throw TypeError(`The NextURL configuration includes no locale "${e}"`);this[c].locale=e}get defaultLocale(){return this[c].defaultLocale}get domainLocale(){return this[c].domainLocale}get searchParams(){return this[c].url.searchParams}get host(){return this[c].url.host}set host(e){this[c].url.host=e}get hostname(){return this[c].url.hostname}set hostname(e){this[c].url.hostname=e}get port(){return this[c].url.port}set port(e){this[c].url.port=e}get protocol(){return this[c].url.protocol}set protocol(e){this[c].url.protocol=e}get href(){let e=this.formatPathname(),a=this.formatSearch();return`${this.protocol}//${this.host}${e}${a}${this.hash}`}set href(e){this[c].url=parseURL(e),this.analyze()}get origin(){return this[c].url.origin}get pathname(){return this[c].url.pathname}set pathname(e){this[c].url.pathname=e}get hash(){return this[c].url.hash}set hash(e){this[c].url.hash=e}get search(){return this[c].url.search}set search(e){this[c].url.search=e}get password(){return this[c].url.password}set password(e){this[c].url.password=e}get username(){return this[c].url.username}set username(e){this[c].url.username=e}get basePath(){return this[c].basePath}set basePath(e){this[c].basePath=e.startsWith("/")?e:`/${e}`}toString(){return this.href}toJSON(){return this.href}[Symbol.for("edge-runtime.inspect.custom")](){return{href:this.href,origin:this.origin,protocol:this.protocol,username:this.username,password:this.password,host:this.host,hostname:this.hostname,port:this.port,pathname:this.pathname,search:this.search,searchParams:this.searchParams,hash:this.hash}}clone(){return new NextURL(String(this),this[c].options)}}},7799:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),function(e,a){for(var n in a)Object.defineProperty(e,n,{enumerable:!0,get:a[n]})}(a,{RequestCookies:function(){return s.RequestCookies},ResponseCookies:function(){return s.ResponseCookies}});let s=n(8476)},6783:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"NextResponse",{enumerable:!0,get:function(){return NextResponse}});let s=n(2700),i=n(1387),o=n(7799),l=Symbol("internal response"),u=new Set([301,302,303,307,308]);function handleMiddlewareField(e,a){var n;if(null==e?void 0:null==(n=e.request)?void 0:n.headers){if(!(e.request.headers instanceof Headers))throw Error("request.headers must be an instance of Headers");let n=[];for(let[s,i]of e.request.headers)a.set("x-middleware-request-"+s,i),n.push(s);a.set("x-middleware-override-headers",n.join(","))}}let NextResponse=class NextResponse extends Response{constructor(e,a={}){super(e,a),this[l]={cookies:new o.ResponseCookies(this.headers),url:a.url?new s.NextURL(a.url,{headers:(0,i.toNodeOutgoingHttpHeaders)(this.headers),nextConfig:a.nextConfig}):void 0}}[Symbol.for("edge-runtime.inspect.custom")](){return{cookies:this.cookies,url:this.url,body:this.body,bodyUsed:this.bodyUsed,headers:Object.fromEntries(this.headers),ok:this.ok,redirected:this.redirected,status:this.status,statusText:this.statusText,type:this.type}}get cookies(){return this[l].cookies}static json(e,a){let n=Response.json(e,a);return new NextResponse(n.body,n)}static redirect(e,a){let n="number"==typeof a?a:(null==a?void 0:a.status)??307;if(!u.has(n))throw RangeError('Failed to execute "redirect" on "response": Invalid status code');let s="object"==typeof a?a:{},o=new Headers(null==s?void 0:s.headers);return o.set("Location",(0,i.validateURL)(e)),new NextResponse(null,{...s,headers:o,status:n})}static rewrite(e,a){let n=new Headers(null==a?void 0:a.headers);return n.set("x-middleware-rewrite",(0,i.validateURL)(e)),handleMiddlewareField(a,n),new NextResponse(null,{...a,headers:n})}static next(e){let a=new Headers(null==e?void 0:e.headers);return a.set("x-middleware-next","1"),handleMiddlewareField(e,a),new NextResponse(null,{...e,headers:a})}}},1387:function(e,a){"use strict";function fromNodeOutgoingHttpHeaders(e){let a=new Headers;for(let[n,s]of Object.entries(e)){let e=Array.isArray(s)?s:[s];for(let s of e)void 0!==s&&("number"==typeof s&&(s=s.toString()),a.append(n,s))}return a}function splitCookiesString(e){var a,n,s,i,o,l=[],u=0;function skipWhitespace(){for(;u<e.length&&/\s/.test(e.charAt(u));)u+=1;return u<e.length}function notSpecialChar(){return"="!==(n=e.charAt(u))&&";"!==n&&","!==n}for(;u<e.length;){for(a=u,o=!1;skipWhitespace();)if(","===(n=e.charAt(u))){for(s=u,u+=1,skipWhitespace(),i=u;u<e.length&&notSpecialChar();)u+=1;u<e.length&&"="===e.charAt(u)?(o=!0,u=i,l.push(e.substring(a,s)),a=u):u=s+1}else u+=1;(!o||u>=e.length)&&l.push(e.substring(a,e.length))}return l}function toNodeOutgoingHttpHeaders(e){let a={},n=[];if(e)for(let[s,i]of e.entries())"set-cookie"===s.toLowerCase()?(n.push(...splitCookiesString(i)),a[s]=1===n.length?n[0]:n):a[s]=i;return a}function validateURL(e){try{return String(new URL(String(e)))}catch(a){throw Error(`URL is malformed "${String(e)}". Please use only absolute URLs - https://nextjs.org/docs/messages/middleware-relative-urls`,{cause:a})}}Object.defineProperty(a,"__esModule",{value:!0}),function(e,a){for(var n in a)Object.defineProperty(e,n,{enumerable:!0,get:a[n]})}(a,{fromNodeOutgoingHttpHeaders:function(){return fromNodeOutgoingHttpHeaders},splitCookiesString:function(){return splitCookiesString},toNodeOutgoingHttpHeaders:function(){return toNodeOutgoingHttpHeaders},validateURL:function(){return validateURL}})},8315:function(e,a,n){"use strict";/**
 * @license React
 * use-sync-external-store-shim.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var s=n(1798);function h(e,a){return e===a&&(0!==e||1/e==1/a)||e!=e&&a!=a}var i="function"==typeof Object.is?Object.is:h,o=s.useState,l=s.useEffect,u=s.useLayoutEffect,c=s.useDebugValue;function q(e,a){var n=a(),s=o({inst:{value:n,getSnapshot:a}}),i=s[0].inst,p=s[1];return u(function(){i.value=n,i.getSnapshot=a,r(i)&&p({inst:i})},[e,n,a]),l(function(){return r(i)&&p({inst:i}),e(function(){r(i)&&p({inst:i})})},[e]),c(n),n}function r(e){var a=e.getSnapshot;e=e.value;try{var n=a();return!i(e,n)}catch(e){return!0}}function t(e,a){return a()}var p="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?t:q;a.useSyncExternalStore=void 0!==s.useSyncExternalStore?s.useSyncExternalStore:p},5647:function(e,a,n){"use strict";e.exports=n(8315)},1974:function(e,a,n){"use strict";n.d(a,{QH:function(){return s.QH},Ye:function(){return s.Ye}});var s=n(7018)},9073:function(e,a,n){"use strict";n.d(a,{bI:function(){return BaseOutputParser},dS:function(){return OutputParserException},tw:function(){return BaseLLMOutputParser}});var s=n(986);let BaseLLMOutputParser=class BaseLLMOutputParser extends s.eq{parseResultWithPrompt(e,a,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,a){return"string"==typeof e?this._callWithConfig(async(e,a)=>this.parseResult([{text:e}],a?.callbacks),e,{...a,runType:"parser"}):this._callWithConfig(async(e,a)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],a?.callbacks),e,{...a,runType:"parser"})}};let BaseOutputParser=class BaseOutputParser extends BaseLLMOutputParser{parseResult(e,a){return this.parse(e[0].text,a)}async parseWithPrompt(e,a,n){return this.parse(e,n)}_type(){throw Error("_type not implemented")}};let OutputParserException=class OutputParserException extends Error{constructor(e,a,n,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=a,this.observation=n,this.sendToLLM=s,s&&(void 0===n||void 0===a))throw Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}},4559:function(e,a,n){"use strict";n.d(a,{Qh:function(){return JsonOutputParser},gP:function(){return o.g}});var s=n(242),i=n(7578),o=n(2991);let JsonOutputParser=class JsonOutputParser extends s.g{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,a){return a?e?(0,i.q)(e,a):[{op:"replace",path:"",value:a}]:void 0}async parsePartialResult(e){return(0,o.M)(e[0].text)}async parse(e){return(0,o.M)(e,JSON.parse)}getFormatInstructions(){return""}}},242:function(e,a,n){"use strict";n.d(a,{g:function(){return BaseCumulativeTransformOutputParser}});var s=n(9073),i=n(1808),o=n(2334),l=n(8398);function deep_compare_strict_deepCompareStrict(e,a){let n=typeof e;if(n!==typeof a)return!1;if(Array.isArray(e)){if(!Array.isArray(a))return!1;let n=e.length;if(n!==a.length)return!1;for(let s=0;s<n;s++)if(!deep_compare_strict_deepCompareStrict(e[s],a[s]))return!1;return!0}if("object"===n){if(!e||!a)return e===a;let n=Object.keys(e),s=Object.keys(a),i=n.length;if(i!==s.length)return!1;for(let s of n)if(!deep_compare_strict_deepCompareStrict(e[s],a[s]))return!1;return!0}return e===a}new URL("undefined"!=typeof self&&self.location&&"null"!==self.location.origin?self.location.origin+self.location.pathname+location.search:"https://github.com/cfworker");let u=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,c=[0,31,28,31,30,31,30,31,31,30,31,30,31],p=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function bind(e){return e.test.bind(e)}let d={date,time:time.bind(void 0,!1),"date-time":date_time,duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri,"uri-reference":bind(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":bind(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:bind(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;let[a,n,...s]=e.split("@");return!(!a||!n||0!==s.length||a.length>64||n.length>253||"."===a[0]||a.endsWith(".")||a.includes(".."))&&!!/^[a-z0-9.-]+$/i.test(n)&&!!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(a)&&n.split(".").every(e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e))},hostname:bind(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:bind(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:bind(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:regex,uuid:bind(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":bind(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":bind(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":bind(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function isLeapYear(e){return e%4==0&&(e%100!=0||e%400==0)}function date(e){let a=e.match(u);if(!a)return!1;let n=+a[1],s=+a[2],i=+a[3];return s>=1&&s<=12&&i>=1&&i<=(2==s&&isLeapYear(n)?29:c[s])}function time(e,a){let n=a.match(p);if(!n)return!1;let s=+n[1],i=+n[2],o=+n[3],l=!!n[5];return(s<=23&&i<=59&&o<=59||23==s&&59==i&&60==o)&&(!e||l)}({...d,date:bind(/^\d\d\d\d-[0-1]\d-[0-3]\d$/),time:bind(/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i),"date-time":bind(/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i),"uri-reference":bind(/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i)});let m=/t|\s/i;function date_time(e){let a=e.split(m);return 2==a.length&&date(a[0])&&time(!0,a[1])}let f=/\/|:/,g=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function uri(e){return f.test(e)&&g.test(e)}let b=/[^\\]\\Z/;function regex(e){if(b.test(e))return!1;try{return new RegExp(e),!0}catch(e){return!1}}let BaseTransformOutputParser=class BaseTransformOutputParser extends s.bI{async *_transform(e){for await(let a of e)"string"==typeof a?yield this.parseResult([{text:a}]):yield this.parseResult([{message:a,text:this._baseMessageToString(a)}])}async *transform(e,a){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...a,runType:"parser"})}};let BaseCumulativeTransformOutputParser=class BaseCumulativeTransformOutputParser extends BaseTransformOutputParser{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async *_transform(e){let a,n;for await(let s of e){let e;if("string"!=typeof s&&"string"!=typeof s.content)throw Error("Cannot handle non-string output.");if((0,i.a2)(s)){if("string"!=typeof s.content)throw Error("Cannot handle non-string message output.");e=new l.Ls({message:s,text:s.content})}else if((0,i.QW)(s)){if("string"!=typeof s.content)throw Error("Cannot handle non-string message output.");e=new l.Ls({message:(0,o.Oy)(s),text:s.content})}else e=new l.b6({text:s});n=void 0===n?e:n.concat(e);let u=await this.parsePartialResult([n]);null==u||deep_compare_strict_deepCompareStrict(u,a)||(this.diff?yield this._diff(a,u):yield u,a=u)}}}},8398:function(e,a,n){"use strict";n.d(a,{Ls:function(){return ChatGenerationChunk},WH:function(){return s},b6:function(){return GenerationChunk}});let s="__run";let GenerationChunk=class GenerationChunk{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new GenerationChunk({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}};let ChatGenerationChunk=class ChatGenerationChunk extends GenerationChunk{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new ChatGenerationChunk({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}},4256:function(e,a,n){"use strict";n.d(a,{d:function(){return BasePromptTemplate}});var s=n(8477);let BasePromptTemplate=class BasePromptTemplate extends s.eq{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:a}=e;if(a.includes("stop"))throw Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let a=this.partialVariables??{},n={};for(let[e,s]of Object.entries(a))"string"==typeof s?n[e]=s:n[e]=await s();let s={...n,...e};return s}async invoke(e,a){return this._callWithConfig(e=>this.formatPromptValue(e),e,{...a,runType:"prompt"})}serialize(){throw Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:a}=await Promise.resolve().then(n.bind(n,4094));return a.deserialize(e)}case void 0:{let{PromptTemplate:a}=await Promise.resolve().then(n.bind(n,4094));return a.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:a}=await Promise.resolve().then(n.bind(n,1520));return a.deserialize(e)}default:throw Error(`Invalid prompt type in config: ${e._type}`)}}}},4359:function(e,a,n){"use strict";n.d(a,{ax:function(){return MessagesPlaceholder},gc:function(){return AIMessagePromptTemplate},kq:function(){return HumanMessagePromptTemplate},ks:function(){return ChatPromptTemplate},ov:function(){return SystemMessagePromptTemplate}});var s=n(3478),i=n(4697),o=n(8477),l=n(2566),u=n(4256),c=n(4094),p=n(6531),d=n(6184);let BaseMessagePromptTemplate=class BaseMessagePromptTemplate extends o.eq{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,a){return this._callWithConfig(e=>this.formatMessages(e),e,{...a,runType:"prompt"})}};let MessagesPlaceholder=class MessagesPlaceholder extends BaseMessagePromptTemplate{static lc_name(){return"MessagesPlaceholder"}constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}validateInputOrThrow(e,a){if(this.optional&&!e)return!1;if(!e){let e=Error(`Error: Field "${a}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}if(!(Array.isArray(e)?e.every(e=>(0,s.QW)(e)):(0,s.QW)(e))){let n="string"==typeof e?e:JSON.stringify(e,null,2),s=Error(`Error: Field "${a}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: ${n}`);throw s.name="InputFormatError",s}return!0}async formatMessages(e){return this.validateInputOrThrow(e[this.variableName],this.variableName),e[this.variableName]??[]}};let BaseMessageStringPromptTemplate=class BaseMessageStringPromptTemplate extends BaseMessagePromptTemplate{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}};let BaseChatPromptTemplate=class BaseChatPromptTemplate extends u.d{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let a=await this.formatMessages(e);return new i.GU(a)}};let ChatMessagePromptTemplate=class ChatMessagePromptTemplate extends BaseMessageStringPromptTemplate{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,a){"prompt"in e||(e={prompt:e,role:a}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new s.J(await this.prompt.format(e),this.role)}static fromTemplate(e,a,n){return new this(c.PromptTemplate.fromTemplate(e,{templateFormat:n?.templateFormat}),a)}};let _StringImageMessagePromptTemplate=class _StringImageMessagePromptTemplate extends BaseMessagePromptTemplate{static _messageClass(){throw Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,a){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach(a=>{"inputVariables"in a&&(e=e.concat(a.inputVariables))}),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=a??this.additionalOptions}createMessage(e){let a=this.constructor;if(a._messageClass()){let n=a._messageClass();return new n({content:e})}if(a.chatMessageClass){let n=a.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}throw Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw Error("Invalid message class name")}}static fromTemplate(e,a){if("string"==typeof e)return new this(c.PromptTemplate.fromTemplate(e,a));let n=[];for(let a of e)if("string"==typeof a||"object"==typeof a&&"text"in a){let e="";"string"==typeof a?e=a:"string"==typeof a.text&&(e=a.text??""),n.push(c.PromptTemplate.fromTemplate(e))}else if("object"==typeof a&&"image_url"in a){let e,s=a.image_url??"",i=[];if("string"==typeof s){let a=(0,d._O)(s),n=a.flatMap(e=>"variable"===e.type?[e.name]:[]);if((n?.length??0)>0){if(n.length>1)throw Error(`Only one format variable allowed per image template.
Got: ${n}
From: ${s}`);i=[n[0]]}else i=[];s={url:s},e=new p.r({template:s,inputVariables:i})}else if("object"==typeof s){if("url"in s){let e=(0,d._O)(s.url);i=e.flatMap(e=>"variable"===e.type?[e.name]:[])}else i=[];e=new p.r({template:s,inputVariables:i})}else throw Error("Invalid image template");n.push(e)}return new this({prompt:n,additionalOptions:a})}async format(e){if(this.prompt instanceof l.A){let a=await this.prompt.format(e);return this.createMessage(a)}{let a=[];for(let n of this.prompt){let s={};if(!("inputVariables"in n))throw Error(`Prompt ${n} does not have inputVariables defined.`);for(let a of n.inputVariables)s||(s={[a]:e[a]}),s={...s,[a]:e[a]};if(n instanceof l.A){let e=await n.format(s);a.push({type:"text",text:e})}else if(n instanceof p.r){let e=await n.format(s);a.push({type:"image_url",image_url:e})}}return this.createMessage(a)}}async formatMessages(e){return[await this.format(e)]}};let HumanMessagePromptTemplate=class HumanMessagePromptTemplate extends _StringImageMessagePromptTemplate{static _messageClass(){return s.xk}static lc_name(){return"HumanMessagePromptTemplate"}};let AIMessagePromptTemplate=class AIMessagePromptTemplate extends _StringImageMessagePromptTemplate{static _messageClass(){return s.gY}static lc_name(){return"AIMessagePromptTemplate"}};let SystemMessagePromptTemplate=class SystemMessagePromptTemplate extends _StringImageMessagePromptTemplate{static _messageClass(){return s.jN}static lc_name(){return"SystemMessagePromptTemplate"}};function _isBaseMessagePromptTemplate(e){return"function"==typeof e.formatMessages}function _coerceMessagePromptTemplateLike(e,a){let n;if(_isBaseMessagePromptTemplate(e)||(0,s.QW)(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){let a=e[1];if("string"!=typeof a||"{"!==a[0]||"}"!==a[a.length-1])throw Error(`Invalid placeholder template: "${e[1]}". Expected a variable name surrounded by curly braces.`);let n=a.slice(1,-1);return new MessagesPlaceholder({variableName:n,optional:!0})}let i=(0,s.E1)(e);if(n="string"==typeof i.content?i.content:i.content.map(e=>"text"in e?{text:e.text}:"image_url"in e?{image_url:e.image_url}:e),"human"===i._getType())return HumanMessagePromptTemplate.fromTemplate(n,a);if("ai"===i._getType())return AIMessagePromptTemplate.fromTemplate(n,a);if("system"===i._getType())return SystemMessagePromptTemplate.fromTemplate(n,a);if(s.J.isInstance(i))return ChatMessagePromptTemplate.fromTemplate(i.content,i.role,a);throw Error(`Could not coerce message prompt template from input. Received message type: "${i._getType()}".`)}function isMessagesPlaceholder(e){return"MessagesPlaceholder"===e.constructor.lc_name()}let ChatPromptTemplate=class ChatPromptTemplate extends BaseChatPromptTemplate{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let e=new Set;for(let a of this.promptMessages)if(!(a instanceof s.ku))for(let n of a.inputVariables)e.add(n);let a=this.inputVariables,n=new Set(this.partialVariables?a.concat(Object.keys(this.partialVariables)):a),i=new Set([...n].filter(a=>!e.has(a)));if(i.size>0)throw Error(`Input variables \`${[...i]}\` are not used in any of the prompt messages.`);let o=new Set([...e].filter(e=>!n.has(e)));if(o.size>0)throw Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,a){if("string"==typeof e.content)return e;let n=await Promise.all(e.content.map(async e=>{if("image_url"!==e.type)return e;let n="";n="string"==typeof e.image_url?e.image_url:e.image_url.url;let s=c.PromptTemplate.fromTemplate(n),i=await s.format(a);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=i:e.image_url=i,e}));return e.content=n,e}async formatMessages(e){let a=await this.mergePartialAndUserVariables(e),n=[];for(let e of this.promptMessages)if(e instanceof s.ku)n.push(await this._parseImagePrompts(e,a));else{let s=e.inputVariables.reduce((n,s)=>{if(!(s in a)&&!(isMessagesPlaceholder(e)&&e.optional))throw Error(`Missing value for input variable \`${s.toString()}\``);return n[s]=a[s],n},{}),i=await e.formatMessages(s);n=n.concat(i)}return n}async partial(e){let a=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:a,partialVariables:n};return new ChatPromptTemplate(s)}static fromTemplate(e,a){let n=c.PromptTemplate.fromTemplate(e,a),s=new HumanMessagePromptTemplate({prompt:n});return this.fromMessages([s])}static fromMessages(e,a){let n=e.reduce((e,n)=>e.concat(n instanceof ChatPromptTemplate?n.promptMessages:[_coerceMessagePromptTemplateLike(n,a)]),[]),i=e.reduce((e,a)=>a instanceof ChatPromptTemplate?Object.assign(e,a.partialVariables):e,Object.create(null)),o=new Set;for(let e of n)if(!(e instanceof s.ku))for(let a of e.inputVariables)a in i||o.add(a);return new this({...a,inputVariables:[...o],promptMessages:n,partialVariables:i,templateFormat:a?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}},1520:function(e,a,n){"use strict";n.d(a,{FewShotPromptTemplate:function(){return FewShotPromptTemplate}});var s=n(2566),i=n(6184),o=n(4094);n(4359);let FewShotPromptTemplate=class FewShotPromptTemplate extends s.A{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,i.af)(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let a=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:a,partialVariables:n};return new FewShotPromptTemplate(s)}async format(e){let a=await this.mergePartialAndUserVariables(e),n=await this.getExamples(a),s=await Promise.all(n.map(e=>this.examplePrompt.format(e))),o=[this.prefix,...s,this.suffix].join(this.exampleSeparator);return(0,i.SM)(o,this.templateFormat,a)}serialize(){if(this.exampleSelector||!this.examples)throw Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let a;let{example_prompt:n}=e;if(!n)throw Error("Missing example prompt");let s=await o.PromptTemplate.deserialize(n);if(Array.isArray(e.examples))a=e.examples;else throw Error("Invalid examples format. Only list or string are supported.");return new FewShotPromptTemplate({inputVariables:e.input_variables,examplePrompt:s,examples:a,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}},6531:function(e,a,n){"use strict";n.d(a,{r:function(){return ImagePromptTemplate}});var s=n(4697),i=n(4256),o=n(6184);let ImagePromptTemplate=class ImagePromptTemplate extends i.d{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,o.af)([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){let a=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:a,partialVariables:n};return new ImagePromptTemplate(s)}async format(e){let a={};for(let[n,s]of Object.entries(this.template))"string"==typeof s?a[n]=s.replace(/{([^{}]*)}/g,(a,n)=>{let s=e[n];return"string"==typeof s||"number"==typeof s?String(s):a}):a[n]=s;let n=e.url||a.url,s=e.detail||a.detail;if(!n)throw Error("Must provide either an image URL.");if("string"!=typeof n)throw Error("url must be a string.");let i={url:n};return s&&(i.detail=s),i}async formatPromptValue(e){let a=await this.format(e);return new s.Nn(a)}}},4094:function(e,a,n){"use strict";n.d(a,{PromptTemplate:function(){return PromptTemplate}});var s=n(2566),i=n(6184);let PromptTemplate=class PromptTemplate extends s.A{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,i.af)(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){let a=await this.mergePartialAndUserVariables(e);return(0,i.SM)(this.template,this.templateFormat,a)}static fromExamples(e,a,n,s="\n\n",i=""){let o=[i,...e,a].join(s);return new PromptTemplate({inputVariables:n,template:o})}static fromTemplate(e,a){let{templateFormat:n="f-string",...s}=a??{},o=new Set;return(0,i.$M)(e,n).forEach(e=>{"variable"===e.type&&o.add(e.name)}),new PromptTemplate({inputVariables:[...o],templateFormat:n,template:e,...s})}async partial(e){let a=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:a,partialVariables:n};return new PromptTemplate(s)}serialize(){if(void 0!==this.outputParser)throw Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw Error("Prompt template must have a template");let a=new PromptTemplate({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format});return a}}},2566:function(e,a,n){"use strict";n.d(a,{A:function(){return BaseStringPromptTemplate}});var s=n(4697),i=n(4256);let BaseStringPromptTemplate=class BaseStringPromptTemplate extends i.d{async formatPromptValue(e){let a=await this.format(e);return new s.nw(a)}}},6184:function(e,a,n){"use strict";n.d(a,{af:function(){return checkValidTemplate},_O:function(){return parseFString},$M:function(){return template_parseTemplate},SM:function(){return renderTemplate}});/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var s=Object.prototype.toString,i=Array.isArray||function(e){return"[object Array]"===s.call(e)};function isFunction(e){return"function"==typeof e}function typeStr(e){return i(e)?"array":typeof e}function escapeRegExp(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function hasProperty(e,a){return null!=e&&"object"==typeof e&&a in e}function primitiveHasOwnProperty(e,a){return null!=e&&"object"!=typeof e&&e.hasOwnProperty&&e.hasOwnProperty(a)}var o=RegExp.prototype.test;function testRegExp(e,a){return o.call(e,a)}var l=/\S/;function isWhitespace(e){return!testRegExp(l,e)}var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function escapeHtml(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return u[e]})}var c=/\s*/,p=/\s+/,d=/\s*=/,m=/\s*\}/,f=/#|\^|\/|>|\{|&|=|!/;function parseTemplate(e,a){if(!e)return[];var n,s,o,l,u,b,y,_,w,v=!1,P=[],A=[],S=[],C=!1,O=!1,E="",x=0;function stripSpace(){if(C&&!O)for(;S.length;)delete A[S.pop()];else S=[];C=!1,O=!1}function compileTags(e){if("string"==typeof e&&(e=e.split(p,2)),!i(e)||2!==e.length)throw Error("Invalid tags: "+e);n=RegExp(escapeRegExp(e[0])+"\\s*"),s=RegExp("\\s*"+escapeRegExp(e[1])),o=RegExp("\\s*"+escapeRegExp("}"+e[1]))}compileTags(a||g.tags);for(var I=new Scanner(e);!I.eos();){if(l=I.pos,b=I.scanUntil(n))for(var R=0,T=b.length;R<T;++R)isWhitespace(y=b.charAt(R))?(S.push(A.length),E+=y):(O=!0,v=!0,E+=" "),A.push(["text",y,l,l+1]),l+=1,"\n"===y&&(stripSpace(),E="",x=0,v=!1);if(!I.scan(n))break;if(C=!0,u=I.scan(f)||"name",I.scan(c),"="===u?(b=I.scanUntil(d),I.scan(d),I.scanUntil(s)):"{"===u?(b=I.scanUntil(o),I.scan(m),I.scanUntil(s),u="&"):b=I.scanUntil(s),!I.scan(s))throw Error("Unclosed tag at "+I.pos);if(_=">"==u?[u,b,l,I.pos,E,x,v]:[u,b,l,I.pos],x++,A.push(_),"#"===u||"^"===u)P.push(_);else if("/"===u){if(!(w=P.pop()))throw Error('Unopened section "'+b+'" at '+l);if(w[1]!==b)throw Error('Unclosed section "'+w[1]+'" at '+l)}else"name"===u||"{"===u||"&"===u?O=!0:"="===u&&compileTags(b)}if(stripSpace(),w=P.pop())throw Error('Unclosed section "'+w[1]+'" at '+I.pos);return nestTokens(squashTokens(A))}function squashTokens(e){for(var a,n,s=[],i=0,o=e.length;i<o;++i)(a=e[i])&&("text"===a[0]&&n&&"text"===n[0]?(n[1]+=a[1],n[3]=a[3]):(s.push(a),n=a));return s}function nestTokens(e){for(var a,n=[],s=n,i=[],o=0,l=e.length;o<l;++o)switch((a=e[o])[0]){case"#":case"^":s.push(a),i.push(a),s=a[4]=[];break;case"/":i.pop()[5]=a[2],s=i.length>0?i[i.length-1][4]:n;break;default:s.push(a)}return n}function Scanner(e){this.string=e,this.tail=e,this.pos=0}function Context(e,a){this.view=e,this.cache={".":this.view},this.parent=a}function Writer(){this.templateCache={_cache:{},set:function(e,a){this._cache[e]=a},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}Scanner.prototype.eos=function(){return""===this.tail},Scanner.prototype.scan=function(e){var a=this.tail.match(e);if(!a||0!==a.index)return"";var n=a[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},Scanner.prototype.scanUntil=function(e){var a,n=this.tail.search(e);switch(n){case -1:a=this.tail,this.tail="";break;case 0:a="";break;default:a=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=a.length,a},Context.prototype.push=function(e){return new Context(e,this)},Context.prototype.lookup=function(e){var a=this.cache;if(a.hasOwnProperty(e))n=a[e];else{for(var n,s,i,o,l=this,u=!1;l;){if(e.indexOf(".")>0)for(s=l.view,i=e.split("."),o=0;null!=s&&o<i.length;)o===i.length-1&&(u=hasProperty(s,i[o])||primitiveHasOwnProperty(s,i[o])),s=s[i[o++]];else s=l.view[e],u=hasProperty(l.view,e);if(u){n=s;break}l=l.parent}a[e]=n}return isFunction(n)&&(n=n.call(this.view)),n},Writer.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},Writer.prototype.parse=function(e,a){var n=this.templateCache,s=e+":"+(a||g.tags).join(":"),i=void 0!==n,o=i?n.get(s):void 0;return void 0==o&&(o=parseTemplate(e,a),i&&n.set(s,o)),o},Writer.prototype.render=function(e,a,n,s){var i=this.getConfigTags(s),o=this.parse(e,i),l=a instanceof Context?a:new Context(a,void 0);return this.renderTokens(o,l,n,e,s)},Writer.prototype.renderTokens=function(e,a,n,s,i){for(var o,l,u,c="",p=0,d=e.length;p<d;++p)u=void 0,"#"===(l=(o=e[p])[0])?u=this.renderSection(o,a,n,s,i):"^"===l?u=this.renderInverted(o,a,n,s,i):">"===l?u=this.renderPartial(o,a,n,i):"&"===l?u=this.unescapedValue(o,a):"name"===l?u=this.escapedValue(o,a,i):"text"===l&&(u=this.rawValue(o)),void 0!==u&&(c+=u);return c},Writer.prototype.renderSection=function(e,a,n,s,o){var l=this,u="",c=a.lookup(e[1]);function subRender(e){return l.render(e,a,n,o)}if(c){if(i(c))for(var p=0,d=c.length;p<d;++p)u+=this.renderTokens(e[4],a.push(c[p]),n,s,o);else if("object"==typeof c||"string"==typeof c||"number"==typeof c)u+=this.renderTokens(e[4],a.push(c),n,s,o);else if(isFunction(c)){if("string"!=typeof s)throw Error("Cannot use higher-order sections without the original template");null!=(c=c.call(a.view,s.slice(e[3],e[5]),subRender))&&(u+=c)}else u+=this.renderTokens(e[4],a,n,s,o);return u}},Writer.prototype.renderInverted=function(e,a,n,s,o){var l=a.lookup(e[1]);if(!l||i(l)&&0===l.length)return this.renderTokens(e[4],a,n,s,o)},Writer.prototype.indentPartial=function(e,a,n){for(var s=a.replace(/[^ \t]/g,""),i=e.split("\n"),o=0;o<i.length;o++)i[o].length&&(o>0||!n)&&(i[o]=s+i[o]);return i.join("\n")},Writer.prototype.renderPartial=function(e,a,n,s){if(n){var i=this.getConfigTags(s),o=isFunction(n)?n(e[1]):n[e[1]];if(null!=o){var l=e[6],u=e[5],c=e[4],p=o;0==u&&c&&(p=this.indentPartial(o,c,l));var d=this.parse(p,i);return this.renderTokens(d,a,n,p,s)}}},Writer.prototype.unescapedValue=function(e,a){var n=a.lookup(e[1]);if(null!=n)return n},Writer.prototype.escapedValue=function(e,a,n){var s=this.getConfigEscape(n)||g.escape,i=a.lookup(e[1]);if(null!=i)return"number"==typeof i&&s===g.escape?String(i):s(i)},Writer.prototype.rawValue=function(e){return e[1]},Writer.prototype.getConfigTags=function(e){return i(e)?e:e&&"object"==typeof e?e.tags:void 0},Writer.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!i(e)?e.escape:void 0};var g={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(cache){b.templateCache=cache},get templateCache(){return b.templateCache}},b=new Writer;g.clearCache=function(){return b.clearCache()},g.parse=function(e,a){return b.parse(e,a)},g.render=function(e,a,n,s){if("string"!=typeof e)throw TypeError('Invalid template! Template should be a "string" but "'+typeStr(e)+'" was given as the first argument for mustache#render(template, view, partials)');return b.render(e,a,n,s)},g.escape=escapeHtml,g.Scanner=Scanner,g.Context=Context,g.Writer=Writer;let parseFString=e=>{let a=e.split(""),n=[],nextBracket=(e,n)=>{for(let s=n;s<a.length;s+=1)if(e.includes(a[s]))return s;return -1},s=0;for(;s<a.length;)if("{"===a[s]&&s+1<a.length&&"{"===a[s+1])n.push({type:"literal",text:"{"}),s+=2;else if("}"===a[s]&&s+1<a.length&&"}"===a[s+1])n.push({type:"literal",text:"}"}),s+=2;else if("{"===a[s]){let e=nextBracket("}",s);if(e<0)throw Error("Unclosed '{' in template.");n.push({type:"variable",name:a.slice(s+1,e).join("")}),s=e+1}else if("}"===a[s])throw Error("Single '}' in template.");else{let e=nextBracket("{}",s),i=(e<0?a.slice(s):a.slice(s,e)).join("");n.push({type:"literal",text:i}),s=e<0?a.length:e}return n},mustacheTemplateToNodes=e=>e.map(e=>{if("name"===e[0]){let a=e[1].includes(".")?e[1].split(".")[0]:e[1];return{type:"variable",name:a}}return"#"===e[0]?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}}),y={"f-string":(e,a)=>parseFString(e).reduce((e,n)=>{if("variable"===n.type){if(n.name in a)return e+a[n.name];throw Error(`(f-string) Missing value for input ${n.name}`)}return e+n.text},""),mustache:(e,a)=>g.render(e,a)},_={"f-string":parseFString,mustache:e=>{let a=g.parse(e);return mustacheTemplateToNodes(a)}},renderTemplate=(e,a,n)=>y[a](e,n),template_parseTemplate=(e,a)=>_[a](e),checkValidTemplate=(e,a,n)=>{if(!(a in y)){let e=Object.keys(y);throw Error(`Invalid template format. Got \`${a}\`;
                         should be one of ${e}`)}try{let s=n.reduce((e,a)=>(e[a]="foo",e),{});Array.isArray(e)?e.forEach(e=>{if("text"===e.type)renderTemplate(e.text,a,s);else if("image_url"===e.type){if("string"==typeof e.image_url)renderTemplate(e.image_url,a,s);else{let n=e.image_url.url;renderTemplate(n,a,s)}}else throw Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`)}):renderTemplate(e,a,s)}catch(e){throw Error(`Invalid prompt schema: ${e.message}`)}}},986:function(e,a,n){"use strict";n.d(a,{eq:function(){return s.eq},sk:function(){return passthrough_RunnablePassthrough},lW:function(){return s.lW},LE:function(){return i.LE},q:function(){return i.q}});var s=n(8477),i=n(9189),o=n(2272);let passthrough_RunnablePassthrough=class passthrough_RunnablePassthrough extends s.eq{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,a){let n=(0,i.LE)(a);return this.func&&await this.func(e,n),this._callWithConfig(e=>Promise.resolve(e),e,n)}async *transform(e,a){let n;let s=(0,i.LE)(a),l=!0;for await(let a of this._transformStreamWithConfig(e,e=>e,s))if(yield a,l){if(void 0===n)n=a;else try{n=(0,o.zo)(n,a)}catch{n=void 0,l=!1}}this.func&&void 0!==n&&await this.func(n,s)}static assign(e){return new s.Vh(new s.dT({steps:e}))}};n(3478)},7578:function(e,a,n){"use strict";n.d(a,{q:function(){return s.qu}});var s=n(6918)},8463:function(e,a,n){"use strict";n.d(a,{BD:function(){return s.BD},qV:function(){return s.qV}});var s=n(7610)},3711:function(e,a,n){"use strict";n.d(a,{i:function(){return s.i}});var s=n(8498)},6261:function(e,a,n){"use strict";n.d(a,{Cr:function(){return s.Cr},GC:function(){return s.GC},HD:function(){return s.HD},J:function(){return s.J},QW:function(){return s.QW},TN:function(){return s.TN},Xz:function(){return s.Xz},Z0:function(){return s.Z0},gY:function(){return s.gY},ro:function(){return s.ro},xk:function(){return s.xk},xq:function(){return s.xq}});var s=n(3478)},7846:function(e,a,n){"use strict";n.d(a,{bI:function(){return s.bI},Qh:function(){return l.Qh},dS:function(){return s.dS},K:function(){return StructuredOutputParser}});var s=n(9073);n(242);var i=n(6418),o=n(9711);let StructuredOutputParser=class StructuredOutputParser extends s.bI{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let a=i.z.object(Object.fromEntries(Object.entries(e).map(([e,a])=>[e,i.z.string().describe(a)])));return new this(a)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify((0,o.Y_)(this.schema))}
\`\`\`
`}async parse(e){try{let a=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return await this.schema.parseAsync(JSON.parse(a))}catch(a){throw new s.dS(`Failed to parse. Text: "${e}". Error: ${a}`,e)}}};var l=n(4559);n(7578)},6827:function(e,a,n){"use strict";n.d(a,{gc:function(){return i.gc},dy:function(){return s.d},ks:function(){return i.ks},kq:function(){return i.kq},ax:function(){return i.ax},Pf:function(){return o.PromptTemplate},ov:function(){return i.ov},SM:function(){return l.SM}});var s=n(4256),i=n(4359);n(1520);var o=n(4094);n(2566);var l=n(6184);n(6531)},3102:function(e,a,n){"use strict";n.d(a,{LE:function(){return s.LE},eq:function(){return s.eq},lW:function(){return s.lW},q:function(){return s.q},sk:function(){return s.sk}});var s=n(986)},2488:function(e,a,n){"use strict";n.d(a,{lS:function(){return s.lS}});var s=n(298)},6896:function(e,a,n){"use strict";n.d(a,{sU:function(){return convertToOpenAIFunction},VE:function(){return convertToOpenAITool}});var s=n(9711);function convertToOpenAIFunction(e){return{name:e.name,description:e.description,parameters:(0,s.Y_)(e.schema)}}function convertToOpenAITool(e){return isStructuredTool(e)?{type:"function",function:convertToOpenAIFunction(e)}:e}function isStructuredTool(e){return void 0!==e&&Array.isArray(e.lc_namespace)}},1e3:function(e,a,n){"use strict";let s,i,o,l,u,c,p,d,m,f;n.d(a,{z7:function(){return chat_models_ChatOpenAI}});var g,b,y,_,w,v,P,A,S,C,O,E,x,I,R,T,k,j,F,M,N,L,$,z,V,D,B,U,G,K,W,J,H,X,Q,Y,Z,ee,et,er,ea,en,es,ei,eo,el,eu,ec,eh,ep,ed,em,ef,eg,eb,ey,e_,ew,ev,eP,eA,eS,eC,eO,eE,ex,eI,eR,eT,ek,ej={};n.r(ej),n.d(ej,{APIConnectionError:function(){return APIConnectionError},APIConnectionTimeoutError:function(){return APIConnectionTimeoutError},APIError:function(){return APIError},APIUserAbortError:function(){return APIUserAbortError},AuthenticationError:function(){return AuthenticationError},BadRequestError:function(){return BadRequestError},ConflictError:function(){return ConflictError},InternalServerError:function(){return InternalServerError},NotFoundError:function(){return NotFoundError},OpenAIError:function(){return error_OpenAIError},PermissionDeniedError:function(){return PermissionDeniedError},RateLimitError:function(){return RateLimitError},UnprocessableEntityError:function(){return UnprocessableEntityError}});let eF="4.38.5",eM=!1;function setShims(e,a={auto:!1}){if(eM)throw Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(i)throw Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${i}'\``);eM=a.auto,i=e.kind,o=e.fetch,e.Request,e.Response,e.Headers,l=e.FormData,e.Blob,u=e.File,c=e.ReadableStream,p=e.getMultipartRequestOptions,d=e.getDefaultAgent,m=e.fileFromPath,f=e.isFsReadStream}let MultipartBody=class MultipartBody{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function getRuntime({manuallyImported:e}={}){let a,n,s,i;let o=e?"You may need to use polyfills":`Add one of these imports before your first \`import … from 'openai'\`:
- \`import 'openai/shims/node'\` (if you're running on Node)
- \`import 'openai/shims/web'\` (otherwise)
`;try{a=fetch,n=Request,s=Response,i=Headers}catch(e){throw Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${o}`)}return{kind:"web",fetch:a,Request:n,Response:s,Headers:i,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${o}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${o}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${o}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${o}`)}},getMultipartRequestOptions:async(e,a)=>({...a,body:new MultipartBody(e)}),getDefaultAgent:e=>void 0,fileFromPath:()=>{throw Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}i||setShims(getRuntime(),{auto:!0});let error_OpenAIError=class error_OpenAIError extends Error{};let APIError=class APIError extends error_OpenAIError{constructor(e,a,n,s){super(`${APIError.makeMessage(e,a,n)}`),this.status=e,this.headers=s,this.request_id=s?.["x-request-id"],this.error=a,this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,a,n){let s=a?.message?"string"==typeof a.message?a.message:JSON.stringify(a.message):a?JSON.stringify(a):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,a,n,s){if(!e)return new APIConnectionError({cause:castToError(a)});let i=a?.error;return 400===e?new BadRequestError(e,i,n,s):401===e?new AuthenticationError(e,i,n,s):403===e?new PermissionDeniedError(e,i,n,s):404===e?new NotFoundError(e,i,n,s):409===e?new ConflictError(e,i,n,s):422===e?new UnprocessableEntityError(e,i,n,s):429===e?new RateLimitError(e,i,n,s):e>=500?new InternalServerError(e,i,n,s):new APIError(e,i,n,s)}};let APIUserAbortError=class APIUserAbortError extends APIError{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}};let APIConnectionError=class APIConnectionError extends APIError{constructor({message:e,cause:a}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,a&&(this.cause=a)}};let APIConnectionTimeoutError=class APIConnectionTimeoutError extends APIConnectionError{constructor({message:e}={}){super({message:e??"Request timed out."})}};let BadRequestError=class BadRequestError extends APIError{constructor(){super(...arguments),this.status=400}};let AuthenticationError=class AuthenticationError extends APIError{constructor(){super(...arguments),this.status=401}};let PermissionDeniedError=class PermissionDeniedError extends APIError{constructor(){super(...arguments),this.status=403}};let NotFoundError=class NotFoundError extends APIError{constructor(){super(...arguments),this.status=404}};let ConflictError=class ConflictError extends APIError{constructor(){super(...arguments),this.status=409}};let UnprocessableEntityError=class UnprocessableEntityError extends APIError{constructor(){super(...arguments),this.status=422}};let RateLimitError=class RateLimitError extends APIError{constructor(){super(...arguments),this.status=429}};let InternalServerError=class InternalServerError extends APIError{};var eN=n(1430).Buffer;let Stream=class Stream{constructor(e,a){this.iterator=e,this.controller=a}static fromSSEResponse(e,a){let n=!1;return new Stream(async function*(){if(n)throw Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(let n of _iterSSEMessages(e,a))if(!s){if(n.data.startsWith("[DONE]")){s=!0;continue}if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new APIError(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new APIError(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}}s=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{s||a.abort()}},a)}static fromReadableStream(e,a){let n=!1;async function*iterLines(){let a=new LineDecoder,n=readableStreamAsyncIterable(e);for await(let e of n)for(let n of a.decode(e))yield n;for(let e of a.flush())yield e}return new Stream(async function*(){if(n)throw Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let e=!1;try{for await(let a of iterLines())!e&&a&&(yield JSON.parse(a));e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||a.abort()}},a)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],a=[],n=this.iterator(),teeIterator=s=>({next:()=>{if(0===s.length){let s=n.next();e.push(s),a.push(s)}return s.shift()}});return[new Stream(()=>teeIterator(e),this.controller),new Stream(()=>teeIterator(a),this.controller)]}toReadableStream(){let e;let a=this,n=new TextEncoder;return new c({async start(){e=a[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await e.next();if(i)return a.close();let o=n.encode(JSON.stringify(s)+"\n");a.enqueue(o)}catch(e){a.error(e)}},async cancel(){await e.return?.()}})}};async function*_iterSSEMessages(e,a){if(!e.body)throw a.abort(),new error_OpenAIError("Attempted to iterate over a response with no body");let n=new SSEDecoder,s=new LineDecoder,i=readableStreamAsyncIterable(e.body);for await(let e of iterSSEChunks(i))for(let a of s.decode(e)){let e=n.decode(a);e&&(yield e)}for(let e of s.flush()){let a=n.decode(e);a&&(yield a)}}async function*iterSSEChunks(e){let a=new Uint8Array;for await(let n of e){let e;if(null==n)continue;let s=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?new TextEncoder().encode(n):n,i=new Uint8Array(a.length+s.length);for(i.set(a),i.set(s,a.length),a=i;-1!==(e=findDoubleNewlineIndex(a));)yield a.slice(0,e),a=a.slice(e)}a.length>0&&(yield a)}function findDoubleNewlineIndex(e){for(let a=0;a<e.length-2;a++){if(10===e[a]&&10===e[a+1]||13===e[a]&&13===e[a+1])return a+2;if(13===e[a]&&10===e[a+1]&&a+3<e.length&&13===e[a+2]&&10===e[a+3])return a+4}return -1}let SSEDecoder=class SSEDecoder{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[a,n,s]=partition(e,":");return s.startsWith(" ")&&(s=s.substring(1)),"event"===a?this.event=s:"data"===a&&this.data.push(s),null}};let LineDecoder=class LineDecoder{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let a=this.decodeText(e);if(this.trailingCR&&(a="\r"+a,this.trailingCR=!1),a.endsWith("\r")&&(this.trailingCR=!0,a=a.slice(0,-1)),!a)return[];let n=LineDecoder.NEWLINE_CHARS.has(a[a.length-1]||""),s=a.split(LineDecoder.NEWLINE_REGEXP);return(n&&s.pop(),1!==s.length||n)?(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),n||(this.buffer=[s.pop()||""]),s):(this.buffer.push(s[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if(void 0!==eN){if(e instanceof eN)return e.toString();if(e instanceof Uint8Array)return eN.from(e).toString();throw new error_OpenAIError(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new error_OpenAIError(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new error_OpenAIError("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};function partition(e,a){let n=e.indexOf(a);return -1!==n?[e.substring(0,n),a,e.substring(n+a.length)]:[e,"",""]}function readableStreamAsyncIterable(e){if(e[Symbol.asyncIterator])return e;let a=e.getReader();return{async next(){try{let e=await a.read();return e?.done&&a.releaseLock(),e}catch(e){throw a.releaseLock(),e}},async return(){let e=a.cancel();return a.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}LineDecoder.NEWLINE_CHARS=new Set(["\n","\r"]),LineDecoder.NEWLINE_REGEXP=/\r\n|[\n\r]/g;var eL=n(1430).Buffer;let isResponseLike=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,isFileLike=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&isBlobLike(e),isBlobLike=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer,isUploadable=e=>isFileLike(e)||isResponseLike(e)||f(e);async function toFile(e,a,n){if(e=await e,n??(n=isFileLike(e)?{lastModified:e.lastModified,type:e.type}:{}),isResponseLike(e)){let s=await e.blob();return a||(a=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new u([s],a,n)}let s=await getBytes(e);if(a||(a=getName(e)??"unknown_file"),!n.type){let e=s[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new u(s,a,n)}async function getBytes(e){let a=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)a.push(e);else if(isBlobLike(e))a.push(await e.arrayBuffer());else if(isAsyncIterableIterator(e))for await(let n of e)a.push(n);else throw Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${propsForError(e)}`);return a}function propsForError(e){let a=Object.getOwnPropertyNames(e);return`[${a.map(e=>`"${e}"`).join(", ")}]`}function getName(e){return getStringFromMaybeBuffer(e.name)||getStringFromMaybeBuffer(e.filename)||getStringFromMaybeBuffer(e.path)?.split(/[\\/]/).pop()}let getStringFromMaybeBuffer=e=>"string"==typeof e?e:void 0!==eL&&e instanceof eL?String(e):void 0,isAsyncIterableIterator=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],isMultipartBody=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],multipartFormRequestOptions=async e=>{let a=await createForm(e.body);return p(a,e)},createForm=async e=>{let a=new l;return await Promise.all(Object.entries(e||{}).map(([e,n])=>addFormValue(a,e,n))),a},addFormValue=async(e,a,n)=>{if(void 0!==n){if(null==n)throw TypeError(`Received null for "${a}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(a,String(n));else if(isUploadable(n)){let s=await toFile(n);e.append(a,s)}else if(Array.isArray(n))await Promise.all(n.map(n=>addFormValue(e,a+"[]",n)));else if("object"==typeof n)await Promise.all(Object.entries(n).map(([n,s])=>addFormValue(e,`${a}[${n}]`,s)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}};var e$=n(1430).Buffer,ez=n(5656),__classPrivateFieldSet=function(e,a,n,s,i){if("m"===s)throw TypeError("Private method is not writable");if("a"===s&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof a?e!==a||!i:!a.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?i.call(e,n):i?i.value=n:a.set(e,n),n},__classPrivateFieldGet=function(e,a,n,s){if("a"===n&&!s)throw TypeError("Private accessor was defined without a getter");if("function"==typeof a?e!==a||!s:!a.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:a.get(e)};async function defaultParseResponse(e){let{response:a}=e;if(e.options.stream)return(debug("response",a.status,a.url,a.headers,a.body),e.options.__streamClass)?e.options.__streamClass.fromSSEResponse(a,e.controller):Stream.fromSSEResponse(a,e.controller);if(204===a.status)return null;if(e.options.__binaryResponse)return a;let n=a.headers.get("content-type"),s=n?.includes("application/json")||n?.includes("application/vnd.api+json");if(s){let e=await a.json();return debug("response",a.status,a.url,a.headers,e),e}let i=await a.text();return debug("response",a.status,a.url,a.headers,i),i}let APIPromise=class APIPromise extends Promise{constructor(e,a=defaultParseResponse){super(e=>{e(null)}),this.responsePromise=e,this.parseResponse=a}_thenUnwrap(e){return new APIPromise(this.responsePromise,async a=>e(await this.parseResponse(a)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,a]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:a}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,a){return this.parse().then(e,a)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};let APIClient=class APIClient{constructor({baseURL:e,maxRetries:a=2,timeout:n=6e5,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=validatePositiveInteger("maxRetries",a),this.timeout=validatePositiveInteger("timeout",n),this.httpAgent=s,this.fetch=i??o}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...getPlatformHeaders(),...this.authHeaders(e)}}validateHeaders(e,a){}defaultIdempotencyKey(){return`stainless-node-retry-${uuid4()}`}get(e,a){return this.methodRequest("get",e,a)}post(e,a){return this.methodRequest("post",e,a)}patch(e,a){return this.methodRequest("patch",e,a)}put(e,a){return this.methodRequest("put",e,a)}delete(e,a){return this.methodRequest("delete",e,a)}methodRequest(e,a,n){return this.request(Promise.resolve(n).then(n=>({method:e,path:a,...n})))}getAPIList(e,a,n){return this.requestAPIList(a,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if(void 0!==e$)return e$.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){let a=new TextEncoder,n=a.encode(e);return n.length.toString()}}return null}buildRequest(e){let{method:a,path:n,query:s,headers:i={}}=e,o=isMultipartBody(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,l=this.calculateContentLength(o),u=this.buildURL(n,s);"timeout"in e&&validatePositiveInteger("timeout",e.timeout);let c=e.timeout??this.timeout,p=e.httpAgent??this.httpAgent??d(u),m=c+1e3;"number"==typeof p?.options?.timeout&&m>(p.options.timeout??0)&&(p.options.timeout=m),this.idempotencyHeader&&"get"!==a&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let f=this.buildHeaders({options:e,headers:i,contentLength:l}),g={method:a,...o&&{body:o},headers:f,...p&&{agent:p},signal:e.signal??null};return{req:g,url:u,timeout:c}}buildHeaders({options:e,headers:a,contentLength:n}){let s={};n&&(s["content-length"]=n);let o=this.defaultHeaders(e);return applyHeadersMut(s,o),applyHeadersMut(s,a),isMultipartBody(e.body)&&"node"!==i&&delete s["content-type"],this.validateHeaders(s,a),s}async prepareOptions(e){}async prepareRequest(e,{url:a,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(e=>[...e])):{...e}:{}}makeStatusError(e,a,n,s){return APIError.generate(e,a,n,s)}request(e,a=null){return new APIPromise(this.makeRequest(e,a))}async makeRequest(e,a){let n=await e;null==a&&(a=n.maxRetries??this.maxRetries),await this.prepareOptions(n);let{req:s,url:i,timeout:o}=this.buildRequest(n);if(await this.prepareRequest(s,{url:i,options:n}),debug("request",i,n,s.headers),n.signal?.aborted)throw new APIUserAbortError;let l=new AbortController,u=await this.fetchWithTimeout(i,s,o,l).catch(castToError);if(u instanceof Error){if(n.signal?.aborted)throw new APIUserAbortError;if(a)return this.retryRequest(n,a);if("AbortError"===u.name)throw new APIConnectionTimeoutError;throw new APIConnectionError({cause:u})}let c=createResponseHeaders(u.headers);if(!u.ok){if(a&&this.shouldRetry(u)){let e=`retrying, ${a} attempts remaining`;return debug(`response (error; ${e})`,u.status,i,c),this.retryRequest(n,a,c)}let e=await u.text().catch(e=>castToError(e).message),s=safeJSON(e),o=s?void 0:e,l=a?"(error; no more retries left)":"(error; not retryable)";debug(`response (error; ${l})`,u.status,i,c,o);let p=this.makeStatusError(u.status,s,o,c);throw p}return{response:u,options:n,controller:l}}requestAPIList(e,a){let n=this.makeRequest(a,null);return new PagePromise(this,n,e)}buildURL(e,a){let n=new URL(isAbsoluteURL(e)?e:this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return isEmptyObj(s)||(a={...s,...a}),"object"==typeof a&&a&&!Array.isArray(a)&&(n.search=this.stringifyQuery(a)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([e,a])=>void 0!==a).map(([e,a])=>{if("string"==typeof a||"number"==typeof a||"boolean"==typeof a)return`${encodeURIComponent(e)}=${encodeURIComponent(a)}`;if(null===a)return`${encodeURIComponent(e)}=`;throw new error_OpenAIError(`Cannot stringify type ${typeof a}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,a,n,s){let{signal:i,...o}=a||{};i&&i.addEventListener("abort",()=>s.abort());let l=setTimeout(()=>s.abort(),n);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...o}).finally(()=>{clearTimeout(l)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let a=e.headers.get("x-should-retry");return"true"===a||"false"!==a&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,a,n){let s;let i=n?.["retry-after-ms"];if(i){let e=parseFloat(i);Number.isNaN(e)||(s=e)}let o=n?.["retry-after"];if(o&&!s){let e=parseFloat(o);s=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){let n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(a,n)}return await sleep(s),this.makeRequest(e,a-1)}calculateDefaultRetryTimeoutMillis(e,a){return Math.min(.5*Math.pow(2,a-e),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${eF}`}};let AbstractPage=class AbstractPage{constructor(e,a,n,s){S.set(this,void 0),__classPrivateFieldSet(this,S,e,"f"),this.options=s,this.response=a,this.body=n}hasNextPage(){let e=this.getPaginatedItems();return!!e.length&&null!=this.nextPageInfo()}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new error_OpenAIError("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let a={...this.options};if("params"in e&&"object"==typeof a.query)a.query={...a.query,...e.params};else if("url"in e){let n=[...Object.entries(a.query||{}),...e.url.searchParams.entries()];for(let[a,s]of n)e.url.searchParams.set(a,s);a.query=void 0,a.path=e.url.toString()}return await __classPrivateFieldGet(this,S,"f").requestAPIList(this.constructor,a)}async *iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async *[(S=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let a of e.getPaginatedItems())yield a}};let PagePromise=class PagePromise extends APIPromise{constructor(e,a,n){super(a,async a=>new n(e,a.response,await defaultParseResponse(a),a.options))}async *[Symbol.asyncIterator](){let e=await this;for await(let a of e)yield a}};let createResponseHeaders=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,a){let n=a.toString();return e[n.toLowerCase()]||e[n]}}),eV={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},isRequestOptions=e=>"object"==typeof e&&null!==e&&!isEmptyObj(e)&&Object.keys(e).every(e=>hasOwn(eV,e)),getPlatformProperties=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":eF,"X-Stainless-OS":normalizePlatform(Deno.build.os),"X-Stainless-Arch":normalizeArch(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":eF,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":ez.version};if("[object process]"===Object.prototype.toString.call(void 0!==ez?ez:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":eF,"X-Stainless-OS":normalizePlatform(ez.platform),"X-Stainless-Arch":normalizeArch(ez.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":ez.version};let e=getBrowserInfo();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":eF,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":eF,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function getBrowserInfo(){if("undefined"==typeof navigator||!navigator)return null;for(let{key:e,pattern:a}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let n=a.exec(navigator.userAgent);if(n){let a=n[1]||0,s=n[2]||0,i=n[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}let normalizeArch=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",normalizePlatform=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown",getPlatformHeaders=()=>s??(s=getPlatformProperties()),safeJSON=e=>{try{return JSON.parse(e)}catch(e){return}},eD=RegExp("^(?:[a-z]+:)?//","i"),isAbsoluteURL=e=>eD.test(e),sleep=e=>new Promise(a=>setTimeout(a,e)),validatePositiveInteger=(e,a)=>{if("number"!=typeof a||!Number.isInteger(a))throw new error_OpenAIError(`${e} must be an integer`);if(a<0)throw new error_OpenAIError(`${e} must be a positive integer`);return a},castToError=e=>e instanceof Error?e:Error(e),readEnv=e=>void 0!==ez?ez.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function isEmptyObj(e){if(!e)return!0;for(let a in e)return!1;return!0}function hasOwn(e,a){return Object.prototype.hasOwnProperty.call(e,a)}function applyHeadersMut(e,a){for(let n in a){if(!hasOwn(a,n))continue;let s=n.toLowerCase();if(!s)continue;let i=a[n];null===i?delete e[s]:void 0!==i&&(e[s]=i)}}function debug(e,...a){void 0!==ez&&ez?.env?.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${e}`,...a)}let uuid4=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let a=16*Math.random()|0;return("x"===e?a:3&a|8).toString(16)}),isRunningInBrowser=()=>"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator;function isObj(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}let Page=class Page extends AbstractPage{constructor(e,a,n,s){super(e,a,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}};let CursorPage=class CursorPage extends AbstractPage{constructor(e,a,n,s){super(e,a,n,s),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let a=Object.fromEntries(e.url.searchParams);return Object.keys(a).length?a:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let a=e[e.length-1]?.id;return a?{params:{after:a}}:null}};let APIResource=class APIResource{constructor(e){this._client=e}};let Completions=class Completions extends APIResource{create(e,a){return this._client.post("/completions",{body:e,...a,stream:e.stream??!1})}};Completions||(Completions={});let completions_Completions=class completions_Completions extends APIResource{create(e,a){return this._client.post("/chat/completions",{body:e,...a,stream:e.stream??!1})}};completions_Completions||(completions_Completions={});let Chat=class Chat extends APIResource{constructor(){super(...arguments),this.completions=new completions_Completions(this._client)}};(Chat||(Chat={})).Completions=completions_Completions;let embeddings_Embeddings=class embeddings_Embeddings extends APIResource{create(e,a){return this._client.post("/embeddings",{body:e,...a})}};embeddings_Embeddings||(embeddings_Embeddings={});let Files=class Files extends APIResource{create(e,a){return this._client.post("/files",multipartFormRequestOptions({body:e,...a}))}retrieve(e,a){return this._client.get(`/files/${e}`,a)}list(e={},a){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/files",FileObjectsPage,{query:e,...a})}del(e,a){return this._client.delete(`/files/${e}`,a)}content(e,a){return this._client.get(`/files/${e}/content`,{...a,__binaryResponse:!0})}retrieveContent(e,a){return this._client.get(`/files/${e}/content`,{...a,headers:{Accept:"application/json",...a?.headers}})}async waitForProcessing(e,{pollInterval:a=5e3,maxWait:n=18e5}={}){let s=new Set(["processed","error","deleted"]),i=Date.now(),o=await this.retrieve(e);for(;!o.status||!s.has(o.status);)if(await sleep(a),o=await this.retrieve(e),Date.now()-i>n)throw new APIConnectionTimeoutError({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return o}};let FileObjectsPage=class FileObjectsPage extends Page{};(Files||(Files={})).FileObjectsPage=FileObjectsPage;let Images=class Images extends APIResource{createVariation(e,a){return this._client.post("/images/variations",multipartFormRequestOptions({body:e,...a}))}edit(e,a){return this._client.post("/images/edits",multipartFormRequestOptions({body:e,...a}))}generate(e,a){return this._client.post("/images/generations",{body:e,...a})}};Images||(Images={});let Speech=class Speech extends APIResource{create(e,a){return this._client.post("/audio/speech",{body:e,...a,__binaryResponse:!0})}};Speech||(Speech={});let Transcriptions=class Transcriptions extends APIResource{create(e,a){return this._client.post("/audio/transcriptions",multipartFormRequestOptions({body:e,...a}))}};Transcriptions||(Transcriptions={});let Translations=class Translations extends APIResource{create(e,a){return this._client.post("/audio/translations",multipartFormRequestOptions({body:e,...a}))}};Translations||(Translations={});let Audio=class Audio extends APIResource{constructor(){super(...arguments),this.transcriptions=new Transcriptions(this._client),this.translations=new Translations(this._client),this.speech=new Speech(this._client)}};(g=Audio||(Audio={})).Transcriptions=Transcriptions,g.Translations=Translations,g.Speech=Speech;let Moderations=class Moderations extends APIResource{create(e,a){return this._client.post("/moderations",{body:e,...a})}};Moderations||(Moderations={});let Models=class Models extends APIResource{retrieve(e,a){return this._client.get(`/models/${e}`,a)}list(e){return this._client.getAPIList("/models",ModelsPage,e)}del(e,a){return this._client.delete(`/models/${e}`,a)}};let ModelsPage=class ModelsPage extends Page{};(Models||(Models={})).ModelsPage=ModelsPage;let Checkpoints=class Checkpoints extends APIResource{list(e,a={},n){return isRequestOptions(a)?this.list(e,{},a):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,FineTuningJobCheckpointsPage,{query:a,...n})}};let FineTuningJobCheckpointsPage=class FineTuningJobCheckpointsPage extends CursorPage{};(Checkpoints||(Checkpoints={})).FineTuningJobCheckpointsPage=FineTuningJobCheckpointsPage;let Jobs=class Jobs extends APIResource{constructor(){super(...arguments),this.checkpoints=new Checkpoints(this._client)}create(e,a){return this._client.post("/fine_tuning/jobs",{body:e,...a})}retrieve(e,a){return this._client.get(`/fine_tuning/jobs/${e}`,a)}list(e={},a){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",FineTuningJobsPage,{query:e,...a})}cancel(e,a){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,a)}listEvents(e,a={},n){return isRequestOptions(a)?this.listEvents(e,{},a):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,FineTuningJobEventsPage,{query:a,...n})}};let FineTuningJobsPage=class FineTuningJobsPage extends CursorPage{};let FineTuningJobEventsPage=class FineTuningJobEventsPage extends CursorPage{};(b=Jobs||(Jobs={})).FineTuningJobsPage=FineTuningJobsPage,b.FineTuningJobEventsPage=FineTuningJobEventsPage,b.Checkpoints=Checkpoints,b.FineTuningJobCheckpointsPage=FineTuningJobCheckpointsPage;let FineTuning=class FineTuning extends APIResource{constructor(){super(...arguments),this.jobs=new Jobs(this._client)}};(y=FineTuning||(FineTuning={})).Jobs=Jobs,y.FineTuningJobsPage=FineTuningJobsPage,y.FineTuningJobEventsPage=FineTuningJobEventsPage;let Assistants=class Assistants extends APIResource{create(e,a){return this._client.post("/assistants",{body:e,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,a){return this._client.get(`/assistants/${e}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,a,n){return this._client.post(`/assistants/${e}`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},a){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/assistants",AssistantsPage,{query:e,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,a){return this._client.delete(`/assistants/${e}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}};let AssistantsPage=class AssistantsPage extends CursorPage{};function isRunnableFunctionWithParse(e){return"function"==typeof e.parse}(Assistants||(Assistants={})).AssistantsPage=AssistantsPage;let isAssistantMessage=e=>e?.role==="assistant",isFunctionMessage=e=>e?.role==="function",isToolMessage=e=>e?.role==="tool";var AbstractChatCompletionRunner_classPrivateFieldSet=function(e,a,n,s,i){if("m"===s)throw TypeError("Private method is not writable");if("a"===s&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof a?e!==a||!i:!a.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?i.call(e,n):i?i.value=n:a.set(e,n),n},AbstractChatCompletionRunner_classPrivateFieldGet=function(e,a,n,s){if("a"===n&&!s)throw TypeError("Private accessor was defined without a getter");if("function"==typeof a?e!==a||!s:!a.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:a.get(e)};let AbstractChatCompletionRunner=class AbstractChatCompletionRunner{constructor(){C.add(this),this.controller=new AbortController,O.set(this,void 0),E.set(this,()=>{}),x.set(this,()=>{}),I.set(this,void 0),R.set(this,()=>{}),T.set(this,()=>{}),k.set(this,{}),this._chatCompletions=[],this.messages=[],j.set(this,!1),F.set(this,!1),M.set(this,!1),N.set(this,!1),B.set(this,e=>{if(AbstractChatCompletionRunner_classPrivateFieldSet(this,F,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new APIUserAbortError),e instanceof APIUserAbortError)return AbstractChatCompletionRunner_classPrivateFieldSet(this,M,!0,"f"),this._emit("abort",e);if(e instanceof error_OpenAIError)return this._emit("error",e);if(e instanceof Error){let a=new error_OpenAIError(e.message);return a.cause=e,this._emit("error",a)}return this._emit("error",new error_OpenAIError(String(e)))}),AbstractChatCompletionRunner_classPrivateFieldSet(this,O,new Promise((e,a)=>{AbstractChatCompletionRunner_classPrivateFieldSet(this,E,e,"f"),AbstractChatCompletionRunner_classPrivateFieldSet(this,x,a,"f")}),"f"),AbstractChatCompletionRunner_classPrivateFieldSet(this,I,new Promise((e,a)=>{AbstractChatCompletionRunner_classPrivateFieldSet(this,R,e,"f"),AbstractChatCompletionRunner_classPrivateFieldSet(this,T,a,"f")}),"f"),AbstractChatCompletionRunner_classPrivateFieldGet(this,O,"f").catch(()=>{}),AbstractChatCompletionRunner_classPrivateFieldGet(this,I,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},AbstractChatCompletionRunner_classPrivateFieldGet(this,B,"f"))},0)}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let a=e.choices[0]?.message;return a&&this._addMessage(a),e}_addMessage(e,a=!0){if("content"in e||(e.content=null),this.messages.push(e),a){if(this._emit("message",e),(isFunctionMessage(e)||isToolMessage(e))&&e.content)this._emit("functionCallResult",e.content);else if(isAssistantMessage(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(isAssistantMessage(e)&&e.tool_calls)for(let a of e.tool_calls)"function"===a.type&&this._emit("functionCall",a.function)}}_connected(){this.ended||(AbstractChatCompletionRunner_classPrivateFieldGet(this,E,"f").call(this),this._emit("connect"))}get ended(){return AbstractChatCompletionRunner_classPrivateFieldGet(this,j,"f")}get errored(){return AbstractChatCompletionRunner_classPrivateFieldGet(this,F,"f")}get aborted(){return AbstractChatCompletionRunner_classPrivateFieldGet(this,M,"f")}abort(){this.controller.abort()}on(e,a){let n=AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e]||(AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e]=[]);return n.push({listener:a}),this}off(e,a){let n=AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e];if(!n)return this;let s=n.findIndex(e=>e.listener===a);return s>=0&&n.splice(s,1),this}once(e,a){let n=AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e]||(AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e]=[]);return n.push({listener:a,once:!0}),this}emitted(e){return new Promise((a,n)=>{AbstractChatCompletionRunner_classPrivateFieldSet(this,N,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,a)})}async done(){AbstractChatCompletionRunner_classPrivateFieldSet(this,N,!0,"f"),await AbstractChatCompletionRunner_classPrivateFieldGet(this,I,"f")}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new error_OpenAIError("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",L).call(this)}async finalMessage(){return await this.done(),AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",$).call(this)}async finalFunctionCall(){return await this.done(),AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",z).call(this)}async finalFunctionCallResult(){return await this.done(),AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",V).call(this)}async totalUsage(){return await this.done(),AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",D).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...a){if(AbstractChatCompletionRunner_classPrivateFieldGet(this,j,"f"))return;"end"===e&&(AbstractChatCompletionRunner_classPrivateFieldSet(this,j,!0,"f"),AbstractChatCompletionRunner_classPrivateFieldGet(this,R,"f").call(this));let n=AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e];if(n&&(AbstractChatCompletionRunner_classPrivateFieldGet(this,k,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...a))),"abort"===e){let e=a[0];AbstractChatCompletionRunner_classPrivateFieldGet(this,N,"f")||n?.length||Promise.reject(e),AbstractChatCompletionRunner_classPrivateFieldGet(this,x,"f").call(this,e),AbstractChatCompletionRunner_classPrivateFieldGet(this,T,"f").call(this,e),this._emit("end");return}if("error"===e){let e=a[0];AbstractChatCompletionRunner_classPrivateFieldGet(this,N,"f")||n?.length||Promise.reject(e),AbstractChatCompletionRunner_classPrivateFieldGet(this,x,"f").call(this,e),AbstractChatCompletionRunner_classPrivateFieldGet(this,T,"f").call(this,e),this._emit("end")}}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let a=AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",$).call(this);a&&this._emit("finalMessage",a);let n=AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",L).call(this);n&&this._emit("finalContent",n);let s=AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",z).call(this);s&&this._emit("finalFunctionCall",s);let i=AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",V).call(this);null!=i&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",D).call(this))}async _createChatCompletion(e,a,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",U).call(this,a);let i=await e.create({...a,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(i)}async _runChatCompletion(e,a,n){for(let e of a.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,a,n)}async _runFunctions(e,a,n){let s="function",{function_call:i="auto",stream:o,...l}=a,u="string"!=typeof i&&i?.name,{maxChatCompletions:c=10}=n||{},p={};for(let e of a.functions)p[e.name||e.function.name]=e;let d=a.functions.map(e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description}));for(let e of a.messages)this._addMessage(e,!1);for(let a=0;a<c;++a){let a;let o=await this._createChatCompletion(e,{...l,function_call:i,functions:d,messages:[...this.messages]},n),c=o.choices[0]?.message;if(!c)throw new error_OpenAIError("missing message in ChatCompletion response");if(!c.function_call)return;let{name:m,arguments:f}=c.function_call,g=p[m];if(g){if(u&&u!==m){let e=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:m,content:e});continue}}else{let e=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${d.map(e=>JSON.stringify(e.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:e});continue}try{a=isRunnableFunctionWithParse(g)?await g.parse(f):f}catch(e){this._addMessage({role:s,name:m,content:e instanceof Error?e.message:String(e)});continue}let b=await g.function(a,this),y=AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",G).call(this,b);if(this._addMessage({role:s,name:m,content:y}),u)return}}async _runTools(e,a,n){let s="tool",{tool_choice:i="auto",stream:o,...l}=a,u="string"!=typeof i&&i?.function?.name,{maxChatCompletions:c=10}=n||{},p={};for(let e of a.tools)"function"===e.type&&(p[e.function.name||e.function.function.name]=e.function);let d="tools"in a?a.tools.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description}}:e):void 0;for(let e of a.messages)this._addMessage(e,!1);for(let a=0;a<c;++a){let a=await this._createChatCompletion(e,{...l,tool_choice:i,tools:d,messages:[...this.messages]},n),o=a.choices[0]?.message;if(!o)throw new error_OpenAIError("missing message in ChatCompletion response");if(!o.tool_calls)break;for(let e of o.tool_calls){let a;if("function"!==e.type)continue;let n=e.id,{name:i,arguments:o}=e.function,l=p[i];if(l){if(u&&u!==i){let e=`Invalid tool_call: ${JSON.stringify(i)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:n,content:e});continue}}else{let e=`Invalid tool_call: ${JSON.stringify(i)}. Available options are: ${d.map(e=>JSON.stringify(e.function.name)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:n,content:e});continue}try{a=isRunnableFunctionWithParse(l)?await l.parse(o):o}catch(a){let e=a instanceof Error?a.message:String(a);this._addMessage({role:s,tool_call_id:n,content:e});continue}let c=await l.function(a,this),m=AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",G).call(this,c);if(this._addMessage({role:s,tool_call_id:n,content:m}),u)return}}}};O=new WeakMap,E=new WeakMap,x=new WeakMap,I=new WeakMap,R=new WeakMap,T=new WeakMap,k=new WeakMap,j=new WeakMap,F=new WeakMap,M=new WeakMap,N=new WeakMap,B=new WeakMap,C=new WeakSet,L=function(){return AbstractChatCompletionRunner_classPrivateFieldGet(this,C,"m",$).call(this).content??null},$=function(){let e=this.messages.length;for(;e-- >0;){let a=this.messages[e];if(isAssistantMessage(a))return{...a,content:a.content??null}}throw new error_OpenAIError("stream ended without producing a ChatCompletionMessage with role=assistant")},z=function(){for(let e=this.messages.length-1;e>=0;e--){let a=this.messages[e];if(isAssistantMessage(a)&&a?.function_call)return a.function_call;if(isAssistantMessage(a)&&a?.tool_calls?.length)return a.tool_calls.at(-1)?.function}},V=function(){for(let e=this.messages.length-1;e>=0;e--){let a=this.messages[e];if(isFunctionMessage(a)&&null!=a.content||isToolMessage(a)&&null!=a.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===a.tool_call_id)))return a.content}},D=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:a}of this._chatCompletions)a&&(e.completion_tokens+=a.completion_tokens,e.prompt_tokens+=a.prompt_tokens,e.total_tokens+=a.total_tokens);return e},U=function(e){if(null!=e.n&&e.n>1)throw new error_OpenAIError("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},G=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};let ChatCompletionRunner=class ChatCompletionRunner extends AbstractChatCompletionRunner{static runFunctions(e,a,n){let s=new ChatCompletionRunner,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,a,i)),s}static runTools(e,a,n){let s=new ChatCompletionRunner,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,a,i)),s}_addMessage(e){super._addMessage(e),isAssistantMessage(e)&&e.content&&this._emit("content",e.content)}};var ChatCompletionStream_classPrivateFieldGet=function(e,a,n,s){if("a"===n&&!s)throw TypeError("Private accessor was defined without a getter");if("function"==typeof a?e!==a||!s:!a.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:a.get(e)},ChatCompletionStream_classPrivateFieldSet=function(e,a,n,s,i){if("m"===s)throw TypeError("Private method is not writable");if("a"===s&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof a?e!==a||!i:!a.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?i.call(e,n):i?i.value=n:a.set(e,n),n};let ChatCompletionStream=class ChatCompletionStream extends AbstractChatCompletionRunner{constructor(){super(...arguments),K.add(this),W.set(this,void 0)}get currentChatCompletionSnapshot(){return ChatCompletionStream_classPrivateFieldGet(this,W,"f")}static fromReadableStream(e){let a=new ChatCompletionStream;return a._run(()=>a._fromReadableStream(e)),a}static createChatCompletion(e,a,n){let s=new ChatCompletionStream;return s._run(()=>s._runChatCompletion(e,{...a,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,a,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),ChatCompletionStream_classPrivateFieldGet(this,K,"m",J).call(this);let i=await e.create({...a,stream:!0},{...n,signal:this.controller.signal});for await(let e of(this._connected(),i))ChatCompletionStream_classPrivateFieldGet(this,K,"m",H).call(this,e);if(i.controller.signal?.aborted)throw new APIUserAbortError;return this._addChatCompletion(ChatCompletionStream_classPrivateFieldGet(this,K,"m",X).call(this))}async _fromReadableStream(e,a){let n;let s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),ChatCompletionStream_classPrivateFieldGet(this,K,"m",J).call(this),this._connected();let i=Stream.fromReadableStream(e,this.controller);for await(let e of i)n&&n!==e.id&&this._addChatCompletion(ChatCompletionStream_classPrivateFieldGet(this,K,"m",X).call(this)),ChatCompletionStream_classPrivateFieldGet(this,K,"m",H).call(this,e),n=e.id;if(i.controller.signal?.aborted)throw new APIUserAbortError;return this._addChatCompletion(ChatCompletionStream_classPrivateFieldGet(this,K,"m",X).call(this))}[(W=new WeakMap,K=new WeakSet,J=function(){this.ended||ChatCompletionStream_classPrivateFieldSet(this,W,void 0,"f")},H=function(e){if(this.ended)return;let a=ChatCompletionStream_classPrivateFieldGet(this,K,"m",Q).call(this,e);this._emit("chunk",e,a);let n=e.choices[0]?.delta?.content,s=a.choices[0]?.message;null!=n&&s?.role==="assistant"&&s?.content&&this._emit("content",n,s.content)},X=function(){if(this.ended)throw new error_OpenAIError("stream has ended, this shouldn't happen");let e=ChatCompletionStream_classPrivateFieldGet(this,W,"f");if(!e)throw new error_OpenAIError("request ended without sending any chunks");return ChatCompletionStream_classPrivateFieldSet(this,W,void 0,"f"),finalizeChatCompletion(e)},Q=function(e){var a,n,s;let i=ChatCompletionStream_classPrivateFieldGet(this,W,"f"),{choices:o,...l}=e;for(let{delta:o,finish_reason:u,index:c,logprobs:p=null,...d}of(i?Object.assign(i,l):i=ChatCompletionStream_classPrivateFieldSet(this,W,{...l,choices:[]},"f"),e.choices)){let e=i.choices[c];if(e||(e=i.choices[c]={finish_reason:u,index:c,message:{},logprobs:p,...d}),p){if(e.logprobs){let{content:n,...s}=p;Object.assign(e.logprobs,s),n&&((a=e.logprobs).content??(a.content=[]),e.logprobs.content.push(...n))}else e.logprobs=Object.assign({},p)}if(u&&(e.finish_reason=u),Object.assign(e,d),!o)continue;let{content:l,function_call:m,role:f,tool_calls:g,...b}=o;if(Object.assign(e.message,b),l&&(e.message.content=(e.message.content||"")+l),f&&(e.message.role=f),m&&(e.message.function_call?(m.name&&(e.message.function_call.name=m.name),m.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=m.arguments)):e.message.function_call=m),g)for(let{index:a,id:n,type:i,function:o,...l}of(e.message.tool_calls||(e.message.tool_calls=[]),g)){let u=(s=e.message.tool_calls)[a]??(s[a]={});Object.assign(u,l),n&&(u.id=n),i&&(u.type=i),o&&(u.function??(u.function={arguments:""})),o?.name&&(u.function.name=o.name),o?.arguments&&(u.function.arguments+=o.arguments)}}return i},Symbol.asyncIterator)](){let e=[],a=[],n=!1;return this.on("chunk",n=>{let s=a.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{for(let e of(n=!0,a))e.resolve(void 0);a.length=0}),this.on("abort",e=>{for(let s of(n=!0,a))s.reject(e);a.length=0}),this.on("error",e=>{for(let s of(n=!0,a))s.reject(e);a.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>a.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});let s=e.shift();return{value:s,done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){let e=new Stream(this[Symbol.asyncIterator].bind(this),this.controller);return e.toReadableStream()}};function finalizeChatCompletion(e){let{id:a,choices:n,created:s,model:i,system_fingerprint:o,...l}=e;return{...l,id:a,choices:n.map(({message:a,finish_reason:n,index:s,logprobs:i,...o})=>{if(!n)throw new error_OpenAIError(`missing finish_reason for choice ${s}`);let{content:l=null,function_call:u,tool_calls:c,...p}=a,d=a.role;if(!d)throw new error_OpenAIError(`missing role for choice ${s}`);if(u){let{arguments:e,name:a}=u;if(null==e)throw new error_OpenAIError(`missing function_call.arguments for choice ${s}`);if(!a)throw new error_OpenAIError(`missing function_call.name for choice ${s}`);return{...o,message:{content:l,function_call:{arguments:e,name:a},role:d},finish_reason:n,index:s,logprobs:i}}return c?{...o,index:s,finish_reason:n,logprobs:i,message:{...p,role:d,content:l,tool_calls:c.map((a,n)=>{let{function:i,type:o,id:l,...u}=a,{arguments:c,name:p,...d}=i||{};if(null==l)throw new error_OpenAIError(`missing choices[${s}].tool_calls[${n}].id
${str(e)}`);if(null==o)throw new error_OpenAIError(`missing choices[${s}].tool_calls[${n}].type
${str(e)}`);if(null==p)throw new error_OpenAIError(`missing choices[${s}].tool_calls[${n}].function.name
${str(e)}`);if(null==c)throw new error_OpenAIError(`missing choices[${s}].tool_calls[${n}].function.arguments
${str(e)}`);return{...u,id:l,type:o,function:{...d,name:p,arguments:c}}})}}:{...o,message:{...p,content:l,role:d},finish_reason:n,index:s,logprobs:i}}),created:s,model:i,object:"chat.completion",...o?{system_fingerprint:o}:{}}}function str(e){return JSON.stringify(e)}let ChatCompletionStreamingRunner=class ChatCompletionStreamingRunner extends ChatCompletionStream{static fromReadableStream(e){let a=new ChatCompletionStreamingRunner;return a._run(()=>a._fromReadableStream(e)),a}static runFunctions(e,a,n){let s=new ChatCompletionStreamingRunner,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,a,i)),s}static runTools(e,a,n){let s=new ChatCompletionStreamingRunner,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,a,i)),s}};let chat_completions_Completions=class chat_completions_Completions extends APIResource{runFunctions(e,a){return e.stream?ChatCompletionStreamingRunner.runFunctions(this._client.chat.completions,e,a):ChatCompletionRunner.runFunctions(this._client.chat.completions,e,a)}runTools(e,a){return e.stream?ChatCompletionStreamingRunner.runTools(this._client.chat.completions,e,a):ChatCompletionRunner.runTools(this._client.chat.completions,e,a)}stream(e,a){return ChatCompletionStream.createChatCompletion(this._client.chat.completions,e,a)}};let chat_Chat=class chat_Chat extends APIResource{constructor(){super(...arguments),this.completions=new chat_completions_Completions(this._client)}};(chat_Chat||(chat_Chat={})).Completions=chat_completions_Completions;var AbstractAssistantStreamRunner_classPrivateFieldSet=function(e,a,n,s,i){if("m"===s)throw TypeError("Private method is not writable");if("a"===s&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof a?e!==a||!i:!a.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?i.call(e,n):i?i.value=n:a.set(e,n),n},AbstractAssistantStreamRunner_classPrivateFieldGet=function(e,a,n,s){if("a"===n&&!s)throw TypeError("Private accessor was defined without a getter");if("function"==typeof a?e!==a||!s:!a.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:a.get(e)};let AbstractAssistantStreamRunner=class AbstractAssistantStreamRunner{constructor(){this.controller=new AbortController,Y.set(this,void 0),Z.set(this,()=>{}),ee.set(this,()=>{}),et.set(this,void 0),er.set(this,()=>{}),ea.set(this,()=>{}),en.set(this,{}),es.set(this,!1),ei.set(this,!1),eo.set(this,!1),el.set(this,!1),eu.set(this,e=>{if(AbstractAssistantStreamRunner_classPrivateFieldSet(this,ei,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new APIUserAbortError),e instanceof APIUserAbortError)return AbstractAssistantStreamRunner_classPrivateFieldSet(this,eo,!0,"f"),this._emit("abort",e);if(e instanceof error_OpenAIError)return this._emit("error",e);if(e instanceof Error){let a=new error_OpenAIError(e.message);return a.cause=e,this._emit("error",a)}return this._emit("error",new error_OpenAIError(String(e)))}),AbstractAssistantStreamRunner_classPrivateFieldSet(this,Y,new Promise((e,a)=>{AbstractAssistantStreamRunner_classPrivateFieldSet(this,Z,e,"f"),AbstractAssistantStreamRunner_classPrivateFieldSet(this,ee,a,"f")}),"f"),AbstractAssistantStreamRunner_classPrivateFieldSet(this,et,new Promise((e,a)=>{AbstractAssistantStreamRunner_classPrivateFieldSet(this,er,e,"f"),AbstractAssistantStreamRunner_classPrivateFieldSet(this,ea,a,"f")}),"f"),AbstractAssistantStreamRunner_classPrivateFieldGet(this,Y,"f").catch(()=>{}),AbstractAssistantStreamRunner_classPrivateFieldGet(this,et,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emit("end")},AbstractAssistantStreamRunner_classPrivateFieldGet(this,eu,"f"))},0)}_addRun(e){return e}_connected(){this.ended||(AbstractAssistantStreamRunner_classPrivateFieldGet(this,Z,"f").call(this),this._emit("connect"))}get ended(){return AbstractAssistantStreamRunner_classPrivateFieldGet(this,es,"f")}get errored(){return AbstractAssistantStreamRunner_classPrivateFieldGet(this,ei,"f")}get aborted(){return AbstractAssistantStreamRunner_classPrivateFieldGet(this,eo,"f")}abort(){this.controller.abort()}on(e,a){let n=AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e]||(AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e]=[]);return n.push({listener:a}),this}off(e,a){let n=AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e];if(!n)return this;let s=n.findIndex(e=>e.listener===a);return s>=0&&n.splice(s,1),this}once(e,a){let n=AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e]||(AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e]=[]);return n.push({listener:a,once:!0}),this}emitted(e){return new Promise((a,n)=>{AbstractAssistantStreamRunner_classPrivateFieldSet(this,el,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,a)})}async done(){AbstractAssistantStreamRunner_classPrivateFieldSet(this,el,!0,"f"),await AbstractAssistantStreamRunner_classPrivateFieldGet(this,et,"f")}_emit(e,...a){if(AbstractAssistantStreamRunner_classPrivateFieldGet(this,es,"f"))return;"end"===e&&(AbstractAssistantStreamRunner_classPrivateFieldSet(this,es,!0,"f"),AbstractAssistantStreamRunner_classPrivateFieldGet(this,er,"f").call(this));let n=AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e];if(n&&(AbstractAssistantStreamRunner_classPrivateFieldGet(this,en,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...a))),"abort"===e){let e=a[0];AbstractAssistantStreamRunner_classPrivateFieldGet(this,el,"f")||n?.length||Promise.reject(e),AbstractAssistantStreamRunner_classPrivateFieldGet(this,ee,"f").call(this,e),AbstractAssistantStreamRunner_classPrivateFieldGet(this,ea,"f").call(this,e),this._emit("end");return}if("error"===e){let e=a[0];AbstractAssistantStreamRunner_classPrivateFieldGet(this,el,"f")||n?.length||Promise.reject(e),AbstractAssistantStreamRunner_classPrivateFieldGet(this,ee,"f").call(this,e),AbstractAssistantStreamRunner_classPrivateFieldGet(this,ea,"f").call(this,e),this._emit("end")}}async _threadAssistantStream(e,a,n){return await this._createThreadAssistantStream(a,e,n)}async _runAssistantStream(e,a,n,s){return await this._createAssistantStream(a,e,n,s)}async _runToolAssistantStream(e,a,n,s,i){return await this._createToolAssistantStream(n,e,a,s,i)}async _createThreadAssistantStream(e,a,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i=await e.createAndRun({...a,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addRun(i)}async _createToolAssistantStream(e,a,n,s,i){let o=i?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));let l=await e.submitToolOutputs(a,n,{...s,stream:!1},{...i,signal:this.controller.signal});return this._connected(),this._addRun(l)}async _createAssistantStream(e,a,n,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o=await e.create(a,{...n,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addRun(o)}};Y=new WeakMap,Z=new WeakMap,ee=new WeakMap,et=new WeakMap,er=new WeakMap,ea=new WeakMap,en=new WeakMap,es=new WeakMap,ei=new WeakMap,eo=new WeakMap,el=new WeakMap,eu=new WeakMap;var AssistantStream_classPrivateFieldGet=function(e,a,n,s){if("a"===n&&!s)throw TypeError("Private accessor was defined without a getter");if("function"==typeof a?e!==a||!s:!a.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:a.get(e)},AssistantStream_classPrivateFieldSet=function(e,a,n,s,i){if("m"===s)throw TypeError("Private method is not writable");if("a"===s&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof a?e!==a||!i:!a.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?i.call(e,n):i?i.value=n:a.set(e,n),n};let AssistantStream=class AssistantStream extends AbstractAssistantStreamRunner{constructor(){super(...arguments),ec.add(this),eh.set(this,[]),ep.set(this,{}),ed.set(this,{}),em.set(this,void 0),ef.set(this,void 0),eg.set(this,void 0),eb.set(this,void 0),ey.set(this,void 0),e_.set(this,void 0),ew.set(this,void 0),ev.set(this,void 0),eP.set(this,void 0)}[(eh=new WeakMap,ep=new WeakMap,ed=new WeakMap,em=new WeakMap,ef=new WeakMap,eg=new WeakMap,eb=new WeakMap,ey=new WeakMap,e_=new WeakMap,ew=new WeakMap,ev=new WeakMap,eP=new WeakMap,ec=new WeakSet,Symbol.asyncIterator)](){let e=[],a=[],n=!1;return this.on("event",n=>{let s=a.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{for(let e of(n=!0,a))e.resolve(void 0);a.length=0}),this.on("abort",e=>{for(let s of(n=!0,a))s.reject(e);a.length=0}),this.on("error",e=>{for(let s of(n=!0,a))s.reject(e);a.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>a.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});let s=e.shift();return{value:s,done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let a=new AssistantStream;return a._run(()=>a._fromReadableStream(e)),a}async _fromReadableStream(e,a){let n=a?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();let s=Stream.fromReadableStream(e,this.controller);for await(let e of s)AssistantStream_classPrivateFieldGet(this,ec,"m",eA).call(this,e);if(s.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(AssistantStream_classPrivateFieldGet(this,ec,"m",eS).call(this))}toReadableStream(){let e=new Stream(this[Symbol.asyncIterator].bind(this),this.controller);return e.toReadableStream()}static createToolAssistantStream(e,a,n,s,i){let o=new AssistantStream;return o._run(()=>o._runToolAssistantStream(e,a,n,s,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),o}async _createToolAssistantStream(e,a,n,s,i){let o=i?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));let l={...s,stream:!0},u=await e.submitToolOutputs(a,n,l,{...i,signal:this.controller.signal});for await(let e of(this._connected(),u))AssistantStream_classPrivateFieldGet(this,ec,"m",eA).call(this,e);if(u.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(AssistantStream_classPrivateFieldGet(this,ec,"m",eS).call(this))}static createThreadAssistantStream(e,a,n){let s=new AssistantStream;return s._run(()=>s._threadAssistantStream(e,a,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,a,n,s){let i=new AssistantStream;return i._run(()=>i._runAssistantStream(e,a,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return AssistantStream_classPrivateFieldGet(this,ew,"f")}currentRun(){return AssistantStream_classPrivateFieldGet(this,ev,"f")}currentMessageSnapshot(){return AssistantStream_classPrivateFieldGet(this,em,"f")}currentRunStepSnapshot(){return AssistantStream_classPrivateFieldGet(this,eP,"f")}async finalRunSteps(){return await this.done(),Object.values(AssistantStream_classPrivateFieldGet(this,ep,"f"))}async finalMessages(){return await this.done(),Object.values(AssistantStream_classPrivateFieldGet(this,ed,"f"))}async finalRun(){if(await this.done(),!AssistantStream_classPrivateFieldGet(this,ef,"f"))throw Error("Final run was not received.");return AssistantStream_classPrivateFieldGet(this,ef,"f")}async _createThreadAssistantStream(e,a,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...a,stream:!0},o=await e.createAndRun(i,{...n,signal:this.controller.signal});for await(let e of(this._connected(),o))AssistantStream_classPrivateFieldGet(this,ec,"m",eA).call(this,e);if(o.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(AssistantStream_classPrivateFieldGet(this,ec,"m",eS).call(this))}async _createAssistantStream(e,a,n,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...n,stream:!0},l=await e.create(a,o,{...s,signal:this.controller.signal});for await(let e of(this._connected(),l))AssistantStream_classPrivateFieldGet(this,ec,"m",eA).call(this,e);if(l.controller.signal?.aborted)throw new APIUserAbortError;return this._addRun(AssistantStream_classPrivateFieldGet(this,ec,"m",eS).call(this))}static accumulateDelta(e,a){for(let[n,s]of Object.entries(a)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let a=e[n];if(null==a||"index"===n||"type"===n){e[n]=s;continue}if("string"==typeof a&&"string"==typeof s)a+=s;else if("number"==typeof a&&"number"==typeof s)a+=s;else if(isObj(a)&&isObj(s))a=this.accumulateDelta(a,s);else if(Array.isArray(a)&&Array.isArray(s)){if(a.every(e=>"string"==typeof e||"number"==typeof e)){a.push(...s);continue}}else throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${a}`);e[n]=a}return e}};eA=function(e){if(!this.ended)switch(AssistantStream_classPrivateFieldSet(this,ew,e,"f"),AssistantStream_classPrivateFieldGet(this,ec,"m",eE).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":AssistantStream_classPrivateFieldGet(this,ec,"m",eT).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":AssistantStream_classPrivateFieldGet(this,ec,"m",eO).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":AssistantStream_classPrivateFieldGet(this,ec,"m",eC).call(this,e);break;case"error":throw Error("Encountered an error event in event processing - errors should be processed earlier")}},eS=function(){if(this.ended)throw new error_OpenAIError("stream has ended, this shouldn't happen");if(!AssistantStream_classPrivateFieldGet(this,ef,"f"))throw Error("Final run has not been received");return AssistantStream_classPrivateFieldGet(this,ef,"f")},eC=function(e){let[a,n]=AssistantStream_classPrivateFieldGet(this,ec,"m",eI).call(this,e,AssistantStream_classPrivateFieldGet(this,em,"f"));for(let e of(AssistantStream_classPrivateFieldSet(this,em,a,"f"),AssistantStream_classPrivateFieldGet(this,ed,"f")[a.id]=a,n)){let n=a.content[e.index];n?.type=="text"&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,a),e.data.delta.content)for(let n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,s=a.content[n.index];if(s&&"text"==s.type)this._emit("textDelta",e,s.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(n.index!=AssistantStream_classPrivateFieldGet(this,eg,"f")){if(AssistantStream_classPrivateFieldGet(this,eb,"f"))switch(AssistantStream_classPrivateFieldGet(this,eb,"f").type){case"text":this._emit("textDone",AssistantStream_classPrivateFieldGet(this,eb,"f").text,AssistantStream_classPrivateFieldGet(this,em,"f"));break;case"image_file":this._emit("imageFileDone",AssistantStream_classPrivateFieldGet(this,eb,"f").image_file,AssistantStream_classPrivateFieldGet(this,em,"f"))}AssistantStream_classPrivateFieldSet(this,eg,n.index,"f")}AssistantStream_classPrivateFieldSet(this,eb,a.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==AssistantStream_classPrivateFieldGet(this,eg,"f")){let a=e.data.content[AssistantStream_classPrivateFieldGet(this,eg,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,AssistantStream_classPrivateFieldGet(this,em,"f"));break;case"text":this._emit("textDone",a.text,AssistantStream_classPrivateFieldGet(this,em,"f"))}}AssistantStream_classPrivateFieldGet(this,em,"f")&&this._emit("messageDone",e.data),AssistantStream_classPrivateFieldSet(this,em,void 0,"f")}},eO=function(e){let a=AssistantStream_classPrivateFieldGet(this,ec,"m",ex).call(this,e);switch(AssistantStream_classPrivateFieldSet(this,eP,a,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==a.step_details.type)for(let e of n.step_details.tool_calls)e.index==AssistantStream_classPrivateFieldGet(this,ey,"f")?this._emit("toolCallDelta",e,a.step_details.tool_calls[e.index]):(AssistantStream_classPrivateFieldGet(this,e_,"f")&&this._emit("toolCallDone",AssistantStream_classPrivateFieldGet(this,e_,"f")),AssistantStream_classPrivateFieldSet(this,ey,e.index,"f"),AssistantStream_classPrivateFieldSet(this,e_,a.step_details.tool_calls[e.index],"f"),AssistantStream_classPrivateFieldGet(this,e_,"f")&&this._emit("toolCallCreated",AssistantStream_classPrivateFieldGet(this,e_,"f")));this._emit("runStepDelta",e.data.delta,a);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":AssistantStream_classPrivateFieldSet(this,eP,void 0,"f");let s=e.data.step_details;"tool_calls"==s.type&&AssistantStream_classPrivateFieldGet(this,e_,"f")&&(this._emit("toolCallDone",AssistantStream_classPrivateFieldGet(this,e_,"f")),AssistantStream_classPrivateFieldSet(this,e_,void 0,"f")),this._emit("runStepDone",e.data,a)}},eE=function(e){AssistantStream_classPrivateFieldGet(this,eh,"f").push(e),this._emit("event",e)},ex=function(e){switch(e.event){case"thread.run.step.created":return AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let a=AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id];if(!a)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){let s=AssistantStream.accumulateDelta(a,n.delta);AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id]=s}return AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id]=e.data}if(AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id])return AssistantStream_classPrivateFieldGet(this,ep,"f")[e.data.id];throw Error("No snapshot available")},eI=function(e,a){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!a)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(let e of s.delta.content)if(e.index in a.content){let n=a.content[e.index];a.content[e.index]=AssistantStream_classPrivateFieldGet(this,ec,"m",eR).call(this,e,n)}else a.content[e.index]=e,n.push(e);return[a,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(a)return[a,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},eR=function(e,a){return AssistantStream.accumulateDelta(a,e)},eT=function(e){switch(AssistantStream_classPrivateFieldSet(this,ev,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":AssistantStream_classPrivateFieldSet(this,ef,e.data,"f"),AssistantStream_classPrivateFieldGet(this,e_,"f")&&(this._emit("toolCallDone",AssistantStream_classPrivateFieldGet(this,e_,"f")),AssistantStream_classPrivateFieldSet(this,e_,void 0,"f"))}};let Messages=class Messages extends APIResource{create(e,a,n){return this._client.post(`/threads/${e}/messages`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,a,n){return this._client.get(`/threads/${e}/messages/${a}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,a,n,s){return this._client.post(`/threads/${e}/messages/${a}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,a={},n){return isRequestOptions(a)?this.list(e,{},a):this._client.getAPIList(`/threads/${e}/messages`,MessagesPage,{query:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}};let MessagesPage=class MessagesPage extends CursorPage{};(Messages||(Messages={})).MessagesPage=MessagesPage;let Steps=class Steps extends APIResource{retrieve(e,a,n,s){return this._client.get(`/threads/${e}/runs/${a}/steps/${n}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,a,n={},s){return isRequestOptions(n)?this.list(e,a,{},n):this._client.getAPIList(`/threads/${e}/runs/${a}/steps`,RunStepsPage,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}};let RunStepsPage=class RunStepsPage extends CursorPage{};(Steps||(Steps={})).RunStepsPage=RunStepsPage;let Runs=class Runs extends APIResource{constructor(){super(...arguments),this.steps=new Steps(this._client)}create(e,a,n){return this._client.post(`/threads/${e}/runs`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:a.stream??!1})}retrieve(e,a,n){return this._client.get(`/threads/${e}/runs/${a}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,a,n,s){return this._client.post(`/threads/${e}/runs/${a}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,a={},n){return isRequestOptions(a)?this.list(e,{},a):this._client.getAPIList(`/threads/${e}/runs`,RunsPage,{query:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,a,n){return this._client.post(`/threads/${e}/runs/${a}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,a,n){let s=await this.create(e,a,n);return await this.poll(e,s.id,n)}createAndStream(e,a,n){return AssistantStream.createAssistantStream(e,this._client.beta.threads.runs,a,n)}async poll(e,a,n){let s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let{data:i,response:o}=await this.retrieve(e,a,{...n,headers:{...n?.headers,...s}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let l=5e3;if(n?.pollIntervalMs)l=n.pollIntervalMs;else{let e=o.headers.get("openai-poll-after-ms");if(e){let a=parseInt(e);isNaN(a)||(l=a)}}await sleep(l);break;case"requires_action":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,a,n){return AssistantStream.createAssistantStream(e,this._client.beta.threads.runs,a,n)}submitToolOutputs(e,a,n,s){return this._client.post(`/threads/${e}/runs/${a}/submit_tool_outputs`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,a,n,s){let i=await this.submitToolOutputs(e,a,n,s);return await this.poll(e,i.id,s)}submitToolOutputsStream(e,a,n,s){return AssistantStream.createToolAssistantStream(e,a,this._client.beta.threads.runs,n,s)}};let RunsPage=class RunsPage extends CursorPage{};(_=Runs||(Runs={})).RunsPage=RunsPage,_.Steps=Steps,_.RunStepsPage=RunStepsPage;let Threads=class Threads extends APIResource{constructor(){super(...arguments),this.runs=new Runs(this._client),this.messages=new Messages(this._client)}create(e={},a){return isRequestOptions(e)?this.create({},e):this._client.post("/threads",{body:e,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,a){return this._client.get(`/threads/${e}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,a,n){return this._client.post(`/threads/${e}`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,a){return this._client.delete(`/threads/${e}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}createAndRun(e,a){return this._client.post("/threads/runs",{body:e,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers},stream:e.stream??!1})}async createAndRunPoll(e,a){let n=await this.createAndRun(e,a);return await this.runs.poll(n.thread_id,n.id,a)}createAndRunStream(e,a){return AssistantStream.createThreadAssistantStream(e,this._client.beta.threads,a)}};(w=Threads||(Threads={})).Runs=Runs,w.RunsPage=RunsPage,w.Messages=Messages,w.MessagesPage=MessagesPage;let allSettledWithThrow=async e=>{let a=await Promise.allSettled(e),n=a.filter(e=>"rejected"===e.status);if(n.length){for(let e of n)console.error(e.reason);throw Error(`${n.length} promise(s) failed - see the above errors`)}let s=[];for(let e of a)"fulfilled"===e.status&&s.push(e.value);return s};let files_Files=class files_Files extends APIResource{create(e,a,n){return this._client.post(`/vector_stores/${e}/files`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,a,n){return this._client.get(`/vector_stores/${e}/files/${a}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,a={},n){return isRequestOptions(a)?this.list(e,{},a):this._client.getAPIList(`/vector_stores/${e}/files`,VectorStoreFilesPage,{query:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,a,n){return this._client.delete(`/vector_stores/${e}/files/${a}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,a,n){let s=await this.create(e,a,n);return await this.poll(e,s.id,n)}async poll(e,a,n){let s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let i=await this.retrieve(e,a,{...n,headers:s}).withResponse(),o=i.data;switch(o.status){case"in_progress":let l=5e3;if(n?.pollIntervalMs)l=n.pollIntervalMs;else{let e=i.response.headers.get("openai-poll-after-ms");if(e){let a=parseInt(e);isNaN(a)||(l=a)}}await sleep(l);break;case"failed":case"completed":return o}}}async upload(e,a,n){let s=await this._client.files.create({file:a,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,a,n){let s=await this._client.files.create({file:a,purpose:"assistants"},n);return await this.poll(e,s.id,n)}};let VectorStoreFilesPage=class VectorStoreFilesPage extends CursorPage{};(files_Files||(files_Files={})).VectorStoreFilesPage=VectorStoreFilesPage;let FileBatches=class FileBatches extends APIResource{create(e,a,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,a,n){return this._client.get(`/vector_stores/${e}/file_batches/${a}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,a,n){return this._client.post(`/vector_stores/${e}/file_batches/${a}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,a,n){let s=await this.create(e,a);return await this.poll(e,s.id,n)}listFiles(e,a,n={},s){return isRequestOptions(n)?this.listFiles(e,a,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${a}/files`,VectorStoreFilesPage,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async poll(e,a,n){let s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let{data:i,response:o}=await this.retrieve(e,a,{...n,headers:s}).withResponse();switch(i.status){case"in_progress":let l=5e3;if(n?.pollIntervalMs)l=n.pollIntervalMs;else{let e=o.headers.get("openai-poll-after-ms");if(e){let a=parseInt(e);isNaN(a)||(l=a)}}await sleep(l);break;case"failed":case"completed":return i}}}async uploadAndPoll(e,{files:a,fileIds:n=[]},s){if(null===a||0==a.length)throw Error("No files provided to process.");let i=s?.maxConcurrency??5,o=Math.min(i,a.length),l=this._client,u=a.values(),c=[...n];async function processFiles(e){for(let a of e){let e=await l.files.create({file:a,purpose:"assistants"},s);c.push(e.id)}}let p=Array(o).fill(u).map(processFiles);return await allSettledWithThrow(p),await this.createAndPoll(e,{file_ids:c})}};FileBatches||(FileBatches={});let VectorStores=class VectorStores extends APIResource{constructor(){super(...arguments),this.files=new files_Files(this._client),this.fileBatches=new FileBatches(this._client)}create(e,a){return this._client.post("/vector_stores",{body:e,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,a){return this._client.get(`/vector_stores/${e}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,a,n){return this._client.post(`/vector_stores/${e}`,{body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},a){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/vector_stores",VectorStoresPage,{query:e,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,a){return this._client.delete(`/vector_stores/${e}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}};let VectorStoresPage=class VectorStoresPage extends CursorPage{};(v=VectorStores||(VectorStores={})).VectorStoresPage=VectorStoresPage,v.Files=files_Files,v.VectorStoreFilesPage=VectorStoreFilesPage,v.FileBatches=FileBatches;let Beta=class Beta extends APIResource{constructor(){super(...arguments),this.vectorStores=new VectorStores(this._client),this.chat=new chat_Chat(this._client),this.assistants=new Assistants(this._client),this.threads=new Threads(this._client)}};(P=Beta||(Beta={})).VectorStores=VectorStores,P.VectorStoresPage=VectorStoresPage,P.Chat=chat_Chat,P.Assistants=Assistants,P.AssistantsPage=AssistantsPage,P.Threads=Threads;let Batches=class Batches extends APIResource{create(e,a){return this._client.post("/batches",{body:e,...a})}retrieve(e,a){return this._client.get(`/batches/${e}`,a)}list(e={},a){return isRequestOptions(e)?this.list({},e):this._client.getAPIList("/batches",BatchesPage,{query:e,...a})}cancel(e,a){return this._client.post(`/batches/${e}/cancel`,a)}};let BatchesPage=class BatchesPage extends CursorPage{};(Batches||(Batches={})).BatchesPage=BatchesPage;let openai_OpenAI=class openai_OpenAI extends APIClient{constructor({baseURL:e=readEnv("OPENAI_BASE_URL"),apiKey:a=readEnv("OPENAI_API_KEY"),organization:n=readEnv("OPENAI_ORG_ID")??null,project:s=readEnv("OPENAI_PROJECT_ID")??null,...i}={}){if(void 0===a)throw new error_OpenAIError("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let o={apiKey:a,organization:n,project:s,...i,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&isRunningInBrowser())throw new error_OpenAIError("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new Completions(this),this.chat=new Chat(this),this.embeddings=new embeddings_Embeddings(this),this.files=new Files(this),this.images=new Images(this),this.audio=new Audio(this),this.moderations=new Moderations(this),this.models=new Models(this),this.fineTuning=new FineTuning(this),this.beta=new Beta(this),this.batches=new Batches(this),this._options=o,this.apiKey=a,this.organization=n,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};ek=openai_OpenAI,openai_OpenAI.OpenAI=ek,openai_OpenAI.OpenAIError=error_OpenAIError,openai_OpenAI.APIError=APIError,openai_OpenAI.APIConnectionError=APIConnectionError,openai_OpenAI.APIConnectionTimeoutError=APIConnectionTimeoutError,openai_OpenAI.APIUserAbortError=APIUserAbortError,openai_OpenAI.NotFoundError=NotFoundError,openai_OpenAI.ConflictError=ConflictError,openai_OpenAI.RateLimitError=RateLimitError,openai_OpenAI.BadRequestError=BadRequestError,openai_OpenAI.AuthenticationError=AuthenticationError,openai_OpenAI.InternalServerError=InternalServerError,openai_OpenAI.PermissionDeniedError=PermissionDeniedError,openai_OpenAI.UnprocessableEntityError=UnprocessableEntityError,openai_OpenAI.toFile=toFile,openai_OpenAI.fileFromPath=m;let{OpenAIError:eB,APIError:eU,APIConnectionError:eq,APIConnectionTimeoutError:eG,APIUserAbortError:eK,NotFoundError:eW,ConflictError:eJ,RateLimitError:eH,BadRequestError:eX,AuthenticationError:eQ,InternalServerError:eY,PermissionDeniedError:eZ,UnprocessableEntityError:e0}=ej;(A=openai_OpenAI||(openai_OpenAI={})).Page=Page,A.CursorPage=CursorPage,A.Completions=Completions,A.Chat=Chat,A.Embeddings=embeddings_Embeddings,A.Files=Files,A.FileObjectsPage=FileObjectsPage,A.Images=Images,A.Audio=Audio,A.Moderations=Moderations,A.Models=Models,A.ModelsPage=ModelsPage,A.FineTuning=FineTuning,A.Beta=Beta,A.Batches=Batches,A.BatchesPage=BatchesPage;var e1=n(6261),e2=n(8398),e4=n(2488),e9=n(3478),e3=n(7610),e5=n(7018);let BaseChatModel=class BaseChatModel extends e3.qV{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[a,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[a,n]}async invoke(e,a){let n=BaseChatModel._convertInputToPromptValue(e),s=await this.generatePrompt([n],a,a?.callbacks),i=s.generations[0][0];return i.message}async *_streamResponseChunks(e,a,n){throw Error("Not implemented.")}async *_streamIterator(e,a){if(this._streamResponseChunks===BaseChatModel.prototype._streamResponseChunks)yield this.invoke(e,a);else{let n;let s=BaseChatModel._convertInputToPromptValue(e),i=s.toChatMessages(),[o,l]=this._separateRunnableConfigFromCallOptions(a),u=await e5.Ye.configure(o.callbacks,this.callbacks,o.tags,this.tags,o.metadata,this.metadata,{verbose:this.verbose}),c={options:l,invocation_params:this?.invocationParams(l),batch_size:1},p=await u?.handleChatModelStart(this.toJSON(),[i],o.runId,void 0,c,void 0,void 0,o.runName);try{for await(let e of this._streamResponseChunks(i,l,p?.[0]))e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,n=n?n.concat(e):e}catch(e){throw await Promise.all((p??[]).map(a=>a?.handleLLMError(e))),e}await Promise.all((p??[]).map(e=>e?.handleLLMEnd({generations:[[n]]})))}}async _generateUncached(e,a,n){let s=e.map(e=>e.map(e9.E1)),i=await e5.Ye.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this?.invocationParams(a),batch_size:1},l=await i?.handleChatModelStart(this.toJSON(),s,n.runId,void 0,o,void 0,void 0,n.runName),u=await Promise.allSettled(s.map((e,n)=>this._generate(e,{...a,promptIndex:n},l?.[n]))),c=[],p=[];await Promise.all(u.map(async(e,a)=>{if("fulfilled"!==e.status)return await l?.[a]?.handleLLMError(e.reason),Promise.reject(e.reason);{let n=e.value;for(let e of n.generations)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),c[a]=n.generations,p[a]=n.llmOutput,l?.[a]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}}));let d={generations:c,llmOutput:p.length?this._combineLLMOutput?.(...p):void 0};return Object.defineProperty(d,e2.WH,{value:l?{runIds:l?.map(e=>e.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:a,llmStringKey:n,parsedOptions:s,handledOptions:i}){let o=e.map(e=>e.map(e9.E1)),l=await e5.Ye.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),u={options:s,invocation_params:this?.invocationParams(s),batch_size:1,cached:!0},c=await l?.handleChatModelStart(this.toJSON(),o,i.runId,void 0,u,void 0,void 0,i.runName),p=[],d=await Promise.allSettled(o.map(async(e,s)=>{let i=BaseChatModel._convertInputToPromptValue(e).toString(),o=await a.lookup(i,n);return null==o&&p.push(s),o})),m=d.map((e,a)=>({result:e,runManager:c?.[a]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),f=[];await Promise.all(m.map(async({result:e,runManager:a},n)=>{if("fulfilled"!==e.status)return await a?.handleLLMError(e.reason),Promise.reject(e.reason);{let s=e.value;return f[n]=s,s.length&&await a?.handleLLMNewToken(s[0].text),a?.handleLLMEnd({generations:[s]})}}));let g={generations:f,missingPromptIndices:p};return Object.defineProperty(g,e2.WH,{value:c?{runIds:c?.map(e=>e.runId)}:void 0,configurable:!0}),g}async generate(e,a,n){let s;s=Array.isArray(a)?{stop:a}:a;let i=e.map(e=>e.map(e9.E1)),[o,l]=this._separateRunnableConfigFromCallOptions(s);if(o.callbacks=o.callbacks??n,!this.cache)return this._generateUncached(i,l,o);let{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(l),{generations:p,missingPromptIndices:d}=await this._generateCached({messages:i,cache:u,llmStringKey:c,parsedOptions:l,handledOptions:o}),m={};if(d.length>0){let e=await this._generateUncached(d.map(e=>i[e]),l,o);await Promise.all(e.generations.map(async(e,a)=>{let n=d[a];p[n]=e;let s=BaseChatModel._convertInputToPromptValue(i[n]).toString();return u.update(s,c,e)})),m=e.llmOutput??{}}return{generations:p,llmOutput:m}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,a,n){let s=e.map(e=>e.toChatMessages());return this.generate(s,a,n)}async call(e,a,n){let s=await this.generate([e.map(e9.E1)],a,n),i=s.generations;return i[0][0].message}async callPrompt(e,a,n){let s=e.toChatMessages();return this.call(s,a,n)}async predictMessages(e,a,n){return this.call(e,a,n)}async predict(e,a,n){let s=new e9.xk(e),i=await this.call([s],a,n);if("string"!=typeof i.content)throw Error("Cannot use predict when output is not a string.");return i.content}};var e8=n(6896),e6=n(3102),e7=n(7846),te=n(9073),tt=n(4559);function parseToolCall(e,a){let n;if(void 0===e.function)return;if(a?.partial)try{n=(0,tt.gP)(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(a){throw new te.dS([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join("\n"))}let s={name:e.function.name,args:n};return a?.returnId&&(s.id=e.id),s}function convertLangChainToolCallToOpenAI(e){if(void 0===e.id)throw Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function makeInvalidToolCall(e,a){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:a}}let JsonOutputToolsParser=class JsonOutputToolsParser extends te.tw{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){let a=e[0].message.additional_kwargs.tool_calls;if(!a)throw Error(`No tools_call in message ${JSON.stringify(e)}`);let n=JSON.parse(JSON.stringify(a)),s=[];for(let e of n){let a=parseToolCall(e,{partial:!0});if(void 0!==a){let e={type:a.name,args:a.args,id:a.id};Object.defineProperty(e,"name",{get(){return this.type}}),Object.defineProperty(e,"arguments",{get(){return this.args}}),s.push(e)}}return s}};let JsonOutputKeyToolsParser=class JsonOutputKeyToolsParser extends te.tw{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new JsonOutputToolsParser(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let a=await this.zodSchema.safeParseAsync(e);if(a.success)return a.data;throw new te.dS(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(a.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let a=await this.initialParser.parseResult(e),n=a.filter(e=>e.type===this.keyName),s=n;if(this.returnId||(s=n.map(e=>e.args)),this.returnSingle)return this._validateResult(s[0]);let i=await Promise.all(s.map(e=>this._validateResult(e)));return i}};var tr=n(9711);function azure_getEndpoint(e){let{azureOpenAIApiDeploymentName:a,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:s,azureOpenAIBasePath:i,baseURL:o}=e;if(s&&i&&a)return`${i}/${a}`;if(s){if(!n)throw Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!a)throw Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${a}`}return o}function openai_wrapOpenAIClientError(e){let a;return e.constructor.name===eG.name?(a=Error(e.message)).name="TimeoutError":e.constructor.name===eK.name?(a=Error(e.message)).name="AbortError":a=e,a}function isAnyOfProp(e){return void 0!==e.anyOf&&Array.isArray(e.anyOf)}function formatFunctionDefinitions(e){let a=["namespace functions {",""];for(let n of e)n.description&&a.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(a.push(`type ${n.name} = (_: {`),a.push(formatObjectProperties(n.parameters,0)),a.push("}) => any;")):a.push(`type ${n.name} = () => any;`),a.push("");return a.push("} // namespace functions"),a.join("\n")}function formatObjectProperties(e,a){let n=[];for(let[s,i]of Object.entries(e.properties??{}))i.description&&a<2&&n.push(`// ${i.description}`),e.required?.includes(s)?n.push(`${s}: ${formatType(i,a)},`):n.push(`${s}?: ${formatType(i,a)},`);return n.map(e=>" ".repeat(a)+e).join("\n")}function formatType(e,a){if(isAnyOfProp(e))return e.anyOf.map(e=>formatType(e,a)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",formatObjectProperties(e,a+2),"}"].join("\n");case"array":if(e.items)return`${formatType(e.items,a)}[]`;return"any[]";default:return""}}function extractGenericMessageCustomRole(e){return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}function messageToOpenAIRole(e){let a=e._getType();switch(a){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!e1.J.isInstance(e))throw Error("Invalid generic chat message");return extractGenericMessageCustomRole(e);default:throw Error(`Unknown message type: ${a}`)}}function openAIResponseToChatMessage(e){let a=e.tool_calls;if("assistant"===e.role){let n=[],s=[];for(let e of a??[])try{n.push(parseToolCall(e,{returnId:!0}))}catch(a){s.push(makeInvalidToolCall(e,a.message))}return new e1.gY({content:e.content||"",tool_calls:n,invalid_tool_calls:s,additional_kwargs:{function_call:e.function_call,tool_calls:a}})}return new e1.J(e.content||"",e.role??"unknown")}function _convertDeltaToMessageChunk(e,a){let n;let s=e.role??a,i=e.content??"";if(n=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===s)return new e1.ro({content:i});if("assistant"===s){let a=[];if(Array.isArray(e.tool_calls))for(let n of e.tool_calls)a.push({name:n.function?.name,args:n.function?.arguments,id:n.id,index:n.index});return new e1.GC({content:i,tool_call_chunks:a,additional_kwargs:n})}return"system"===s?new e1.xq({content:i}):"function"===s?new e1.Cr({content:i,additional_kwargs:n,name:e.name}):"tool"===s?new e1.Xz({content:i,additional_kwargs:n,tool_call_id:e.tool_call_id}):new e1.HD({content:i,role:s})}function convertMessagesToOpenAIParams(e){return e.map(e=>{let a={role:messageToOpenAIRole(e),content:e.content};return null!=e.name&&(a.name=e.name),null!=e.additional_kwargs.function_call&&(a.function_call=e.additional_kwargs.function_call),(0,e1.Z0)(e)&&e.tool_calls?.length?a.tool_calls=e.tool_calls.map(convertLangChainToolCallToOpenAI):(null!=e.additional_kwargs.tool_calls&&(a.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(a.tool_call_id=e.tool_call_id)),a})}let chat_models_ChatOpenAI=class chat_models_ChatOpenAI extends BaseChatModel{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,a){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??(0,e4.lS)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,e4.lS)("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.apiKey)throw Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,e4.lS)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??(0,e4.lS)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,e4.lS)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,e4.lS)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,e4.lS)("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:a?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:a?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:a?.baseOptions?.params??e?.configuration?.baseOptions?.params,...a,...e?.configuration}}bindTools(e,a){return this.bind({tools:e.map(e8.VE),...a})}invocationParams(e){function isStructuredToolArray(e){return void 0!==e&&e.every(e=>Array.isArray(e.lc_namespace))}let a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:isStructuredToolArray(e?.tools)?e?.tools.map(e8.VE):e?.tools,tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...this.modelKwargs};return a}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,a,n){let s;let i=convertMessagesToOpenAIParams(e),o={...this.invocationParams(a),messages:i,stream:!0},l=await this.completionWithRetry(o,a);for await(let e of l){let i=e?.choices[0];if(!i)continue;let{delta:o}=i;if(!o)continue;let l=_convertDeltaToMessageChunk(o,s);s=o.role??s;let u={prompt:a.promptIndex??0,completion:i.index??0};if("string"!=typeof l.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let c={...u};void 0!==i.finish_reason&&(c.finish_reason=i.finish_reason),this.logprobs&&(c.logprobs=i.logprobs);let p=new e2.Ls({message:l,text:l.content,generationInfo:c});yield p,n?.handleLLMNewToken(p.text??"",u,void 0,void 0,void 0,{chunk:p})}if(a.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,a,n){let s={},i=this.invocationParams(a),o=convertMessagesToOpenAIParams(e);if(i.stream){let i=this._streamResponseChunks(e,a,n),o={};for await(let e of i){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};let a=e.generationInfo?.completion??0;void 0===o[a]?o[a]=e:o[a]=o[a].concat(e)}let l=Object.entries(o).sort(([e],[a])=>parseInt(e,10)-parseInt(a,10)).map(([e,a])=>a),{functions:u,function_call:c}=this.invocationParams(a),p=await this.getEstimatedTokenCountFromPrompt(e,u,c),d=await this.getNumTokensFromGenerations(l);return s.promptTokens=p,s.completionTokens=d,s.totalTokens=p+d,{generations:l,llmOutput:{estimatedTokenUsage:s}}}{let e=await this.completionWithRetry({...i,stream:!1,messages:o},{signal:a?.signal,...a?.options}),{completion_tokens:n,prompt_tokens:l,total_tokens:u}=e?.usage??{};n&&(s.completionTokens=(s.completionTokens??0)+n),l&&(s.promptTokens=(s.promptTokens??0)+l),u&&(s.totalTokens=(s.totalTokens??0)+u);let c=[];for(let a of e?.choices??[]){let e=a.message?.content??"",n={text:e,message:openAIResponseToChatMessage(a.message??{role:"assistant"})};n.generationInfo={...a.finish_reason?{finish_reason:a.finish_reason}:{},...a.logprobs?{logprobs:a.logprobs}:{}},c.push(n)}return{generations:c,llmOutput:{tokenUsage:s}}}}async getEstimatedTokenCountFromPrompt(e,a,n){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(a&&"auto"!==n){let e=formatFunctionDefinitions(a);s+=await this.getNumTokens(e)+9}return a&&e.find(e=>"system"===e._getType())&&(s-=4),"none"===n?s+=1:"object"==typeof n&&(s+=await this.getNumTokens(n.name)+4),s}async getNumTokensFromGenerations(e){let a=await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)));return a.reduce((e,a)=>e+a,0)}async getNumTokensFromMessages(e){let a=0,n=0,s=0;"gpt-3.5-turbo-0301"===this.model?(n=4,s=-1):(n=3,s=1);let i=await Promise.all(e.map(async e=>{let i=await this.getNumTokens(e.content),o=await this.getNumTokens(messageToOpenAIRole(e)),l=void 0!==e.name?s+await this.getNumTokens(e.name):0,u=i+n+o+l;if("function"===e._getType()&&(u-=2),e.additional_kwargs?.function_call&&(u+=3),e?.additional_kwargs.function_call?.name&&(u+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))}catch(a){console.error("Error parsing function arguments",a,JSON.stringify(e.additional_kwargs.function_call)),u+=await this.getNumTokens(e.additional_kwargs.function_call?.arguments)}return a+=u,u}));return{totalCount:a+=3,countPerMessage:i}}async completionWithRetry(e,a){let n=this._getClientOptions(a);return this.caller.call(async()=>{try{let a=await this.client.chat.completions.create(e,n);return a}catch(a){let e=openai_wrapOpenAIClientError(a);throw e}})}_getClientOptions(e){if(!this.client){let e={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},a=azure_getEndpoint(e),n={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};n.baseURL||delete n.baseURL,this.client=new openai_OpenAI(n)}let a={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(a.headers={"api-key":this.azureOpenAIApiKey,...a.headers},a.query={"api-version":this.azureOpenAIApiVersion,...a.query}),a}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,a)=>(a&&a.tokenUsage&&(e.tokenUsage.completionTokens+=a.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=a.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=a.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,a){let n,s,i,o,l,u;if(isStructuredOutputMethodParams(e)?(n=e.schema,s=e.name,i=e.method,o=e.includeRaw):(n=e,s=a?.name,i=a?.method,o=a?.includeRaw),"jsonMode"===i)l=this.bind({response_format:{type:"json_object"}}),u=isZodSchema(n)?e7.K.fromZodSchema(n):new e7.Qh;else{let e=s??"extract";if(isZodSchema(n)){let a=(0,tr.Y_)(n);l=this.bind({tools:[{type:"function",function:{name:e,description:a.description,parameters:a}}],tool_choice:{type:"function",function:{name:e}}}),u=new JsonOutputKeyToolsParser({returnSingle:!0,keyName:e,zodSchema:n})}else{let a;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(a=n,e=n.name):a={name:e=n.title??e,description:n.description??"",parameters:n},l=this.bind({tools:[{type:"function",function:a}],tool_choice:{type:"function",function:{name:e}}}),u=new JsonOutputKeyToolsParser({returnSingle:!0,keyName:e})}}if(!o)return l.pipe(u);let c=e6.sk.assign({parsed:(e,a)=>u.invoke(e.raw,a)}),p=e6.sk.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[p]});return e6.lW.from([{raw:l},d])}};function isZodSchema(e){return"function"==typeof e?.parse}function isStructuredOutputMethodParams(e){return void 0!==e&&"object"==typeof e.schema}n(8463),n(3830);var ta=n(1907);let DallEAPIWrapper=class DallEAPIWrapper extends ta.UA{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let a=e?.apiKey??e?.openAIApiKey??(0,e4.lS)("OPENAI_API_KEY"),n=e?.organization??(0,e4.lS)("OPENAI_ORGANIZATION");this.client=new openai_OpenAI({apiKey:a,organization:n,dangerouslyAllowBrowser:!0}),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){let a=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user}),n="";return"url"===this.responseFormat?[n]=a.data.map(e=>e.url).filter(e=>"undefined"!==e):[n]=a.data.map(e=>e.b64_json).filter(e=>"undefined"!==e),n}};Object.defineProperty(DallEAPIWrapper,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"})},1739:function(e,a,n){"use strict";n.d(a,{wn:function(){return g}});var s=n(8249),i={code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},o={code:"1",name:"function_call",parse:e=>{if(null==e||"object"!=typeof e||!("function_call"in e)||"object"!=typeof e.function_call||null==e.function_call||!("name"in e.function_call)||!("arguments"in e.function_call)||"string"!=typeof e.function_call.name||"string"!=typeof e.function_call.arguments)throw Error('"function_call" parts expect an object with a "function_call" property.');return{type:"function_call",value:e}}},l={code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw Error('"data" parts expect an array value.');return{type:"data",value:e}}},u={code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},c={code:"4",name:"assistant_message",parse:e=>{if(null==e||"object"!=typeof e||!("id"in e)||!("role"in e)||!("content"in e)||"string"!=typeof e.id||"string"!=typeof e.role||"assistant"!==e.role||!Array.isArray(e.content)||!e.content.every(e=>null!=e&&"object"==typeof e&&"type"in e&&"text"===e.type&&"text"in e&&null!=e.text&&"object"==typeof e.text&&"value"in e.text&&"string"==typeof e.text.value))throw Error('"assistant_message" parts expect an object with an "id", "role", and "content" property.');return{type:"assistant_message",value:e}}},p={code:"5",name:"assistant_control_data",parse:e=>{if(null==e||"object"!=typeof e||!("threadId"in e)||!("messageId"in e)||"string"!=typeof e.threadId||"string"!=typeof e.messageId)throw Error('"assistant_control_data" parts expect an object with a "threadId" and "messageId" property.');return{type:"assistant_control_data",value:{threadId:e.threadId,messageId:e.messageId}}}},d={code:"6",name:"data_message",parse:e=>{if(null==e||"object"!=typeof e||!("role"in e)||!("data"in e)||"string"!=typeof e.role||"data"!==e.role)throw Error('"data_message" parts expect an object with a "role" and "data" property.');return{type:"data_message",value:e}}},m={code:"7",name:"tool_calls",parse:e=>{if(null==e||"object"!=typeof e||!("tool_calls"in e)||"object"!=typeof e.tool_calls||null==e.tool_calls||!Array.isArray(e.tool_calls)||e.tool_calls.some(e=>{null!=e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id&&"type"in e&&"string"==typeof e.type&&"function"in e&&null!=e.function&&"object"==typeof e.function&&"arguments"in e.function&&"string"==typeof e.function.name&&e.function.arguments}))throw Error('"tool_calls" parts expect an object with a ToolCallPayload.');return{type:"tool_calls",value:e}}},f={code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}};i.code,o.code,l.code,u.code,c.code,p.code,d.code,m.code,f.code,i.name,i.code,o.name,o.code,l.name,l.code,u.name,u.code,c.name,c.code,p.name,p.code,d.name,d.code,m.name,m.code,f.name,f.code,[i,o,l,u,c,p,d,m,f].map(e=>e.code),(0,s.k)("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7),new TextDecoder("utf-8"),Symbol("internal_openai_fn_messages");var g=class extends Response{constructor(e,a,n){let s=e;n&&(s=e.pipeThrough(n.stream)),super(s,{...a,status:200,headers:{"Content-Type":"text/plain; charset=utf-8","X-Experimental-Stream-Data":n?"true":"false",...null==a?void 0:a.headers}})}}},9781:function(e,a,n){"use strict";n.d(a,{RJ:function(){return useChat}});var s,i=n(1798),o=n(5647);let noop=()=>{},l=noop(),u=Object,isUndefined=e=>e===l,isFunction=e=>"function"==typeof e,mergeObjects=(e,a)=>({...e,...a}),isPromiseLike=e=>isFunction(e.then),c=new WeakMap,p=0,stableHash=e=>{let a,n;let s=typeof e,i=e&&e.constructor,o=i==Date;if(u(e)!==e||o||i==RegExp)a=o?e.toJSON():"symbol"==s?e.toString():"string"==s?JSON.stringify(e):""+e;else{if(a=c.get(e))return a;if(a=++p+"~",c.set(e,a),i==Array){for(n=0,a="@";n<e.length;n++)a+=stableHash(e[n])+",";c.set(e,a)}if(i==u){a="#";let s=u.keys(e).sort();for(;!isUndefined(n=s.pop());)isUndefined(e[n])||(a+=n+":"+stableHash(e[n])+",");c.set(e,a)}}return a},d=new WeakMap,m={},f={},g="undefined",b=typeof window!=g,y=typeof document!=g,hasRequestAnimationFrame=()=>b&&typeof window.requestAnimationFrame!=g,createCacheHelper=(e,a)=>{let n=d.get(e);return[()=>!isUndefined(a)&&e.get(a)||m,s=>{if(!isUndefined(a)){let i=e.get(a);a in f||(f[a]=i),n[5](a,mergeObjects(i,s),i||m)}},n[6],()=>!isUndefined(a)&&a in f?f[a]:!isUndefined(a)&&e.get(a)||m]},_=!0,[w,v]=b&&window.addEventListener?[window.addEventListener.bind(window),window.removeEventListener.bind(window)]:[noop,noop],P={initFocus:e=>(y&&document.addEventListener("visibilitychange",e),w("focus",e),()=>{y&&document.removeEventListener("visibilitychange",e),v("focus",e)}),initReconnect:e=>{let onOnline=()=>{_=!0,e()},onOffline=()=>{_=!1};return w("online",onOnline),w("offline",onOffline),()=>{v("online",onOnline),v("offline",onOffline)}}},A=!i.useId,S=!b||"Deno"in window,rAF=e=>hasRequestAnimationFrame()?window.requestAnimationFrame(e):setTimeout(e,1),C=S?i.useEffect:i.useLayoutEffect,O="undefined"!=typeof navigator&&navigator.connection,E=!S&&O&&(["slow-2g","2g"].includes(O.effectiveType)||O.saveData),dist_serialize=e=>{if(isFunction(e))try{e=e()}catch(a){e=""}let a=e;return[e="string"==typeof e?e:(Array.isArray(e)?e.length:e)?stableHash(e):"",a]},x=0,getTimestamp=()=>++x;var I={ERROR_REVALIDATE_EVENT:3,FOCUS_EVENT:0,MUTATE_EVENT:2,RECONNECT_EVENT:1};async function internalMutate(...e){let[a,n,s,i]=e,o=mergeObjects({populateCache:!0,throwOnError:!0},"boolean"==typeof i?{revalidate:i}:i||{}),u=o.populateCache,c=o.rollbackOnError,p=o.optimisticData,m=!1!==o.revalidate,rollbackOnError=e=>"function"==typeof c?c(e):!1!==c,f=o.throwOnError;if(isFunction(n)){let e=[],s=a.keys();for(let i of s)!/^\$(inf|sub)\$/.test(i)&&n(a.get(i)._k)&&e.push(i);return Promise.all(e.map(mutateByKey))}return mutateByKey(n);async function mutateByKey(n){let i;let[o]=dist_serialize(n);if(!o)return;let[c,g]=createCacheHelper(a,o),[b,y,_,w]=d.get(a),v=b[o],startRevalidate=()=>m&&(delete _[o],delete w[o],v&&v[0])?v[0](2).then(()=>c().data):c().data;if(e.length<3)return startRevalidate();let P=s,A=getTimestamp();y[o]=[A,0];let S=!isUndefined(p),C=c(),O=C.data,E=C._c,x=isUndefined(E)?O:E;if(S&&g({data:p=isFunction(p)?p(x,O):p,_c:x}),isFunction(P))try{P=P(x)}catch(e){i=e}if(P&&isPromiseLike(P)){if(P=await P.catch(e=>{i=e}),A!==y[o][0]){if(i)throw i;return P}i&&S&&rollbackOnError(i)&&(u=!0,g({data:P=x,_c:l}))}u&&!i&&(isFunction(u)&&(P=u(P,x)),g({data:P,error:l,_c:l})),y[o][1]=getTimestamp();let I=await startRevalidate();if(g({_c:l}),i){if(f)throw i;return}return u?I:P}}let revalidateAllKeys=(e,a)=>{for(let n in e)e[n][0]&&e[n][0](a)},initCache=(e,a)=>{if(!d.has(e)){let n=mergeObjects(P,a),s={},i=internalMutate.bind(l,e),o=noop,u={},subscribe=(e,a)=>{let n=u[e]||[];return u[e]=n,n.push(a),()=>n.splice(n.indexOf(a),1)},setter=(a,n,s)=>{e.set(a,n);let i=u[a];if(i)for(let e of i)e(n,s)},initProvider=()=>{if(!d.has(e)&&(d.set(e,[s,{},{},{},i,setter,subscribe]),!S)){let a=n.initFocus(setTimeout.bind(l,revalidateAllKeys.bind(l,s,0))),i=n.initReconnect(setTimeout.bind(l,revalidateAllKeys.bind(l,s,1)));o=()=>{a&&a(),i&&i(),d.delete(e)}}};return initProvider(),[e,i,initProvider,o]}return[e,d.get(e)[4]]},[R,T]=initCache(new Map),k=mergeObjects({onLoadingSlow:noop,onSuccess:noop,onError:noop,onErrorRetry:(e,a,n,s,i)=>{let o=n.errorRetryCount,l=i.retryCount,u=~~((Math.random()+.5)*(1<<(l<8?l:8)))*n.errorRetryInterval;(isUndefined(o)||!(l>o))&&setTimeout(s,u,i)},onDiscarded:noop,revalidateOnFocus:!0,revalidateOnReconnect:!0,revalidateIfStale:!0,shouldRetryOnError:!0,errorRetryInterval:E?1e4:5e3,focusThrottleInterval:5e3,dedupingInterval:2e3,loadingTimeout:E?5e3:3e3,compare:(e,a)=>stableHash(e)==stableHash(a),isPaused:()=>!1,cache:R,mutate:T,fallback:{}},{isOnline:()=>_,isVisible:()=>{let e=y&&document.visibilityState;return isUndefined(e)||"hidden"!==e}}),mergeConfigs=(e,a)=>{let n=mergeObjects(e,a);if(a){let{use:s,fallback:i}=e,{use:o,fallback:l}=a;s&&o&&(n.use=s.concat(o)),i&&l&&(n.fallback=mergeObjects(i,l))}return n},j=(0,i.createContext)({}),F=b&&window.__SWR_DEVTOOLS_USE__,M=F?window.__SWR_DEVTOOLS_USE__:[],normalize=e=>isFunction(e[1])?[e[0],e[1],e[2]||{}]:[e[0],null,(null===e[1]?e[2]:e[1])||{}],useSWRConfig=()=>mergeObjects(k,(0,i.useContext)(j)),N=M.concat(e=>(a,n,s)=>{let i=n&&((...e)=>{let[s]=dist_serialize(a),[,,,i]=d.get(R),o=i[s];return isUndefined(o)?n(...e):(delete i[s],o)});return e(a,i,s)}),subscribeCallback=(e,a,n)=>{let s=a[e]||(a[e]=[]);return s.push(n),()=>{let e=s.indexOf(n);e>=0&&(s[e]=s[s.length-1],s.pop())}};F&&(window.__SWR_DEVTOOLS_REACT__=i);let L=i.use||(e=>{if("pending"===e.status)throw e;if("fulfilled"===e.status)return e.value;if("rejected"===e.status)throw e.reason;throw e.status="pending",e.then(a=>{e.status="fulfilled",e.value=a},a=>{e.status="rejected",e.reason=a}),e}),$={dedupe:!0};u.defineProperty(e=>{let{value:a}=e,n=(0,i.useContext)(j),s=isFunction(a),o=(0,i.useMemo)(()=>s?a(n):a,[s,n,a]),u=(0,i.useMemo)(()=>s?o:mergeConfigs(n,o),[s,n,o]),c=o&&o.provider,p=(0,i.useRef)(l);c&&!p.current&&(p.current=initCache(c(u.cache||R),o));let d=p.current;return d&&(u.cache=d[0],u.mutate=d[1]),C(()=>{if(d)return d[2]&&d[2](),d[3]},[]),(0,i.createElement)(j.Provider,mergeObjects(e,{value:u}))},"defaultValue",{value:k});let z=(s=(e,a,n)=>{let{cache:s,compare:u,suspense:c,fallbackData:p,revalidateOnMount:m,revalidateIfStale:f,refreshInterval:g,refreshWhenHidden:b,refreshWhenOffline:y,keepPreviousData:_}=n,[w,v,P,O]=d.get(s),[E,x]=dist_serialize(e),R=(0,i.useRef)(!1),T=(0,i.useRef)(!1),k=(0,i.useRef)(E),j=(0,i.useRef)(a),F=(0,i.useRef)(n),getConfig=()=>F.current,isActive=()=>getConfig().isVisible()&&getConfig().isOnline(),[M,N,z,V]=createCacheHelper(s,E),D=(0,i.useRef)({}).current,B=isUndefined(p)?n.fallback[E]:p,isEqual=(e,a)=>{for(let n in D)if("data"===n){if(!u(e[n],a[n])&&(!isUndefined(e[n])||!u(Y,a[n])))return!1}else if(a[n]!==e[n])return!1;return!0},U=(0,i.useMemo)(()=>{let e=!!E&&!!a&&(isUndefined(m)?!getConfig().isPaused()&&!c&&(!!isUndefined(f)||f):m),getSelectedCache=a=>{let n=mergeObjects(a);return(delete n._k,e)?{isValidating:!0,isLoading:!0,...n}:n},n=M(),s=V(),i=getSelectedCache(n),o=n===s?i:getSelectedCache(s),l=i;return[()=>{let e=getSelectedCache(M()),a=isEqual(e,l);return a?(l.data=e.data,l.isLoading=e.isLoading,l.isValidating=e.isValidating,l.error=e.error,l):(l=e,e)},()=>o]},[s,E]),G=(0,o.useSyncExternalStore)((0,i.useCallback)(e=>z(E,(a,n)=>{isEqual(n,a)||e()}),[s,E]),U[0],U[1]),K=!R.current,W=w[E]&&w[E].length>0,J=G.data,H=isUndefined(J)?B:J,X=G.error,Q=(0,i.useRef)(H),Y=_?isUndefined(J)?Q.current:J:H,Z=(!W||!!isUndefined(X))&&(K&&!isUndefined(m)?m:!getConfig().isPaused()&&(c?!isUndefined(H)&&f:isUndefined(H)||f)),ee=!!(E&&a&&K&&Z),et=isUndefined(G.isValidating)?ee:G.isValidating,er=isUndefined(G.isLoading)?ee:G.isLoading,ea=(0,i.useCallback)(async e=>{let a,s;let i=j.current;if(!E||!i||T.current||getConfig().isPaused())return!1;let o=!0,c=e||{},p=!P[E]||!c.dedupe,callbackSafeguard=()=>A?!T.current&&E===k.current&&R.current:E===k.current,d={isValidating:!1,isLoading:!1},finishRequestAndUpdateState=()=>{N(d)},cleanupState=()=>{let e=P[E];e&&e[1]===s&&delete P[E]},m={isValidating:!0};isUndefined(M().data)&&(m.isLoading=!0);try{if(p&&(N(m),n.loadingTimeout&&isUndefined(M().data)&&setTimeout(()=>{o&&callbackSafeguard()&&getConfig().onLoadingSlow(E,n)},n.loadingTimeout),P[E]=[i(x),getTimestamp()]),[a,s]=P[E],a=await a,p&&setTimeout(cleanupState,n.dedupingInterval),!P[E]||P[E][1]!==s)return p&&callbackSafeguard()&&getConfig().onDiscarded(E),!1;d.error=l;let e=v[E];if(!isUndefined(e)&&(s<=e[0]||s<=e[1]||0===e[1]))return finishRequestAndUpdateState(),p&&callbackSafeguard()&&getConfig().onDiscarded(E),!1;let c=M().data;d.data=u(c,a)?c:a,p&&callbackSafeguard()&&getConfig().onSuccess(a,E,n)}catch(n){cleanupState();let e=getConfig(),{shouldRetryOnError:a}=e;!e.isPaused()&&(d.error=n,p&&callbackSafeguard()&&(e.onError(n,E,e),(!0===a||isFunction(a)&&a(n))&&isActive()&&e.onErrorRetry(n,E,e,e=>{let a=w[E];a&&a[0]&&a[0](I.ERROR_REVALIDATE_EVENT,e)},{retryCount:(c.retryCount||0)+1,dedupe:!0})))}return o=!1,finishRequestAndUpdateState(),!0},[E,s]),en=(0,i.useCallback)((...e)=>internalMutate(s,k.current,...e),[]);if(C(()=>{j.current=a,F.current=n,isUndefined(J)||(Q.current=J)}),C(()=>{if(!E)return;let e=ea.bind(l,$),a=0,n=subscribeCallback(E,w,(n,s={})=>{if(n==I.FOCUS_EVENT){let n=Date.now();getConfig().revalidateOnFocus&&n>a&&isActive()&&(a=n+getConfig().focusThrottleInterval,e())}else if(n==I.RECONNECT_EVENT)getConfig().revalidateOnReconnect&&isActive()&&e();else if(n==I.MUTATE_EVENT)return ea();else if(n==I.ERROR_REVALIDATE_EVENT)return ea(s)});return T.current=!1,k.current=E,R.current=!0,N({_k:x}),Z&&(isUndefined(H)||S?e():rAF(e)),()=>{T.current=!0,n()}},[E]),C(()=>{let e;function next(){let a=isFunction(g)?g(M().data):g;a&&-1!==e&&(e=setTimeout(execute,a))}function execute(){!M().error&&(b||getConfig().isVisible())&&(y||getConfig().isOnline())?ea($).then(next):next()}return next(),()=>{e&&(clearTimeout(e),e=-1)}},[g,b,y,E]),(0,i.useDebugValue)(Y),c&&isUndefined(H)&&E){if(!A&&S)throw Error("Fallback data is required when using suspense in SSR.");j.current=a,F.current=n,T.current=!1;let e=O[E];if(!isUndefined(e)){let a=en(e);L(a)}if(isUndefined(X)){let e=ea($);isUndefined(Y)||(e.status="fulfilled",e.value=!0),L(e)}else throw X}return{mutate:en,get data(){return D.data=!0,Y},get error(){return D.error=!0,X},get isValidating(){return D.isValidating=!0,et},get isLoading(){return D.isLoading=!0,er}}},function(...e){let a=useSWRConfig(),[n,i,o]=normalize(e),l=mergeConfigs(a,o),u=s,{use:c}=l,p=(c||[]).concat(N);for(let e=p.length;e--;)u=p[e](u);return u(n,i||l.fetcher||null,l)});var V=n(8249),D={code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},B={code:"1",name:"function_call",parse:e=>{if(null==e||"object"!=typeof e||!("function_call"in e)||"object"!=typeof e.function_call||null==e.function_call||!("name"in e.function_call)||!("arguments"in e.function_call)||"string"!=typeof e.function_call.name||"string"!=typeof e.function_call.arguments)throw Error('"function_call" parts expect an object with a "function_call" property.');return{type:"function_call",value:e}}},U={code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw Error('"data" parts expect an array value.');return{type:"data",value:e}}},G={code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},K={code:"4",name:"assistant_message",parse:e=>{if(null==e||"object"!=typeof e||!("id"in e)||!("role"in e)||!("content"in e)||"string"!=typeof e.id||"string"!=typeof e.role||"assistant"!==e.role||!Array.isArray(e.content)||!e.content.every(e=>null!=e&&"object"==typeof e&&"type"in e&&"text"===e.type&&"text"in e&&null!=e.text&&"object"==typeof e.text&&"value"in e.text&&"string"==typeof e.text.value))throw Error('"assistant_message" parts expect an object with an "id", "role", and "content" property.');return{type:"assistant_message",value:e}}},W={code:"5",name:"assistant_control_data",parse:e=>{if(null==e||"object"!=typeof e||!("threadId"in e)||!("messageId"in e)||"string"!=typeof e.threadId||"string"!=typeof e.messageId)throw Error('"assistant_control_data" parts expect an object with a "threadId" and "messageId" property.');return{type:"assistant_control_data",value:{threadId:e.threadId,messageId:e.messageId}}}},J={code:"6",name:"data_message",parse:e=>{if(null==e||"object"!=typeof e||!("role"in e)||!("data"in e)||"string"!=typeof e.role||"data"!==e.role)throw Error('"data_message" parts expect an object with a "role" and "data" property.');return{type:"data_message",value:e}}},H={code:"7",name:"tool_calls",parse:e=>{if(null==e||"object"!=typeof e||!("tool_calls"in e)||"object"!=typeof e.tool_calls||null==e.tool_calls||!Array.isArray(e.tool_calls)||e.tool_calls.some(e=>{null!=e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id&&"type"in e&&"string"==typeof e.type&&"function"in e&&null!=e.function&&"object"==typeof e.function&&"arguments"in e.function&&"string"==typeof e.function.name&&e.function.arguments}))throw Error('"tool_calls" parts expect an object with a ToolCallPayload.');return{type:"tool_calls",value:e}}},X={code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}},Q={[D.code]:D,[B.code]:B,[U.code]:U,[G.code]:G,[K.code]:K,[W.code]:W,[J.code]:J,[H.code]:H,[X.code]:X};D.name,D.code,B.name,B.code,U.name,U.code,G.name,G.code,K.name,K.code,W.name,W.code,J.name,J.code,H.name,H.code,X.name,X.code;var Y=[D,B,U,G,K,W,J,H,X].map(e=>e.code),parseStreamPart=e=>{let a=e.indexOf(":");if(-1===a)throw Error("Failed to parse stream string. No separator found.");let n=e.slice(0,a);if(!Y.includes(n))throw Error(`Failed to parse stream string. Invalid code ${n}.`);let s=e.slice(a+1),i=JSON.parse(s);return Q[n].parse(i)};function concatChunks(e,a){let n=new Uint8Array(a),s=0;for(let a of e)n.set(a,s),s+=a.length;return e.length=0,n}async function*readDataStream(e,{isAborted:a}={}){let n=new TextDecoder,s=[],i=0;for(;;){let{value:o}=await e.read();if(o&&(s.push(o),i+=o.length,10!==o[o.length-1]))continue;if(0===s.length)break;let l=concatChunks(s,i);i=0;let u=n.decode(l,{stream:!0}).split("\n").filter(e=>""!==e).map(parseStreamPart);for(let e of u)yield e;if(null==a?void 0:a()){e.cancel();break}}}var Z=(0,V.k)("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7);function createChunkDecoder(e){let a=new TextDecoder;return e?function(e){let n=a.decode(e,{stream:!0}).split("\n").filter(e=>""!==e);return n.map(parseStreamPart).filter(Boolean)}:function(e){return e?a.decode(e,{stream:!0}):""}}function assignAnnotationsToMessage(e,a){return e&&a&&a.length?{...e,annotations:[...a]}:e}async function parseComplexResponse({reader:e,abortControllerRef:a,update:n,onFinish:s,generateId:i=Z,getCurrentDate:o=()=>new Date}){let l;let u=o(),c={data:[]};for await(let{type:s,value:o}of readDataStream(e,{isAborted:()=>(null==a?void 0:a.current)===null})){"text"===s&&(c.text?c.text={...c.text,content:(c.text.content||"")+o}:c.text={id:i(),role:"assistant",content:o,createdAt:u});let e=null;"function_call"===s&&(c.function_call={id:i(),role:"assistant",content:"",function_call:o.function_call,name:o.function_call.name,createdAt:u},e=c.function_call);let a=null;"tool_calls"===s&&(c.tool_calls={id:i(),role:"assistant",content:"",tool_calls:o.tool_calls,createdAt:u},a=c.tool_calls),"data"===s&&c.data.push(...o);let p=c.text;if("message_annotations"===s&&(l?l.push(...o):l=[...o],e=assignAnnotationsToMessage(c.function_call,l),a=assignAnnotationsToMessage(c.tool_calls,l),p=assignAnnotationsToMessage(c.text,l)),null==l?void 0:l.length){let e=["text","function_call","tool_calls"];e.forEach(e=>{c[e]&&(c[e].annotations=[...l])})}let d=[e,a,p].filter(Boolean).map(e=>({...assignAnnotationsToMessage(e,l)}));n(d,[...c.data])}return null==s||s(c),{messages:[c.text,c.function_call,c.tool_calls].filter(Boolean),data:c.data}}async function callChatApi({api:e,messages:a,body:n,credentials:s,headers:i,abortController:o,appendMessage:l,restoreMessagesOnFailure:u,onResponse:c,onUpdate:p,onFinish:d,generateId:m}){var f;let g=await fetch(e,{method:"POST",body:JSON.stringify({messages:a,...n}),headers:{"Content-Type":"application/json",...i},signal:null==(f=null==o?void 0:o())?void 0:f.signal,credentials:s}).catch(e=>{throw u(),e});if(c)try{await c(g)}catch(e){throw e}if(!g.ok)throw u(),Error(await g.text()||"Failed to fetch the chat response.");if(!g.body)throw Error("The response body is empty.");let b=g.body.getReader(),y="true"===g.headers.get("X-Experimental-Stream-Data");if(y)return await parseComplexResponse({reader:b,abortControllerRef:null!=o?{current:o()}:void 0,update:p,onFinish(e){d&&null!=e.text&&d(e.text)},generateId:m});{let e=new Date,a=createChunkDecoder(!1),n="",s=m(),i={id:s,createdAt:e,content:"",role:"assistant"};for(;;){let{done:e,value:s}=await b.read();if(e)break;if((n+=a(s)).startsWith('{"function_call":')?i.function_call=n:n.startsWith('{"tool_calls":')?i.tool_calls=n:i.content=n,l({...i}),(null==o?void 0:o())===null){b.cancel();break}}if(n.startsWith('{"function_call":')){let e=JSON.parse(n).function_call;i.function_call=e,l({...i})}if(n.startsWith('{"tool_calls":')){let e=JSON.parse(n).tool_calls;i.tool_calls=e,l({...i})}return d&&d(i),i}}async function processChatStream({getStreamedResponse:e,experimental_onFunctionCall:a,experimental_onToolCall:n,updateChatRequest:s,getCurrentMessages:i}){for(;;){let o=await e();if("messages"in o){let e=!1;for(let l of o.messages)if(void 0!==l.function_call&&"string"!=typeof l.function_call||void 0!==l.tool_calls&&"string"!=typeof l.tool_calls){if(e=!0,a){let n=l.function_call;if("object"!=typeof n){console.warn("experimental_onFunctionCall should not be defined when using tools");continue}let o=await a(i(),n);if(void 0===o){e=!1;break}s(o)}if(n){let a=l.tool_calls;if(!Array.isArray(a)||a.some(e=>"object"!=typeof e)){console.warn("experimental_onToolCall should not be defined when using tools");continue}let o=await n(i(),a);if(void 0===o){e=!1;break}s(o)}}if(!e)break}else{let fixFunctionCallArguments2=function(e){for(let a of e.messages){if(void 0!==a.tool_calls)for(let e of a.tool_calls)"object"==typeof e&&e.function.arguments&&"string"!=typeof e.function.arguments&&(e.function.arguments=JSON.stringify(e.function.arguments));void 0!==a.function_call&&"object"==typeof a.function_call&&a.function_call.arguments&&"string"!=typeof a.function_call.arguments&&(a.function_call.arguments=JSON.stringify(a.function_call.arguments))}};if((void 0===o.function_call||"string"==typeof o.function_call)&&(void 0===o.tool_calls||"string"==typeof o.tool_calls))break;if(a){let e=o.function_call;if("object"!=typeof e){console.warn("experimental_onFunctionCall should not be defined when using tools");continue}let n=await a(i(),e);if(void 0===n)break;fixFunctionCallArguments2(n),s(n)}if(n){let e=o.tool_calls;if("object"!=typeof e){console.warn("experimental_onToolCall should not be defined when using functions");continue}let a=await n(i(),e);if(void 0===a)break;fixFunctionCallArguments2(a),s(a)}}}}var getStreamedResponse=async(e,a,n,s,i,o,l,u,c,p,d,m)=>{var f,g;let b=l.current;n(a.messages,!1);let y=m?a.messages:a.messages.map(({role:e,content:a,name:n,function_call:s,tool_calls:i,tool_call_id:o})=>({role:e,content:a,tool_call_id:o,...void 0!==n&&{name:n},...void 0!==s&&{function_call:s},...void 0!==i&&{tool_calls:i}}));if("string"!=typeof e){let s=c(),i=new Date,o={id:s,createdAt:i,content:"",role:"assistant"};async function readRow(e){let{content:s,ui:i,next:l}=await e;o.content=s,o.ui=await i,n([...a.messages,{...o}],!1),l&&await readRow(l)}try{let n=e({messages:y,data:a.data});await readRow(n)}catch(e){throw n(b,!1),e}return p&&p(o),o}return await callChatApi({api:e,messages:y,body:{data:a.data,...o.current.body,...null==(f=a.options)?void 0:f.body,...void 0!==a.functions&&{functions:a.functions},...void 0!==a.function_call&&{function_call:a.function_call},...void 0!==a.tools&&{tools:a.tools},...void 0!==a.tool_choice&&{tool_choice:a.tool_choice}},credentials:o.current.credentials,headers:{...o.current.headers,...null==(g=a.options)?void 0:g.headers},abortController:()=>u.current,appendMessage(e){n([...a.messages,e],!1)},restoreMessagesOnFailure(){n(b,!1)},onResponse:d,onUpdate(e,o){n([...a.messages,...e],!1),s([...i||[],...o||[]],!1)},onFinish:p,generateId:c})};function useChat({api:e="/api/chat",id:a,initialMessages:n,initialInput:s="",sendExtraMessageFields:o,experimental_onFunctionCall:l,experimental_onToolCall:u,onResponse:c,onFinish:p,onError:d,credentials:m,headers:f,body:g,generateId:b=Z}={}){let y=(0,i.useId)(),_=null!=a?a:y,w="string"==typeof e?[e,_]:_,[v]=(0,i.useState)([]),{data:P,mutate:A}=z([w,"messages"],null,{fallbackData:null!=n?n:v}),{data:S=!1,mutate:C}=z([w,"loading"],null),{data:O,mutate:E}=z([w,"streamData"],null),{data:x,mutate:I}=z([w,"error"],null),R=(0,i.useRef)(P||[]);(0,i.useEffect)(()=>{R.current=P||[]},[P]);let T=(0,i.useRef)(null),k=(0,i.useRef)({credentials:m,headers:f,body:g});(0,i.useEffect)(()=>{k.current={credentials:m,headers:f,body:g}},[m,f,g]);let j=(0,i.useCallback)(async a=>{try{C(!0),I(void 0);let n=new AbortController;T.current=n,await processChatStream({getStreamedResponse:()=>getStreamedResponse(e,a,A,E,O,k,R,T,b,p,c,o),experimental_onFunctionCall:l,experimental_onToolCall:u,updateChatRequest:e=>{a=e},getCurrentMessages:()=>R.current}),T.current=null}catch(e){if("AbortError"===e.name)return T.current=null,null;d&&e instanceof Error&&d(e),I(e)}finally{C(!1)}},[A,C,e,k,c,p,d,I,E,O,o,l,u,R,T,b]),F=(0,i.useCallback)(async(e,{options:a,functions:n,function_call:s,tools:i,tool_choice:o,data:l}={})=>{e.id||(e.id=b());let u={messages:R.current.concat(e),options:a,data:l,...void 0!==n&&{functions:n},...void 0!==s&&{function_call:s},...void 0!==i&&{tools:i},...void 0!==o&&{tool_choice:o}};return j(u)},[j,b]),M=(0,i.useCallback)(async({options:e,functions:a,function_call:n,tools:s,tool_choice:i}={})=>{if(0===R.current.length)return null;let o=R.current[R.current.length-1];if("assistant"===o.role){let o={messages:R.current.slice(0,-1),options:e,...void 0!==a&&{functions:a},...void 0!==n&&{function_call:n},...void 0!==s&&{tools:s},...void 0!==i&&{tool_choice:i}};return j(o)}let l={messages:R.current,options:e,...void 0!==a&&{functions:a},...void 0!==n&&{function_call:n},...void 0!==s&&{tools:s},...void 0!==i&&{tool_choice:i}};return j(l)},[j]),N=(0,i.useCallback)(()=>{T.current&&(T.current.abort(),T.current=null)},[]),L=(0,i.useCallback)(e=>{A(e,!1),R.current=e},[A]),[$,V]=(0,i.useState)(s),D=(0,i.useCallback)((e,a={},n)=>{n&&(k.current={...k.current,...n}),e.preventDefault(),$&&(F({content:$,role:"user",createdAt:new Date},a),V(""))},[$,F]);return{messages:P||[],error:x,append:F,reload:M,stop:N,setMessages:L,input:$,setInput:V,handleInputChange:e=>{V(e.target.value)},handleSubmit:D,isLoading:S,data:O}}},893:function(e,a,n){"use strict";n.d(a,{Ij:function(){return executor_AgentExecutor},Z:function(){return createOpenAIFunctionsAgent}});var s=n(3166);n(5465);var i=n(3711),o=n(1907);n(5198),n(7439);var l=n(3102),u=n(1974),c=n(7846),p=n(4563);let AgentExecutorIterator=class AgentExecutorIterator extends i.i{get finalOutputs(){return this._finalOutputs}async setFinalOutputs(e){if(this._finalOutputs=void 0,e){let a=await this.agentExecutor.prepOutputs(this.inputs,e,!0);this._finalOutputs=a}}get nameToToolMap(){let e=this.agentExecutor.tools.map(e=>({[e.name]:e}));return Object.assign({},...e)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","agents","executor_iterator"]}),Object.defineProperty(this,"agentExecutor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_finalOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"intermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"iterations",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.agentExecutor=e.agentExecutor,this.inputs=e.inputs,this.callbacks=e.callbacks,this.tags=e.tags,this.metadata=e.metadata,this.runName=e.runName,this.runManager=e.runManager,this.config=e.config}reset(){this.intermediateSteps=[],this.iterations=0,this._finalOutputs=void 0}updateIterations(){this.iterations+=1}async *streamIterator(){for(this.reset();;)try{0===this.iterations&&await this.onFirstStep();let e=await this._callNext();yield e}catch(e){if("message"in e&&e.message.startsWith("Final outputs already reached: ")){if(!this.finalOutputs)throw e;return this.finalOutputs}throw this.runManager&&await this.runManager.handleChainError(e),e}}async onFirstStep(){if(0===this.iterations){let e=await u.Ye.configure(this.callbacks,this.agentExecutor.callbacks,this.tags,this.agentExecutor.tags,this.metadata,this.agentExecutor.metadata,{verbose:this.agentExecutor.verbose});this.runManager=await e?.handleChainStart(this.agentExecutor.toJSON(),this.inputs,void 0,void 0,this.tags,this.metadata,this.runName)}}async _executeNextStep(e){return this.agentExecutor._takeNextStep(this.nameToToolMap,this.inputs,this.intermediateSteps,e,this.config)}async _processNextStepOutput(e,a){if("returnValues"in e){let n=await this.agentExecutor._return(e,this.intermediateSteps,a);return this.runManager&&await this.runManager.handleChainEnd(n),await this.setFinalOutputs(n),n}this.intermediateSteps=this.intermediateSteps.concat(e);let n={};if(Array.isArray(e)&&1===e.length){let s=e[0],i=await this.agentExecutor._getToolReturn(s);i&&(n=await this.agentExecutor._return(i,this.intermediateSteps,a),this.runManager&&await this.runManager.handleChainEnd(n),await this.setFinalOutputs(n))}return{intermediateSteps:e}}async _stop(){let e=await this.agentExecutor.agent.returnStoppedResponse(this.agentExecutor.earlyStoppingMethod,this.intermediateSteps,this.inputs),a=await this.agentExecutor._return(e,this.intermediateSteps,this.runManager);return await this.setFinalOutputs(a),a}async _callNext(){if(this.finalOutputs)throw Error(`Final outputs already reached: ${JSON.stringify(this.finalOutputs,null,2)}`);if(!this.agentExecutor.shouldContinueGetter(this.iterations))return this._stop();let e=await this._executeNextStep(this.runManager),a=await this._processNextStepOutput(e,this.runManager);return this.updateIterations(),a}};let ExceptionTool=class ExceptionTool extends o.UA{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"_Exception"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"Exception tool"})}async _call(e){return e}};let executor_AgentExecutor=class executor_AgentExecutor extends p.l{static lc_name(){return"AgentExecutor"}get lc_namespace(){return["langchain","agents","executor"]}get inputKeys(){return this.agent.inputKeys}get outputKeys(){return this.agent.returnValues}constructor(e){let a;let n=!0;if(l.eq.isRunnable(e.agent)?(a=s.fU.isAgentRunnableSequence(e.agent)?e.agent.singleAction?new s.Mj({runnable:e.agent,streamRunnable:e.agent.streamRunnable}):new s.zn({runnable:e.agent,streamRunnable:e.agent.streamRunnable}):new s.zn({runnable:e.agent}),n=!1):((0,s.Ck)(e.agent)&&(n=!1),a=e.agent),super(e),Object.defineProperty(this,"agent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tools",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:15}),Object.defineProperty(this,"earlyStoppingMethod",{enumerable:!0,configurable:!0,writable:!0,value:"force"}),Object.defineProperty(this,"returnOnlyOutputs",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"handleParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.agent=a,this.tools=e.tools,this.handleParsingErrors=e.handleParsingErrors??this.handleParsingErrors,this.returnOnlyOutputs=n,"multi"===this.agent._agentActionType()){for(let e of this.tools)if(e.returnDirect)throw Error(`Tool with return direct ${e.name} not supported for multi-action agent.`)}this.returnIntermediateSteps=e.returnIntermediateSteps??this.returnIntermediateSteps,this.maxIterations=e.maxIterations??this.maxIterations,this.earlyStoppingMethod=e.earlyStoppingMethod??this.earlyStoppingMethod}static fromAgentAndTools(e){return new executor_AgentExecutor(e)}get shouldContinueGetter(){return this.shouldContinue.bind(this)}shouldContinue(e){return void 0===this.maxIterations||e<this.maxIterations}async _call(e,a,n){let s=Object.fromEntries(this.tools.map(e=>[e.name.toLowerCase(),e])),i=[],u=0,getOutput=async n=>{let s;let{returnValues:o}=n,l=await this.agent.prepareForOutput(o,i);return await a?.handleAgentEnd(n),s=this.returnIntermediateSteps?{...o,intermediateSteps:i,...l}:{...o,...l},this.returnOnlyOutputs||(s={...e,...s}),s};for(;this.shouldContinue(u);){let p,d;try{p=await this.agent.plan(i,e,a?.getChild(),n)}catch(e){if(e instanceof c.dS){let a;let n=e.message;if(!0===this.handleParsingErrors)e.sendToLLM?(a=e.observation,n=e.llmOutput??""):a="Invalid or incomplete response";else if("string"==typeof this.handleParsingErrors)a=this.handleParsingErrors;else if("function"==typeof this.handleParsingErrors)a=this.handleParsingErrors(e);else throw e;p={tool:"_Exception",toolInput:a,log:n}}else throw e}if("returnValues"in p)return getOutput(p);d=Array.isArray(p)?p:[p];let m=await Promise.all(d.map(async e=>{let i;await a?.handleAgentAction(e);let u="_Exception"===e.tool?new ExceptionTool:s[e.tool?.toLowerCase()];try{i=u?await u.invoke(e.toolInput,(0,l.q)(n,{callbacks:a?.getChild()})):`${e.tool} is not a valid tool, try another one.`}catch(e){if(e instanceof o.YE){if(!0===this.handleParsingErrors)i="Invalid or incomplete tool input. Please try again.";else if("string"==typeof this.handleParsingErrors)i=this.handleParsingErrors;else if("function"==typeof this.handleParsingErrors)i=this.handleParsingErrors(e);else throw e;i=await new ExceptionTool().call(i,a?.getChild())}}return{action:e,observation:i??""}}));i.push(...m);let f=i[i.length-1],g=s[f.action.tool?.toLowerCase()];if(g?.returnDirect)return getOutput({returnValues:{[this.agent.returnValues[0]]:f.observation},log:""});u+=1}let p=await this.agent.returnStoppedResponse(this.earlyStoppingMethod,i,e);return getOutput(p)}async _takeNextStep(e,a,n,s,i){let l,u;try{l=await this.agent.plan(n,a,s?.getChild(),i)}catch(e){if(e instanceof c.dS){let a;let n=e.message;if(!0===this.handleParsingErrors)e.sendToLLM?(a=e.observation,n=e.llmOutput??""):a="Invalid or incomplete response";else if("string"==typeof this.handleParsingErrors)a=this.handleParsingErrors;else if("function"==typeof this.handleParsingErrors)a=this.handleParsingErrors(e);else throw e;l={tool:"_Exception",toolInput:a,log:n}}else throw e}if("returnValues"in l)return l;u=Array.isArray(l)?l:[l];let p=[];for(let a of u){let n="";if(s&&await s?.handleAgentAction(a),a.tool in e){let i=e[a.tool];try{n=await i.call(a.toolInput,s?.getChild())}catch(e){if(e instanceof o.YE){if(!0===this.handleParsingErrors)n="Invalid or incomplete tool input. Please try again.";else if("string"==typeof this.handleParsingErrors)n=this.handleParsingErrors;else if("function"==typeof this.handleParsingErrors)n=this.handleParsingErrors(e);else throw e;n=await new ExceptionTool().call(n,s?.getChild())}}}else n=`${a.tool} is not a valid tool, try another available tool: ${Object.keys(e).join(", ")}`;p.push({action:a,observation:n})}return p}async _return(e,a,n){n&&await n.handleAgentEnd(e);let s=e.returnValues;return this.returnIntermediateSteps&&(s.intermediateSteps=a),s}async _getToolReturn(e){let{action:a,observation:n}=e,s=Object.fromEntries(this.tools.map(e=>[e.name.toLowerCase(),e])),[i="output"]=this.agent.returnValues;return a.tool in s&&s[a.tool].returnDirect?{returnValues:{[i]:n},log:""}:null}_returnStoppedResponse(e){if("force"===e)return{returnValues:{output:"Agent stopped due to iteration limit or time limit."},log:""};throw Error(`Got unsupported early_stopping_method: ${e}`)}async *_streamIterator(e,a){let n=new AgentExecutorIterator({inputs:e,agentExecutor:this,config:a,metadata:a?.metadata,tags:a?.tags,callbacks:a?.callbacks}),s=n.streamIterator();for await(let e of s)e&&(yield e)}_chainType(){return"agent_executor"}serialize(){throw Error("Cannot serialize an AgentExecutor")}};n(3703),n(6827),n(3830),n(2488);var d=n(6261);n(8498),n(3478);var m=n(2854);n(9711);var f=n(6896);let output_parser_OpenAIFunctionsAgentOutputParser=class output_parser_OpenAIFunctionsAgentOutputParser extends m.h{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","agents","openai"]})}static lc_name(){return"OpenAIFunctionsAgentOutputParser"}async parse(e){throw Error(`OpenAIFunctionsAgentOutputParser can only parse messages.
Passed input: ${e}`)}async parseResult(e){if("message"in e[0]&&(0,d.QW)(e[0].message))return this.parseAIMessage(e[0].message);throw Error("parseResult on OpenAIFunctionsAgentOutputParser only works on ChatGeneration output")}parseAIMessage(e){if(e.content&&"string"!=typeof e.content)throw Error("This agent cannot parse non-string model responses.");if(!e.additional_kwargs.function_call)return{returnValues:{output:e.content},log:e.content};{let a=e.additional_kwargs.function_call;try{let n=a.arguments?JSON.parse(a.arguments):{};return{tool:a.name,toolInput:n,log:`Invoking "${a.name}" with ${a.arguments??"{}"}
${e.content}`,messageLog:[e]}}catch(e){throw new c.dS(`Failed to parse function arguments from chat model response. Text: "${a.arguments}". ${e}`)}}}getFormatInstructions(){throw Error("getFormatInstructions not implemented inside OpenAIFunctionsAgentOutputParser.")}};function formatToOpenAIFunctionMessages(e){return e.flatMap(({action:e,observation:a})=>{if(!("messageLog"in e)||void 0===e.messageLog)return[new d.gY(e.log)];{let n=e.messageLog;return n.concat(new d.TN(a,e.tool))}})}async function createOpenAIFunctionsAgent({llm:e,tools:a,prompt:n,streamRunnable:i}){if(!n.inputVariables.includes("agent_scratchpad"))throw Error(`Prompt must have an input variable named "agent_scratchpad".
Found ${JSON.stringify(n.inputVariables)} instead.`);let o=e.bind({functions:a.map(f.sU)}),u=s.fU.fromRunnables([l.sk.assign({agent_scratchpad:e=>formatToOpenAIFunctionMessages(e.steps)}),n,o,new output_parser_OpenAIFunctionsAgentOutputParser],{name:"OpenAIFunctionsAgent",streamRunnable:i,singleAction:!0});return u}n(2384)},3166:function(e,a,n){"use strict";n.d(a,{Ck:function(){return isRunnableAgent},Mj:function(){return RunnableSingleActionAgent},Py:function(){return Agent},fU:function(){return AgentRunnableSequence},zn:function(){return RunnableMultiActionAgent}});var s=n(3711),i=n(3102);let ParseError=class ParseError extends Error{constructor(e,a){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=a}};let BaseAgent=class BaseAgent extends s.i{get returnValues(){return["output"]}get allowedTools(){}_agentType(){throw Error("Not implemented")}returnStoppedResponse(e,a,n,s){if("force"===e)return Promise.resolve({returnValues:{output:"Agent stopped due to max iterations."},log:""});throw Error(`Invalid stopping method: ${e}`)}async prepareForOutput(e,a){return{}}};let BaseSingleActionAgent=class BaseSingleActionAgent extends BaseAgent{_agentActionType(){return"single"}};let BaseMultiActionAgent=class BaseMultiActionAgent extends BaseAgent{_agentActionType(){return"multi"}};function isAgentAction(e){return!Array.isArray(e)&&e?.tool!==void 0}function isRunnableAgent(e){return void 0!==e.runnable}let AgentRunnableSequence=class AgentRunnableSequence extends i.lW{constructor(){super(...arguments),Object.defineProperty(this,"streamRunnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"singleAction",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}static fromRunnables([e,...a],n){let s=i.lW.from([e,...a],n.name);return s.singleAction=n.singleAction,s.streamRunnable=n.streamRunnable,s}static isAgentRunnableSequence(e){return"boolean"==typeof e.singleAction}};let RunnableSingleActionAgent=class RunnableSingleActionAgent extends BaseSingleActionAgent{get inputKeys(){return[]}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","agents","runnable"]}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamRunnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"defaultRunName",{enumerable:!0,configurable:!0,writable:!0,value:"RunnableAgent"}),this.runnable=e.runnable,this.defaultRunName=e.defaultRunName??this.runnable.name??this.defaultRunName,this.streamRunnable=e.streamRunnable??this.streamRunnable}async plan(e,a,n,s){let o={...a,steps:e},l=(0,i.q)(s,{callbacks:n,runName:this.defaultRunName});if(!this.streamRunnable)return this.runnable.invoke(o,l);{let e;let a=await this.runnable.stream(o,l);for await(let n of a)if(void 0===e)e=n;else throw Error('Multiple agent actions/finishes received in streamed agent output.\nSet "streamRunnable: false" when initializing the agent to invoke this agent in non-streaming mode.');if(void 0===e)throw Error('No streaming output received from underlying runnable.\nSet "streamRunnable: false" when initializing the agent to invoke this agent in non-streaming mode.');return e}}};let RunnableMultiActionAgent=class RunnableMultiActionAgent extends BaseMultiActionAgent{get inputKeys(){return[]}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","agents","runnable"]}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultRunName",{enumerable:!0,configurable:!0,writable:!0,value:"RunnableAgent"}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamRunnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.runnable=e.runnable,this.stop=e.stop,this.defaultRunName=e.defaultRunName??this.runnable.name??this.defaultRunName,this.streamRunnable=e.streamRunnable??this.streamRunnable}async plan(e,a,n,s){let o;let l={...a,steps:e},u=(0,i.q)(s,{callbacks:n,runName:this.defaultRunName});if(this.streamRunnable){let e;let a=await this.runnable.stream(l,u);for await(let n of a)if(void 0===e)e=n;else throw Error('Multiple agent actions/finishes received in streamed agent output.\nSet "streamRunnable: false" when initializing the agent to invoke this agent in non-streaming mode.');if(void 0===e)throw Error('No streaming output received from underlying runnable.\nSet "streamRunnable: false" when initializing the agent to invoke this agent in non-streaming mode.');o=e}else o=await this.runnable.invoke(l,u);return isAgentAction(o)?[o]:o}};let Agent=class Agent extends BaseSingleActionAgent{get allowedTools(){return this._allowedTools}get inputKeys(){return this.llmChain.inputKeys.filter(e=>"agent_scratchpad"!==e)}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_allowedTools",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this._allowedTools=e.allowedTools,this.outputParser=e.outputParser}static getDefaultOutputParser(e){throw Error("Not implemented")}static createPrompt(e,a){throw Error("Not implemented")}static fromLLMAndTools(e,a,n){throw Error("Not implemented")}static validateTools(e){}_stop(){return[`
${this.observationPrefix()}`]}finishToolName(){return"Final Answer"}async constructScratchPad(e){return e.reduce((e,{action:a,observation:n})=>e+[a.log,`${this.observationPrefix()}${n}`,this.llmPrefix()].join("\n"),"")}async _plan(e,a,n,s){let i=await this.constructScratchPad(e),o={...a,agent_scratchpad:n?`${i}${n}`:i};0!==this._stop().length&&(o.stop=this._stop());let l=await this.llmChain.predict(o,s);if(!this.outputParser)throw Error("Output parser not set");return this.outputParser.parse(l,s)}plan(e,a,n){return this._plan(e,a,void 0,n)}async returnStoppedResponse(e,a,n,s){if("force"===e)return{returnValues:{output:"Agent stopped due to max iterations."},log:""};if("generate"===e)try{let e=await this._plan(a,n,"\n\nI now need to return a final answer based on the previous steps:",s);if("returnValues"in e)return e;return{returnValues:{output:e.log},log:e.log}}catch(e){if(!(e instanceof ParseError))throw e;return{returnValues:{output:e.output},log:e.output}}throw Error(`Invalid stopping method: ${e}`)}static async deserialize(e){if("zero-shot-react-description"===e._type){let{ZeroShotAgent:a}=await Promise.resolve().then(n.bind(n,7439));return a.deserialize(e)}throw Error("Unknown agent type")}}},7439:function(e,a,n){"use strict";n.d(a,{ZeroShotAgent:function(){return ZeroShotAgent}});var s=n(6827),i=n(5198),o=n(3166);let deserializeHelper=async(e,a,n,s,o)=>{if(n.load_from_llm_and_tools){if(!e)throw Error("Loading from llm and tools, llm must be provided.");if(!a)throw Error("Loading from llm and tools, tools must be provided.");return s(e,a,n)}if(!n.llm_chain)throw Error("Loading from constructor, llm_chain must be provided.");let l=await i.LLMChain.deserialize(n.llm_chain);return o({...n,llmChain:l})};var l=n(2384),u=n(2504);let ZeroShotAgent=class ZeroShotAgent extends o.Py{static lc_name(){return"ZeroShotAgent"}constructor(e){let a=e?.outputParser??ZeroShotAgent.getDefaultOutputParser();super({...e,outputParser:a}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","agents","mrkl"]})}_agentType(){return"zero-shot-react-description"}observationPrefix(){return"Observation: "}llmPrefix(){return"Thought:"}static getDefaultOutputParser(e){return new l.S(e)}static validateTools(e){let a=e.find(e=>!e.description);if(a){let e=`Got a tool ${a.name} without a description. This agent requires descriptions for all tools.`;throw Error(e)}}static createPrompt(e,a){let{prefix:n=u.Bq,suffix:i=u.NS,inputVariables:o=["input","agent_scratchpad"]}=a??{},l=e.map(e=>`${e.name}: ${e.description}`).join("\n"),c=e.map(e=>e.name),p=(0,s.SM)(u.cQ,"f-string",{tool_names:c}),d=[n,l,p,i].join("\n\n");return new s.Pf({template:d,inputVariables:o})}static fromLLMAndTools(e,a,n){ZeroShotAgent.validateTools(a);let s=ZeroShotAgent.createPrompt(a,n),o=n?.outputParser??ZeroShotAgent.getDefaultOutputParser(),l=new i.LLMChain({prompt:s,llm:e,callbacks:n?.callbacks??n?.callbackManager});return new ZeroShotAgent({llmChain:l,allowedTools:a.map(e=>e.name),outputParser:o})}static async deserialize(e){let{llm:a,tools:n,...s}=e;return deserializeHelper(a,n,s,(e,a,n)=>ZeroShotAgent.fromLLMAndTools(e,a,{prefix:n.prefix,suffix:n.suffix,inputVariables:n.input_variables}),e=>new ZeroShotAgent(e))}}},2384:function(e,a,n){"use strict";n.d(a,{S:function(){return ZeroShotAgentOutputParser}});var s=n(7846),i=n(2854),o=n(2504);let ZeroShotAgentOutputParser=class ZeroShotAgentOutputParser extends i.h{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","agents","mrkl"]}),Object.defineProperty(this,"finishToolName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.finishToolName=e?.finishToolName||"Final Answer:"}async parse(e){if(e.includes(this.finishToolName)){let a=e.split(this.finishToolName),n=a[a.length-1].trim();return{returnValues:{output:n},log:e}}let a=/Action:([\s\S]*?)(?:\nAction Input:([\s\S]*?))?$/.exec(e);if(!a)throw new s.dS(`Could not parse LLM output: ${e}`);return{tool:a[1].trim(),toolInput:a[2]?a[2].trim().replace(/^("+)(.*?)(\1)$/,"$2"):"",log:e}}getFormatInstructions(){return o.cQ}}},2504:function(e,a,n){"use strict";n.d(a,{Bq:function(){return s},NS:function(){return o},cQ:function(){return i}});let s="Answer the following questions as best you can. You have access to the following tools:",i=`Use the following format in your response:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [{tool_names}]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question`,o=`Begin!

Question: {input}
Thought:{agent_scratchpad}`},2854:function(e,a,n){"use strict";n.d(a,{h:function(){return AgentActionOutputParser}});var s=n(7846);let AgentActionOutputParser=class AgentActionOutputParser extends s.bI{}},4563:function(e,a,n){"use strict";n.d(a,{l:function(){return BaseChain}});var s=n(8398),i=n(1974),o=n(3102),l=n(8463);let BaseChain=class BaseChain extends l.BD{get lc_namespace(){return["langchain","chains",this._chainType()]}constructor(e,a,n){if(1!=arguments.length||"object"!=typeof e||"saveContext"in e)super({verbose:a,callbacks:n}),this.memory=e;else{let{memory:a,callbackManager:n,...s}=e;super({...s,callbacks:n??s.callbacks}),this.memory=a}}_selectMemoryInputs(e){let a={...e};return"signal"in a&&delete a.signal,"timeout"in a&&delete a.timeout,a}async invoke(e,a){let n;let l=(0,o.LE)(a),u=await this._formatValues(e),c=await i.Ye.configure(l?.callbacks,this.callbacks,l?.tags,this.tags,l?.metadata,this.metadata,{verbose:this.verbose}),p=await c?.handleChainStart(this.toJSON(),u,void 0,void 0,void 0,void 0,l?.runName);try{n=await (u.signal?Promise.race([this._call(u,p,l),new Promise((e,a)=>{u.signal?.addEventListener("abort",()=>{a(Error("AbortError"))})})]):this._call(u,p,l))}catch(e){throw await p?.handleChainError(e),e}return null!=this.memory&&await this.memory.saveContext(this._selectMemoryInputs(e),n),await p?.handleChainEnd(n),Object.defineProperty(n,s.WH,{value:p?{runId:p?.runId}:void 0,configurable:!0}),n}_validateOutputs(e){let a=this.outputKeys.filter(a=>!(a in e));if(a.length)throw Error(`Missing output keys: ${a.join(", ")} from chain ${this._chainType()}`)}async prepOutputs(e,a,n=!1){return(this._validateOutputs(a),this.memory&&await this.memory.saveContext(e,a),n)?a:{...e,...a}}serialize(){throw Error("Method not implemented.")}async run(e,a){let n=this.inputKeys.filter(e=>!this.memory?.memoryKeys.includes(e)??!0),s=n.length<=1;if(!s)throw Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let i=n.length?{[n[0]]:e}:{},o=await this.call(i,a),l=Object.keys(o);if(1===l.length)return o[l[0]];throw Error("return values have multiple keys, `run` only supported when one key currently")}async _formatValues(e){let a={...e};if(a.timeout&&!a.signal&&(a.signal=AbortSignal.timeout(a.timeout),delete a.timeout),null!=this.memory){let n=await this.memory.loadMemoryVariables(this._selectMemoryInputs(e));for(let[e,s]of Object.entries(n))a[e]=s}return a}async call(e,a,n){let s={tags:n,...(0,i.QH)(a)};return this.invoke(e,s)}async apply(e,a){return Promise.all(e.map(async(e,n)=>this.call(e,a?.[n])))}static async deserialize(e,a={}){switch(e._type){case"llm_chain":{let{LLMChain:a}=await Promise.resolve().then(n.bind(n,5198));return a.deserialize(e)}case"sequential_chain":{let{SequentialChain:a}=await n.e(451).then(n.bind(n,7451));return a.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:a}=await n.e(451).then(n.bind(n,7451));return a.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:a}=await Promise.resolve().then(n.bind(n,5621));return a.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:a}=await Promise.resolve().then(n.bind(n,5621));return a.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:a}=await Promise.resolve().then(n.bind(n,5621));return a.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:s}=await Promise.resolve().then(n.bind(n,3703));return s.deserialize(e,a)}case"api_chain":{let{APIChain:a}=await n.e(831).then(n.bind(n,5831));return a.deserialize(e)}default:throw Error(`Invalid prompt type in config: ${e._type}`)}}}},5621:function(e,a,n){"use strict";n.d(a,{MapReduceDocumentsChain:function(){return MapReduceDocumentsChain},RefineDocumentsChain:function(){return RefineDocumentsChain},StuffDocumentsChain:function(){return StuffDocumentsChain}});var s=n(6827),i=n(4563),o=n(5198);let StuffDocumentsChain=class StuffDocumentsChain extends i.l{static lc_name(){return"StuffDocumentsChain"}get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys].filter(e=>e!==this.documentVariableName)}get outputKeys(){return this.llmChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey}_prepInputs(e){if(!(this.inputKey in e))throw Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:a,...n}=e,s=a.map(({pageContent:e})=>e),i=s.join("\n\n");return{...n,[this.documentVariableName]:i}}async _call(e,a){let n=await this.llmChain.call(this._prepInputs(e),a?.getChild("combine_documents"));return n}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw Error("Missing llm_chain");return new StuffDocumentsChain({llmChain:await o.LLMChain.deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}};let MapReduceDocumentsChain=class MapReduceDocumentsChain extends i.l{static lc_name(){return"MapReduceDocumentsChain"}get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.ensureMapStep=e.ensureMapStep??this.ensureMapStep,this.inputKey=e.inputKey??this.inputKey,this.maxTokens=e.maxTokens??this.maxTokens,this.maxIterations=e.maxIterations??this.maxIterations,this.returnIntermediateSteps=e.returnIntermediateSteps??!1}async _call(e,a){if(!(this.inputKey in e))throw Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:n,...s}=e,i=n,o=[];for(let e=0;e<this.maxIterations;e+=1){let n=i.map(e=>({[this.documentVariableName]:e.pageContent,...s})),l=0!==e||!this.ensureMapStep;if(l){let e=await this.combineDocumentChain.llmChain.prompt.format(this.combineDocumentChain._prepInputs({[this.combineDocumentChain.inputKey]:i,...s})),a=await this.combineDocumentChain.llmChain._getNumTokens(e),n=a<this.maxTokens;if(n)break}let u=await this.llmChain.apply(n,a?Array.from({length:n.length},(e,n)=>a.getChild(`map_${n+1}`)):void 0),{outputKey:c}=this.llmChain;this.returnIntermediateSteps&&(o=o.concat(u.map(e=>e[c]))),i=u.map(e=>({pageContent:e[c],metadata:{}}))}let l={[this.combineDocumentChain.inputKey]:i,...s},u=await this.combineDocumentChain.call(l,a?.getChild("combine_documents"));return this.returnIntermediateSteps?{...u,intermediateSteps:o}:u}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw Error("Missing llm_chain");if(!e.combine_document_chain)throw Error("Missing combine_document_chain");return new MapReduceDocumentsChain({llmChain:await o.LLMChain.deserialize(e.llm_chain),combineDocumentChain:await StuffDocumentsChain.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}};let RefineDocumentsChain=class RefineDocumentsChain extends i.l{static lc_name(){return"RefineDocumentsChain"}get defaultDocumentPrompt(){return new s.Pf({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[...new Set([this.inputKey,...this.llmChain.inputKeys,...this.refineLLMChain.inputKeys])].filter(e=>e!==this.documentVariableName&&e!==this.initialResponseName)}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.documentPrompt=e.documentPrompt??this.documentPrompt,this.initialResponseName=e.initialResponseName??this.initialResponseName}async _constructInitialInputs(e,a){let n={page_content:e.pageContent,...e.metadata},s={};this.documentPrompt.inputVariables.forEach(e=>{s[e]=n[e]});let i={[this.documentVariableName]:await this.documentPrompt.format({...s})},o={...i,...a};return o}async _constructRefineInputs(e,a){let n={page_content:e.pageContent,...e.metadata},s={};this.documentPrompt.inputVariables.forEach(e=>{s[e]=n[e]});let i={[this.documentVariableName]:await this.documentPrompt.format({...s})},o={[this.initialResponseName]:a,...i};return o}async _call(e,a){if(!(this.inputKey in e))throw Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:n,...s}=e,i=await this._constructInitialInputs(n[0],s),o=await this.llmChain.predict({...i},a?.getChild("answer")),l=[o];for(let e=1;e<n.length;e+=1){let i=await this._constructRefineInputs(n[e],o),u={...i,...s};o=await this.refineLLMChain.predict({...u},a?.getChild("refine")),l.push(o)}return{[this.outputKey]:o}}_chainType(){return"refine_documents_chain"}static async deserialize(e){let a=e.llm_chain;if(!a)throw Error("Missing llm_chain");let n=e.refine_llm_chain;if(!n)throw Error("Missing refine_llm_chain");return new RefineDocumentsChain({llmChain:await o.LLMChain.deserialize(a),refineLLMChain:await o.LLMChain.deserialize(n)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}}},5198:function(e,a,n){"use strict";n.d(a,{LLMChain:function(){return LLMChain}});var s=n(8463),i=n(6827),o=n(3102),l=n(4563),u=n(7846);let NoOpOutputParser=class NoOpOutputParser extends u.bI{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","default"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"NoOpOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}};function isBaseLanguageModel(e){return"function"==typeof e._llmType}function _getLanguageModel(e){if(isBaseLanguageModel(e))return e;if("bound"in e&&o.eq.isRunnable(e.bound))return _getLanguageModel(e.bound);if("runnable"in e&&"fallbacks"in e&&o.eq.isRunnable(e.runnable))return _getLanguageModel(e.runnable);if("default"in e&&o.eq.isRunnable(e.default))return _getLanguageModel(e.default);throw Error("Unable to extract BaseLanguageModel from llmLike object.")}let LLMChain=class LLMChain extends l.l{static lc_name(){return"LLMChain"}get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llmKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.llmKwargs=e.llmKwargs,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??new NoOpOutputParser,this.prompt.outputParser){if(e.outputParser)throw Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}getCallKeys(){let e="callKeys"in this.llm?this.llm.callKeys:[];return e}_selectMemoryInputs(e){let a=super._selectMemoryInputs(e),n=this.getCallKeys();for(let s of n)s in e&&delete a[s];return a}async _getFinalOutput(e,a,n){return this.outputParser?await this.outputParser.parseResultWithPrompt(e,a,n?.getChild()):e[0].text}call(e,a){return super.call(e,a)}async _call(e,a){let n={...e},s={...this.llmKwargs},i=this.getCallKeys();for(let a of i)a in e&&s&&(s[a]=e[a],delete n[a]);let o=await this.prompt.formatPromptValue(n);if("generatePrompt"in this.llm){let{generations:e}=await this.llm.generatePrompt([o],s,a?.getChild());return{[this.outputKey]:await this._getFinalOutput(e[0],o,a)}}let l=this.outputParser?this.llm.pipe(this.outputParser):this.llm,u=await l.invoke(o,a?.getChild());return{[this.outputKey]:u}}async predict(e,a){let n=await this.call(e,a);return n[this.outputKey]}_chainType(){return"llm"}static async deserialize(e){let{llm:a,prompt:n}=e;if(!a)throw Error("LLMChain must have llm");if(!n)throw Error("LLMChain must have prompt");return new LLMChain({llm:await s.qV.deserialize(a),prompt:await i.dy.deserialize(n)})}serialize(){let e="serialize"in this.llm?this.llm.serialize():void 0;return{_type:`${this._chainType()}_chain`,llm:e,prompt:this.prompt.serialize()}}_getNumTokens(e){return _getLanguageModel(this.llm).getNumTokens(e)}}},3703:function(e,a,n){"use strict";n.d(a,{VectorDBQAChain:function(){return VectorDBQAChain}});var s=n(4563),i=n(5198),o=n(5621),l=n(6827);n(8498);let BasePromptSelector=class BasePromptSelector{async getPromptAsync(e,a){let n=this.getPrompt(e);return n.partial(a?.partialVariables??{})}};let ConditionalPromptSelector=class ConditionalPromptSelector extends BasePromptSelector{constructor(e,a=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=a}getPrompt(e){for(let[a,n]of this.conditionals)if(a(e))return n;return this.defaultPrompt}};function isChatModel(e){return"base_chat_model"===e._modelType()}let u=new l.Pf({template:"Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.\n\n{context}\n\nQuestion: {question}\nHelpful Answer:",inputVariables:["context","question"]}),c=`Use the following pieces of context to answer the users question. 
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}`,p=[l.ov.fromTemplate(c),l.kq.fromTemplate("{question}")],d=l.ks.fromMessages(p),m=new ConditionalPromptSelector(u,[[isChatModel,d]]);function loadQAStuffChain(e,a={}){let{prompt:n=m.getPrompt(e),verbose:s}=a,l=new i.LLMChain({prompt:n,llm:e,verbose:s}),u=new o.StuffDocumentsChain({llmChain:l,verbose:s});return u}let VectorDBQAChain=class VectorDBQAChain extends s.l{static lc_name(){return"VectorDBQAChain"}get inputKeys(){return[this.inputKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){super(e),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"vectorstore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.vectorstore=e.vectorstore,this.combineDocumentsChain=e.combineDocumentsChain,this.inputKey=e.inputKey??this.inputKey,this.k=e.k??this.k,this.returnSourceDocuments=e.returnSourceDocuments??this.returnSourceDocuments}async _call(e,a){if(!(this.inputKey in e))throw Error(`Question key ${this.inputKey} not found.`);let n=e[this.inputKey],s=await this.vectorstore.similaritySearch(n,this.k,e.filter,a?.getChild("vectorstore")),i=await this.combineDocumentsChain.call({question:n,input_documents:s},a?.getChild("combine_documents"));return this.returnSourceDocuments?{...i,sourceDocuments:s}:i}_chainType(){return"vector_db_qa"}static async deserialize(e,a){if(!("vectorstore"in a))throw Error("Need to pass in a vectorstore to deserialize VectorDBQAChain");let{vectorstore:n}=a;if(!e.combine_documents_chain)throw Error("VectorDBQAChain must have combine_documents_chain in serialized data");return new VectorDBQAChain({combineDocumentsChain:await s.l.deserialize(e.combine_documents_chain),k:e.k,vectorstore:n})}serialize(){return{_type:this._chainType(),combine_documents_chain:this.combineDocumentsChain.serialize(),k:this.k}}static fromLLM(e,a,n){let s=loadQAStuffChain(e);return new this({vectorstore:a,combineDocumentsChain:s,...n})}}},8249:function(e,a,n){"use strict";n.d(a,{k:function(){return customAlphabet}});let customAlphabet=(e,a=21)=>(n=a)=>{let s="",i=n;for(;i--;)s+=e[Math.random()*e.length|0];return s}}}]);